<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Ø¨ÙˆØ§Ø¨Ø© ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø± â€“ Smart Clinic</title>
<link rel="stylesheet" href="../../assets/css/variables.css">
<link rel="stylesheet" href="../../assets/css/layout.css">
<link rel="stylesheet" href="../../assets/css/cards.css">
<link rel="stylesheet" href="../../assets/css/tables.css">
<style>
.portal-meta {
  display: flex;
  gap: var(--sc-space-2);
  flex-wrap: wrap;
  margin-bottom: var(--sc-space-3);
}

.parent-status-line {
  display: flex;
  align-items: center;
  gap: var(--sc-space-2);
  margin-bottom: var(--sc-space-3);
}

.toast {
  position: fixed;
  left: 16px;
  bottom: 16px;
  background: var(--sc-surface-strong);
  color: var(--sc-text);
  border: 1px solid var(--sc-border);
  border-radius: var(--sc-radius-md);
  padding: 10px 12px;
  font-size: 12px;
  display: none;
  z-index: 40;
}
</style>
</head>
<body class="sc-page">
<div class="sc-shell">
  <header class="sc-page-header">
    <div class="sc-page-header-main">
      <div class="sc-page-icon">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§</div>
      <div>
        <h1 class="sc-page-title">Ø¨ÙˆØ§Ø¨Ø© ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±</h1>
        <p class="sc-page-subtitle">Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„ØµØ­ÙŠØ© Ù„Ù„Ø·Ø§Ù„Ø¨ØŒ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§ØªØŒ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±ØŒ ÙˆØ§Ù„ØªÙˆØ§ØµÙ„ Ø§Ù„Ù…Ø¨Ø§Ø´Ø± Ù…Ù† ÙˆØ§Ø¬Ù‡Ø© Ù…ÙˆØ­Ù‘Ø¯Ø©.</p>
      </div>
    </div>
    <div class="sc-header-actions">
      <span class="sc-role-chip">Ø§Ù„Ø¯ÙˆØ± Ø§Ù„Ø­Ø§Ù„ÙŠ: <strong data-session-role>ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±</strong></span>
      <button class="sc-action-btn" data-action="logout">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
    </div>
  </header>

  <section class="sc-panel sc-mb-24">
    <h2 class="sc-panel-title">Ù…Ù„Ø®Øµ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ù„Ø­Ø¸ÙŠ</h2>
    <div class="portal-meta">
      <div class="meta-item">Ø§Ù„Ù†Ù…Ø·: <strong id="status-mode">-</strong></div>
      <div class="meta-item">Ø¢Ø®Ø± Ù…Ø²Ø§Ù…Ù†Ø©: <strong id="status-sync">-</strong></div>
      <div class="meta-item">Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø®Ø·Ø±: <strong id="status-risk">-</strong></div>
    </div>
    <div class="parent-status-line">
      <span class="sc-muted">Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ø§Ù„Ø¨ Ø§Ù„Ø­Ø§Ù„ÙŠØ©:</span>
      <span id="student-current-status" class="sc-badge sc-severity-low">Ù…Ø³ØªÙ‚Ø±Ø©</span>
    </div>
    <div class="sc-section-nav">
      <button class="sc-action-btn" onclick="scrollParentSection('parent-care')">Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø·Ø§Ù„Ø¨</button>
      <button class="sc-action-btn" onclick="scrollParentSection('parent-comm')">Ø§Ù„ØªÙˆØ§ØµÙ„ ÙˆØ§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª</button>
      <button class="sc-action-btn" onclick="scrollParentSection('parent-reports')">Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</button>
    </div>
  </section>

  <section id="stats" class="sc-grid-3 sc-kpi-grid sc-mb-24"></section>

  <h2 id="parent-care" class="sc-section-title">Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø·Ø§Ù„Ø¨</h2>
  <section class="sc-grid-3 sc-mb-24">
    <article class="sc-panel" data-permission="view.student">
      <h3 class="sc-panel-title">Ø§Ù„Ù…Ù„Ù Ø§Ù„ØµØ­ÙŠ Ù„Ù„Ø·Ø§Ù„Ø¨</h3>
      <p id="latest-case" class="sc-panel-subtitle">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø£Ø­Ø¯Ø« Ø­Ø§Ù„Ø©...</p>
      <span id="latest-case-badge" class="badge b-ok">Ù…Ø³ØªÙ‚Ø±Ø©</span>
      <div class="inline-row" style="margin-top:12px;">
        <button class="btn-primary" onclick="openParentStudentProfile()">ÙØªØ­ Ø§Ù„Ù…Ù„Ù</button>
        <button class="btn-muted" onclick="openParentStudentCases()">Ø³Ø¬Ù„ Ø§Ù„Ø­Ø§Ù„Ø§Øª</button>
      </div>
      <div class="inline-row" style="margin-top:8px;">
        <button class="btn-muted" data-permission="export.report" onclick="exportParentReport()">ØªØµØ¯ÙŠØ± ØªÙ‚Ø±ÙŠØ±</button>
        <button class="btn-muted" onclick="createParentQuickAppointment()">Ø­Ø¬Ø² Ù…ÙˆØ¹Ø¯ Ø³Ø±ÙŠØ¹</button>
      </div>
    </article>

    <article class="sc-panel" data-permission="view.parent">
      <h3 class="sc-panel-title">Ø¬Ù„Ø³Ø© Ù…Ø¨Ø§Ø´Ø±Ø© Ù…Ø¹ Ø§Ù„Ø·Ø¨ÙŠØ¨</h3>
      <p id="telemed-parent-status" class="sc-panel-subtitle">Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¯Ø¹ÙˆØ© ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±...</p>
      <span id="telemed-parent-badge" class="badge b-warn">ØºÙŠØ± Ù†Ø´Ø·Ø©</span>
      <div class="inline-row" style="margin-top:12px;">
        <button class="btn-primary" id="telemed-parent-join" onclick="joinParentTelemed()" disabled>Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ù„Ù„Ø¬Ù„Ø³Ø©</button>
        <button class="btn-muted" onclick="refreshParentTelemed()">ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¬Ù„Ø³Ø©</button>
      </div>
    </article>

    <article class="sc-panel" data-permission="view.parent">
      <h3 class="sc-panel-title">Ù…Ø±ÙƒØ² Ø§Ù„ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø¹Ù„Ø§Ø¬ÙŠ</h3>
      <p class="sc-panel-subtitle">Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø§Øª Ø§Ù„Ø±Ù‚Ù…ÙŠØ©ØŒ Ø®Ø·Ø© Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ù…Ù†Ø²Ù„ÙŠØ©ØŒ Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯ØŒ ÙˆØ§Ù„ØªØ°Ø§ÙƒØ± ÙÙŠ ÙˆØ§Ø¬Ù‡Ø© Ù…ÙˆØ­Ø¯Ø©.</p>
      <button class="btn-primary" onclick="window.location.href='care-center.html'">ÙØªØ­ Ø§Ù„Ù…Ø±ÙƒØ²</button>
    </article>
  </section>

  <h2 id="parent-comm" class="sc-section-title">Ø§Ù„ØªÙˆØ§ØµÙ„ ÙˆØ§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª</h2>
  <section class="sc-grid-3 sc-mb-24">
    <article class="sc-panel" data-permission="view.alerts">
      <h3 class="sc-panel-title">ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø§Ù„ÙŠÙˆÙ…</h3>
      <p class="sc-panel-subtitle">Ø¢Ø®Ø± Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø§Ù„Ù…ØªØ¹Ù„Ù‚Ø© Ø¨ØµØ­Ø© Ø§Ù„Ø·Ø§Ù„Ø¨.</p>
      <select id="alert-filter" onchange="applyAlertFilter()">
        <option value="all">ÙƒÙ„ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª</option>
        <option value="critical">Ø­Ø±Ø¬Ø©</option>
        <option value="operational">ØªØ´ØºÙŠÙ„ÙŠØ©</option>
        <option value="info">Ù…Ø¹Ù„ÙˆÙ…Ø§ØªÙŠØ©</option>
      </select>
      <div id="alerts-mini" class="list"></div>
      <div class="inline-row" style="margin-top:12px;">
        <button class="btn-primary" onclick="window.location.href='parent-alerts.html'">Ø¹Ø±Ø¶ Ø§Ù„ÙƒÙ„</button>
        <button class="btn-muted" onclick="loadOverview()">ØªØ­Ø¯ÙŠØ«</button>
      </div>
    </article>

    <article class="sc-panel" data-permission="send.message">
      <h3 class="sc-panel-title">Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ø¹ÙŠØ§Ø¯Ø©</h3>
      <p class="sc-panel-subtitle">Ø¥Ø±Ø³Ø§Ù„ Ø§Ø³ØªÙØ³Ø§Ø± Ù…Ø¨Ø§Ø´Ø± Ù„ÙØ±ÙŠÙ‚ Ø§Ù„Ø¹ÙŠØ§Ø¯Ø© Ø§Ù„Ù…Ø¯Ø±Ø³ÙŠØ©.</p>
      <button class="btn-primary" onclick="window.location.href='parent-messages.html'">Ø¥Ø±Ø³Ø§Ù„ Ø§Ø³ØªÙØ³Ø§Ø±</button>
    </article>

    <article class="sc-panel" data-permission="view.notifications">
      <h3 class="sc-panel-title">Ù…Ø±ÙƒØ² Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ù…ÙˆØ­Ø¯</h3>
      <p class="sc-panel-subtitle">ÙÙ„ØªØ±Ø© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø­Ø³Ø¨ Ø§Ù„Ù†ÙˆØ¹: Ø­Ø±Ø¬ØŒ Ø¥Ø¬Ø±Ø§Ø¦ÙŠØŒ Ù…Ø¹Ù„ÙˆÙ…Ø©.</p>
      <button class="btn-primary" onclick="window.location.href='notifications-center.html'">ÙØªØ­ Ø§Ù„Ù…Ø±ÙƒØ²</button>
    </article>
  </section>

  <h2 id="parent-reports" class="sc-section-title">Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± ÙˆØ§Ù„ØªÙˆØ«ÙŠÙ‚</h2>
  <section class="sc-grid-3">
    <article class="sc-panel" data-permission="export.report">
      <h3 class="sc-panel-title">Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ø·Ø¨ÙŠØ©</h3>
      <p class="sc-panel-subtitle">ØªØ­Ù…ÙŠÙ„ ÙˆÙ…Ø±Ø§Ø¬Ø¹Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ù…ØªØ§Ø­Ø©.</p>
      <div class="inline-row">
        <button class="btn-primary" onclick="window.location.href='parent-reports.html'">ÙØªØ­ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</button>
        <button class="btn-muted" data-permission="view.student" onclick="window.location.href='student-profile.html#reports'">ØªÙ‚Ø§Ø±ÙŠØ± Ø³Ø±ÙŠØ¹Ø©</button>
      </div>
    </article>
  </section>
</div>
<div id="toast" class="toast"></div>

<script src="../../assets/js/security.js"></script>
<script src="../../assets/js/ui-shell.js"></script>
<script>
var parentTelemedSessionId = null;
var alertsCache = [];
var parentOverview = null;

function downloadTextFile(filename, text) {
  var blob = new Blob([String(text || '')], { type: 'text/plain;charset=utf-8' });
  var url = URL.createObjectURL(blob);
  var link = document.createElement('a');
  link.href = url;
  link.download = filename;
  document.body.appendChild(link);
  link.click();
  link.remove();
  URL.revokeObjectURL(url);
}

function scrollParentSection(id) {
  var target = document.getElementById(id);
  if (target) {
    target.scrollIntoView({ behavior: 'smooth', block: 'start' });
  }
}

function severityTone(value) {
  var level = String(value || '').toLowerCase();
  if (level === 'critical' || level === 'high' || level === 'Ø­Ø±Ø¬Ø©') return 'sc-severity-critical';
  if (level === 'medium' || level === 'warning' || level === 'Ù…ØªÙˆØ³Ø·Ø©') return 'sc-severity-medium';
  if (level === 'low' || level === 'stable' || level === 'Ù…Ø³ØªÙ‚Ø±Ø©') return 'sc-severity-low';
  return '';
}

function renderStats(snapshot) {
  var s = snapshot || {};
  var items = [
    ['Ø§Ù„Ø­Ø§Ù„Ø§Øª', Number(s.openCases || 0)],
    ['Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯/Ø§Ù„Ø·Ù„Ø¨Ø§Øª', Number(s.pendingVisits || 0)],
    ['Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª', Number(s.alerts || 0)]
  ];
  document.getElementById('stats').innerHTML = items.map(function (it) {
    return '<article class="sc-kpi-card"><div class="sc-kpi-label">' + it[0] + '</div><div class="sc-kpi-value">' + it[1] + '</div></article>';
  }).join('');
}

function riskLabel(risk) {
  var map = {
    critical: 'Ø­Ø±Ø¬',
    warning: 'Ù…ØªØ§Ø¨Ø¹Ø©',
    stable: 'Ù…Ø³ØªÙ‚Ø±',
    medium: 'Ù…ØªÙˆØ³Ø·',
    low: 'Ù…Ù†Ø®ÙØ¶',
    unknown: 'ØºÙŠØ± Ù…ØªÙˆÙØ±'
  };
  return map[risk] || map.unknown;
}

function statusBadgeClass(severity) {
  if (severity === 'critical' || severity === 'high') return 'b-danger';
  if (severity === 'medium') return 'b-warn';
  return 'b-ok';
}

function refreshHeroMeta(payload) {
  var snapshot = (payload && payload.snapshot) || {};
  document.getElementById('status-mode').textContent = SmartClinicSecurity.isDemoMode() ? 'Demo' : 'Live';
  document.getElementById('status-sync').textContent = new Date().toLocaleTimeString('ar-SA');
  document.getElementById('status-risk').textContent = riskLabel(snapshot.latestVitalsRisk || 'unknown');
}

function renderLatestCase(item) {
  var statusEl = document.getElementById('student-current-status');
  if (!item) {
    document.getElementById('latest-case').textContent = 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø§Ù„Ø© Ù†Ø´Ø·Ø©.';
    document.getElementById('latest-case-badge').textContent = 'Ù…Ø³ØªÙ‚Ø±Ø©';
    document.getElementById('latest-case-badge').className = 'badge b-ok';
    statusEl.className = 'sc-badge sc-severity-low';
    statusEl.textContent = 'Ù…Ø³ØªÙ‚Ø±Ø©';
    return;
  }
  document.getElementById('latest-case').textContent = item.title + ' â€¢ Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«: ' + new Date(item.updatedAt).toLocaleString('ar-SA');
  document.getElementById('latest-case-badge').textContent = item.severity || 'low';
  document.getElementById('latest-case-badge').className = 'badge ' + statusBadgeClass(item.severity);
  statusEl.className = 'sc-badge ' + severityTone(item.severity);
  statusEl.textContent = riskLabel(item.severity || 'low');
}

function renderAlerts(items) {
  var wrap = document.getElementById('alerts-mini');
  if (!items || !items.length) {
    wrap.innerHTML = '<div class="item">Ù„Ø§ ØªÙˆØ¬Ø¯ ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø¬Ø¯ÙŠØ¯Ø©.</div>';
    return;
  }
  wrap.innerHTML = items.slice(0, 3).map(function (a) {
    var when = a.createdAt ? new Date(a.createdAt).toLocaleTimeString('ar-SA') : '-';
    return '<div class="item"><strong>' + (a.text || 'ØªÙ†Ø¨ÙŠÙ‡') + '</strong><div class="item-meta">' + when + '</div></div>';
  }).join('');
}

function applyAlertFilter() {
  var mode = document.getElementById('alert-filter') ? document.getElementById('alert-filter').value : 'all';
  var filtered = alertsCache.slice();
  if (mode === 'critical' || mode === 'operational' || mode === 'info') {
    filtered = filtered.filter(function (a) { return (a.type || 'info') === mode; });
  }
  renderAlerts(filtered);
}

async function loadOverview() {
  try {
    var result = await SmartClinicSecurity.apiJson('/student/overview');
    if (!result.ok || !result.data) {
      notifyParent(result.error || 'ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±.');
      await refreshParentTelemed();
      return;
    }
    var payload = result.data;
    parentOverview = payload;
    refreshHeroMeta(payload);
    renderStats(payload.snapshot || {});
    renderLatestCase(payload.latestCase || null);
    alertsCache = payload.alerts || [];
    applyAlertFilter();
    await refreshParentTelemed();
  } catch (err) {
    notifyParent('ØªØ¹Ø°Ø± Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù….');
    await refreshParentTelemed();
  }
}

async function refreshParentTelemed() {
  var session = await SmartClinicSecurity.getLatestTelemedSession({
    role: 'parent'
  });
  var status = document.getElementById('telemed-parent-status');
  var joinBtn = document.getElementById('telemed-parent-join');

  if (!session) {
    parentTelemedSessionId = null;
    status.textContent = 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¯Ø¹ÙˆØ© Ù…Ø±Ø¦ÙŠØ© Ù…ÙØ¹Ù„Ø© Ù„ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø± Ø­Ø§Ù„ÙŠÙ‹Ø§.';
    document.getElementById('telemed-parent-badge').className = 'badge b-warn';
    document.getElementById('telemed-parent-badge').textContent = 'ØºÙŠØ± Ù†Ø´Ø·Ø©';
    joinBtn.disabled = true;
    return;
  }

  parentTelemedSessionId = session.id;
  var when = session.createdAt ? new Date(session.createdAt).toLocaleTimeString('ar-SA') : '-';
  status.textContent = 'Ø§Ù„Ø¯Ø¹ÙˆØ© Ù…ÙØ¹Ù„Ø© â€¢ Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø¬Ù„Ø³Ø© Ø¹Ù†Ø¯ ' + when;
  document.getElementById('telemed-parent-badge').className = 'badge b-ok';
  document.getElementById('telemed-parent-badge').textContent = 'Ù†Ø´Ø·Ø© Ø§Ù„Ø¢Ù†';
  joinBtn.disabled = false;
}

async function joinParentTelemed() {
  if (!parentTelemedSessionId) {
    await refreshParentTelemed();
    return;
  }
  var invite = await SmartClinicSecurity.createTelemedInvite(parentTelemedSessionId, 'parent');
  if (!invite.ok || !invite.item || !invite.item.token) {
    notifyParent('Ø§Ù„Ø¯Ø¹ÙˆØ© ØºÙŠØ± Ù…ØªØ§Ø­Ø© Ø­Ø§Ù„ÙŠÙ‹Ø§ Ø£Ùˆ Ù„Ù… ÙŠØªÙ… ØªÙØ¹ÙŠÙ„ Ù…Ø´Ø§Ø±ÙƒØ© ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±.');
    return;
  }
  window.location.href = SmartClinicSecurity.getTelemedRoomPath(parentTelemedSessionId, invite.item.token);
}

function notifyParent(text) {
  var el = document.getElementById('toast');
  el.textContent = text;
  el.style.display = 'block';
  window.setTimeout(function () { el.style.display = 'none'; }, 2200);
}

function openParentStudentProfile() {
  var latest = parentOverview && parentOverview.latestCase ? parentOverview.latestCase : null;
  var target = 'student-profile.html?studentId=u_student_1';
  if (latest && latest.id) {
    target += '&caseId=' + encodeURIComponent(latest.id);
  }
  window.location.href = target;
}

function openParentStudentCases() {
  var latest = parentOverview && parentOverview.latestCase ? parentOverview.latestCase : null;
  var target = 'student-profile.html?studentId=u_student_1#cases';
  if (latest && latest.id) {
    target = 'student-profile.html?studentId=u_student_1&caseId=' + encodeURIComponent(latest.id) + '#cases';
  }
  window.location.href = target;
}

async function exportParentReport() {
  var reportId = '';
  if (parentOverview && Array.isArray(parentOverview.reports) && parentOverview.reports.length) {
    reportId = String(parentOverview.reports[0].id || '');
  }
  var result = await SmartClinicSecurity.apiJson('/reports/export', {
    method: 'POST',
    body: JSON.stringify(reportId ? { reportId: reportId } : {})
  });
  if (!result.ok || !result.data) {
    notifyParent(result.error || 'ØªØ¹Ø°Ø± ØªØµØ¯ÙŠØ± Ø§Ù„ØªÙ‚Ø±ÙŠØ±.');
    return;
  }
  var snapshot = (parentOverview && parentOverview.snapshot) || {};
  var latestCase = (parentOverview && parentOverview.latestCase) || {};
  var filename = String((result.data.filename || 'parent-report').replace(/\.pdf$/i, ''));
  var body = [
    'Smart Clinic Parent Portal Export',
    'Generated At: ' + new Date().toISOString(),
    'Open Cases: ' + Number(snapshot.openCases || 0),
    'Critical Cases: ' + Number(snapshot.criticalCases || 0),
    'Reports: ' + Number(snapshot.reports || 0),
    'Alerts: ' + Number(snapshot.alerts || 0),
    'Latest Case: ' + (latestCase.title || '-') + ' | ' + (latestCase.severity || '-') + ' | ' + (latestCase.updatedAt ? new Date(latestCase.updatedAt).toLocaleString('ar-SA') : '-')
  ].join('\n');
  downloadTextFile(filename + '-parent.txt', body);
  notifyParent(result.data.message || 'ØªÙ… ØªØ¬Ù‡ÙŠØ² Ø§Ù„ØªÙ‚Ø±ÙŠØ±.');
}

async function createParentQuickAppointment() {
  var reason = window.prompt('Ø³Ø¨Ø¨ Ø§Ù„Ù…ÙˆØ¹Ø¯:', 'Ù…ØªØ§Ø¨Ø¹Ø© Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ø§Ù„Ø¨');
  if (reason === null) return;
  reason = String(reason || '').trim();
  if (!reason) {
    notifyParent('Ø³Ø¨Ø¨ Ø§Ù„Ù…ÙˆØ¹Ø¯ Ù…Ø·Ù„ÙˆØ¨.');
    return;
  }
  var slotRaw = window.prompt('Ù…ÙˆØ¹Ø¯ Ø§Ù„Ø²ÙŠØ§Ø±Ø© (Ù…Ø«Ø§Ù„ 2026-02-12T10:30):', '');
  if (slotRaw === null) return;
  var slotDate = slotRaw ? new Date(slotRaw) : new Date(Date.now() + 24 * 60 * 60 * 1000);
  if (!Number.isFinite(slotDate.getTime())) {
    notifyParent('ØµÙŠØºØ© Ø§Ù„ØªØ§Ø±ÙŠØ® ØºÙŠØ± ØµØ­ÙŠØ­Ø©.');
    return;
  }
  var result = await SmartClinicSecurity.apiJson('/appointments', {
    method: 'POST',
    body: JSON.stringify({
      studentId: 'u_student_1',
      reason: reason,
      slotAt: slotDate.toISOString()
    })
  });
  if (!result.ok) {
    notifyParent(result.error || 'ØªØ¹Ø°Ø± Ø­Ø¬Ø² Ø§Ù„Ù…ÙˆØ¹Ø¯.');
    return;
  }
  notifyParent('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…ÙˆØ¹Ø¯ Ø¨Ù†Ø¬Ø§Ø­.');
}

window.addEventListener('DOMContentLoaded', function () {
  SmartClinicSecurity.requireAccess(['parent', 'admin'], 'Ø¨ÙˆØ§Ø¨Ø© ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±');
  if (window.SmartClinicUI) {
    SmartClinicUI.mountQuickNav({
      afterSelector: '.sc-page-header',
      onRefresh: loadOverview,
      links: [
        { label: 'Ø¨ÙˆØ§Ø¨Ø© ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±', href: 'parent-portal.html' },
        { label: 'Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±', href: 'parent-reports.html' },
        { label: 'Ø§Ù„Ø±Ø³Ø§Ø¦Ù„', href: 'parent-messages.html' },
        { label: 'Ù…Ø±ÙƒØ² Ø§Ù„ØªÙ†Ø³ÙŠÙ‚', href: 'care-center.html' },
        { label: 'Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª', href: 'notifications-center.html' }
      ]
    });
  }
  window.addEventListener('keydown', function (ev) {
    if (ev.defaultPrevented) return;
    if (ev.key && ev.key.toLowerCase() === 'r') {
      var tag = ev.target && ev.target.tagName ? ev.target.tagName.toLowerCase() : '';
      if (tag !== 'input' && tag !== 'textarea' && tag !== 'select') {
        loadOverview();
      }
    }
  });
  refreshParentTelemed();
  SmartClinicSecurity.createAutoRefresh(loadOverview, 20000, { immediate: true });
});
</script>
</body>
</html>
