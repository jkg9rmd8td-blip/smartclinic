<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Ø¨ÙˆØ§Ø¨Ø© ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø± â€“ Smart Clinic</title>
<link rel="stylesheet" href="../../assets/css/variables.css">
<link rel="stylesheet" href="../../assets/css/layout.css">
<link rel="stylesheet" href="../../assets/css/cards.css">
<link rel="stylesheet" href="../../assets/css/tables.css">
<style>
.portal-meta {
  display: flex;
  gap: var(--sc-space-2);
  flex-wrap: wrap;
  margin-bottom: var(--sc-space-3);
}

.parent-status-line {
  display: flex;
  align-items: center;
  gap: var(--sc-space-2);
  margin-bottom: var(--sc-space-3);
}

.toast {
  position: fixed;
  left: 16px;
  bottom: 16px;
  background: var(--sc-surface-strong);
  color: var(--sc-text);
  border: 1px solid var(--sc-border);
  border-radius: var(--sc-radius-md);
  padding: 10px 12px;
  font-size: 12px;
  display: none;
  z-index: 40;
}

.analytics-kpi-grid {
  display: grid;
  gap: var(--sc-space-2);
  grid-template-columns: repeat(4, minmax(0, 1fr));
  margin-bottom: var(--sc-space-3);
}

.analytics-kpi-card {
  border: 1px solid var(--sc-border);
  border-radius: var(--sc-radius-md);
  padding: 12px;
  background: rgba(255, 255, 255, 0.03);
}

.analytics-kpi-title {
  color: var(--sc-text-soft);
  font-size: 12px;
}

.analytics-kpi-value {
  margin-top: 8px;
  font-size: 24px;
  font-weight: 800;
}

.analytics-value-good {
  color: var(--sc-low);
}

.analytics-value-warn {
  color: var(--sc-medium);
}

.analytics-value-critical {
  color: var(--sc-critical);
}

.analytics-kpi-sub {
  margin-top: 6px;
  color: var(--sc-text-soft);
  font-size: 12px;
}

.analytics-layout {
  display: grid;
  gap: var(--sc-space-2);
  grid-template-columns: repeat(2, minmax(0, 1fr));
}

.analytics-card {
  border: 1px solid rgba(255, 255, 255, 0.12);
  border-radius: var(--sc-radius-md);
  padding: 12px;
  background: rgba(255, 255, 255, 0.03);
}

.analytics-card h3 {
  margin: 0 0 8px;
  font-size: 15px;
}

.risk-timeline {
  display: flex;
  align-items: end;
  justify-content: space-between;
  gap: 8px;
  min-height: 128px;
}

.risk-point {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 6px;
  flex: 1;
}

.risk-bar {
  width: 100%;
  min-width: 22px;
  border-radius: 8px 8px 4px 4px;
  border: 1px solid rgba(255, 255, 255, 0.2);
  background: rgba(82, 196, 26, 0.3);
}

.risk-bar.risk-critical {
  background: rgba(255, 77, 79, 0.4);
  border-color: rgba(255, 77, 79, 0.55);
}

.risk-bar.risk-warning {
  background: rgba(250, 140, 22, 0.36);
  border-color: rgba(250, 140, 22, 0.55);
}

.risk-bar.risk-stable {
  background: rgba(82, 196, 26, 0.3);
  border-color: rgba(82, 196, 26, 0.5);
}

.risk-point-day {
  color: var(--sc-text-soft);
  font-size: 11px;
}

.risk-point-value {
  font-size: 11px;
}

.adherence-progress {
  width: 100%;
  height: 9px;
  border-radius: 999px;
  border: 1px solid var(--sc-border);
  background: rgba(255, 255, 255, 0.05);
  overflow: hidden;
  margin: 8px 0;
}

.adherence-progress-fill {
  height: 100%;
  background: linear-gradient(90deg, rgba(250, 140, 22, 0.8), rgba(82, 196, 26, 0.9));
  transition: width .35s ease;
}

.guidance-list {
  display: grid;
  gap: var(--sc-space-2);
}

.guidance-item {
  border: 1px solid rgba(255, 255, 255, 0.14);
  border-radius: var(--sc-radius-md);
  background: rgba(255, 255, 255, 0.03);
  padding: 10px 12px;
}

.guidance-item-title {
  font-size: 14px;
  font-weight: 700;
  margin-bottom: 6px;
}

.guidance-item-subtitle {
  color: var(--sc-text-soft);
  font-size: 12px;
  margin-bottom: 6px;
}

.guidance-steps {
  margin: 0;
  padding-right: 16px;
  color: var(--sc-text-soft);
  font-size: 12px;
}

@media (max-width: 960px) {
  .analytics-kpi-grid {
    grid-template-columns: repeat(2, minmax(0, 1fr));
  }
  .analytics-layout {
    grid-template-columns: 1fr;
  }
}

@media (max-width: 620px) {
  .analytics-kpi-grid {
    grid-template-columns: 1fr;
  }
}
</style>
</head>
<body class="sc-page">
<div class="sc-shell">
  <header class="sc-page-header">
    <div class="sc-page-header-main">
      <div class="sc-page-icon">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§</div>
      <div>
        <h1 class="sc-page-title">Ø¨ÙˆØ§Ø¨Ø© ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±</h1>
        <p class="sc-page-subtitle">Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„ØµØ­ÙŠØ© Ù„Ù„Ø·Ø§Ù„Ø¨ØŒ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§ØªØŒ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±ØŒ ÙˆØ§Ù„ØªÙˆØ§ØµÙ„ Ø§Ù„Ù…Ø¨Ø§Ø´Ø± Ù…Ù† ÙˆØ§Ø¬Ù‡Ø© Ù…ÙˆØ­Ù‘Ø¯Ø©.</p>
      </div>
    </div>
    <div class="sc-header-actions">
      <span class="sc-role-chip">Ø§Ù„Ø¯ÙˆØ± Ø§Ù„Ø­Ø§Ù„ÙŠ: <strong data-session-role>ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±</strong></span>
      <button class="sc-action-btn" data-action="logout">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
    </div>
  </header>

  <section class="sc-panel sc-mb-24">
    <h2 class="sc-panel-title">Ù…Ù„Ø®Øµ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ù„Ø­Ø¸ÙŠ</h2>
    <div class="portal-meta">
      <div class="meta-item">Ø§Ù„Ù†Ù…Ø·: <strong id="status-mode">-</strong></div>
      <div class="meta-item">Ø¢Ø®Ø± Ù…Ø²Ø§Ù…Ù†Ø©: <strong id="status-sync">-</strong></div>
      <div class="meta-item">Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø®Ø·Ø±: <strong id="status-risk">-</strong></div>
    </div>
    <div class="parent-status-line">
      <span class="sc-muted">Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ø§Ù„Ø¨ Ø§Ù„Ø­Ø§Ù„ÙŠØ©:</span>
      <span id="student-current-status" class="sc-badge sc-severity-low">Ù…Ø³ØªÙ‚Ø±Ø©</span>
    </div>
    <div class="sc-section-nav">
      <button class="sc-action-btn" onclick="scrollParentSection('parent-care')">Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø·Ø§Ù„Ø¨</button>
      <button class="sc-action-btn" onclick="scrollParentSection('parent-insights')">Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„Ø£Ø¯Ø§Ø¡</button>
      <button class="sc-action-btn" onclick="scrollParentSection('parent-comm')">Ø§Ù„ØªÙˆØ§ØµÙ„ ÙˆØ§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª</button>
      <button class="sc-action-btn" onclick="scrollParentSection('parent-guidance')">Ø§Ù„ØªÙˆØ¹ÙŠØ© ÙˆØ§Ù„Ø¥Ø±Ø´Ø§Ø¯</button>
      <button class="sc-action-btn" onclick="scrollParentSection('parent-reports')">Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</button>
    </div>
  </section>

  <section id="stats" class="sc-grid-3 sc-kpi-grid sc-mb-24"></section>

  <section id="parent-insights" class="sc-panel sc-mb-24">
    <h2 class="sc-panel-title">Ù„ÙˆØ­Ø© Ù…Ø¤Ø´Ø±Ø§Øª ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±</h2>
    <p class="sc-panel-subtitle">Ø¹Ø±Ø¶ Ø­ÙŠ Ù„Ø¹Ø¯Ø¯ Ø§Ù„Ø²ÙŠØ§Ø±Ø§ØªØŒ ØªØ·ÙˆØ± Ø§Ù„Ø­Ø§Ù„Ø©ØŒ Ø§Ù„Ø§Ù„ØªØ²Ø§Ù… Ø§Ù„Ø¹Ù„Ø§Ø¬ÙŠØŒ ÙˆÙ…Ø¤Ø´Ø±Ø§Øª Ø§Ù„Ø®Ø·Ø± Ø¹Ø¨Ø± Ø§Ù„Ø²Ù…Ù†.</p>
    <div id="parent-analytics-kpis" class="analytics-kpi-grid"></div>
    <div class="analytics-layout">
      <article class="analytics-card">
        <h3>Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„Ø®Ø·Ø± Ø¹Ø¨Ø± Ø§Ù„Ø²Ù…Ù† (7 Ø£ÙŠØ§Ù…)</h3>
        <div id="risk-timeline" class="risk-timeline"></div>
      </article>
      <article class="analytics-card">
        <h3>Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø§Ù„ØªØ²Ø§Ù… Ø§Ù„Ø¹Ù„Ø§Ø¬ÙŠ</h3>
        <div id="adherence-summary"></div>
      </article>
    </div>
  </section>

  <h2 id="parent-care" class="sc-section-title">Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø·Ø§Ù„Ø¨</h2>
  <section class="sc-grid-3 sc-mb-24">
    <article class="sc-panel" data-permission="view.student">
      <h3 class="sc-panel-title">Ø§Ù„Ù…Ù„Ù Ø§Ù„ØµØ­ÙŠ Ù„Ù„Ø·Ø§Ù„Ø¨</h3>
      <p id="latest-case" class="sc-panel-subtitle">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø£Ø­Ø¯Ø« Ø­Ø§Ù„Ø©...</p>
      <span id="latest-case-badge" class="badge b-ok">Ù…Ø³ØªÙ‚Ø±Ø©</span>
      <div class="inline-row" style="margin-top:12px;">
        <button class="btn-primary" onclick="openParentStudentProfile()">ÙØªØ­ Ø§Ù„Ù…Ù„Ù</button>
        <button class="btn-muted" onclick="openParentStudentCases()">Ø³Ø¬Ù„ Ø§Ù„Ø­Ø§Ù„Ø§Øª</button>
      </div>
      <div class="inline-row" style="margin-top:8px;">
        <button class="btn-muted" data-permission="export.report" onclick="exportParentReport()">ØªØµØ¯ÙŠØ± ØªÙ‚Ø±ÙŠØ±</button>
        <button class="btn-muted" onclick="createParentQuickAppointment()">Ø­Ø¬Ø² Ù…ÙˆØ¹Ø¯ Ø³Ø±ÙŠØ¹</button>
      </div>
    </article>

    <article class="sc-panel" data-permission="view.parent">
      <h3 class="sc-panel-title">Ø¬Ù„Ø³Ø© Ù…Ø¨Ø§Ø´Ø±Ø© Ù…Ø¹ Ø§Ù„Ø·Ø¨ÙŠØ¨</h3>
      <p id="telemed-parent-status" class="sc-panel-subtitle">Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¯Ø¹ÙˆØ© ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±...</p>
      <span id="telemed-parent-badge" class="badge b-warn">ØºÙŠØ± Ù†Ø´Ø·Ø©</span>
      <div class="inline-row" style="margin-top:12px;">
        <button class="btn-primary" id="telemed-parent-join" onclick="joinParentTelemed()" disabled>Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ù„Ù„Ø¬Ù„Ø³Ø©</button>
        <button class="btn-muted" onclick="refreshParentTelemed()">ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¬Ù„Ø³Ø©</button>
      </div>
    </article>

    <article class="sc-panel" data-permission="view.parent">
      <h3 class="sc-panel-title">Ù…Ø±ÙƒØ² Ø§Ù„ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø¹Ù„Ø§Ø¬ÙŠ</h3>
      <p class="sc-panel-subtitle">Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø§Øª Ø§Ù„Ø±Ù‚Ù…ÙŠØ©ØŒ Ø®Ø·Ø© Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ù…Ù†Ø²Ù„ÙŠØ©ØŒ Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯ØŒ ÙˆØ§Ù„ØªØ°Ø§ÙƒØ± ÙÙŠ ÙˆØ§Ø¬Ù‡Ø© Ù…ÙˆØ­Ø¯Ø©.</p>
      <button class="btn-primary" onclick="window.location.href='care-center.html'">ÙØªØ­ Ø§Ù„Ù…Ø±ÙƒØ²</button>
    </article>
  </section>

  <h2 id="parent-comm" class="sc-section-title">Ø§Ù„ØªÙˆØ§ØµÙ„ ÙˆØ§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª</h2>
  <section class="sc-grid-3 sc-mb-24">
    <article class="sc-panel" data-permission="view.alerts">
      <h3 class="sc-panel-title">ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø§Ù„ÙŠÙˆÙ…</h3>
      <p class="sc-panel-subtitle">Ø¢Ø®Ø± Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø§Ù„Ù…ØªØ¹Ù„Ù‚Ø© Ø¨ØµØ­Ø© Ø§Ù„Ø·Ø§Ù„Ø¨.</p>
      <select id="alert-filter" onchange="applyAlertFilter()">
        <option value="all">ÙƒÙ„ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª</option>
        <option value="critical">Ø­Ø±Ø¬Ø©</option>
        <option value="operational">ØªØ´ØºÙŠÙ„ÙŠØ©</option>
        <option value="info">Ù…Ø¹Ù„ÙˆÙ…Ø§ØªÙŠØ©</option>
      </select>
      <div id="alerts-mini" class="list"></div>
      <div class="inline-row" style="margin-top:12px;">
        <button class="btn-primary" onclick="window.location.href='parent-alerts.html'">Ø¹Ø±Ø¶ Ø§Ù„ÙƒÙ„</button>
        <button class="btn-muted" onclick="loadOverview()">ØªØ­Ø¯ÙŠØ«</button>
      </div>
    </article>

    <article class="sc-panel" data-permission="send.message">
      <h3 class="sc-panel-title">Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ø¹ÙŠØ§Ø¯Ø©</h3>
      <p class="sc-panel-subtitle">Ø¥Ø±Ø³Ø§Ù„ Ø§Ø³ØªÙØ³Ø§Ø± Ù…Ø¨Ø§Ø´Ø± Ù„ÙØ±ÙŠÙ‚ Ø§Ù„Ø¹ÙŠØ§Ø¯Ø© Ø§Ù„Ù…Ø¯Ø±Ø³ÙŠØ©.</p>
      <button class="btn-primary" onclick="window.location.href='parent-messages.html'">Ø¥Ø±Ø³Ø§Ù„ Ø§Ø³ØªÙØ³Ø§Ø±</button>
    </article>

    <article class="sc-panel" data-permission="view.notifications">
      <h3 class="sc-panel-title">Ù…Ø±ÙƒØ² Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ù…ÙˆØ­Ø¯</h3>
      <p class="sc-panel-subtitle">ÙÙ„ØªØ±Ø© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø­Ø³Ø¨ Ø§Ù„Ù†ÙˆØ¹: Ø­Ø±Ø¬ØŒ Ø¥Ø¬Ø±Ø§Ø¦ÙŠØŒ Ù…Ø¹Ù„ÙˆÙ…Ø©.</p>
      <button class="btn-primary" onclick="window.location.href='notifications-center.html'">ÙØªØ­ Ø§Ù„Ù…Ø±ÙƒØ²</button>
    </article>
  </section>

  <h2 id="parent-guidance" class="sc-section-title">Ø§Ù„ØªÙˆØ¹ÙŠØ© ÙˆØ§Ù„Ø¥Ø±Ø´Ø§Ø¯</h2>
  <section class="sc-grid-3 sc-mb-24">
    <article class="sc-panel sc-col-span-2">
      <h3 class="sc-panel-title">Ù†ØµØ§Ø¦Ø­ ØµØ­ÙŠØ© Ù…Ø®ØµØµØ© Ù„Ù„Ø­Ø§Ù„Ø©</h3>
      <p class="sc-panel-subtitle">ØªÙˆØµÙŠØ§Øª Ø³Ø±ÙŠØ¹Ø© Ù…Ø¨Ù†ÙŠØ© Ø¹Ù„Ù‰ Ø¢Ø®Ø± Ø­Ø§Ù„Ø© ÙˆØ¹Ù„Ø§Ù…Ø§Øª Ø§Ù„Ø·Ø§Ù„Ø¨ Ø§Ù„Ø­ÙŠÙˆÙŠØ©.</p>
      <div id="guidance-tips" class="guidance-list"></div>
    </article>
    <article class="sc-panel">
      <h3 class="sc-panel-title">Ø¨Ø±ÙˆØªÙˆÙƒÙˆÙ„Ø§Øª Ø§Ù„Ù…Ø¯Ø±Ø³Ø©</h3>
      <p class="sc-panel-subtitle">Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ù…Ø¹ÙŠØ§Ø±ÙŠØ© Ù„Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„Ø­Ø§Ù„Ø§Øª Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…Ø¯Ø±Ø³Ø©.</p>
      <div id="guidance-protocols" class="guidance-list"></div>
    </article>
  </section>

  <h2 id="parent-reports" class="sc-section-title">Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± ÙˆØ§Ù„ØªÙˆØ«ÙŠÙ‚</h2>
  <section class="sc-grid-3">
    <article class="sc-panel" data-permission="export.report">
      <h3 class="sc-panel-title">Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ø·Ø¨ÙŠØ©</h3>
      <p class="sc-panel-subtitle">ØªØ­Ù…ÙŠÙ„ ÙˆÙ…Ø±Ø§Ø¬Ø¹Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ù…ØªØ§Ø­Ø©.</p>
      <div class="inline-row">
        <button class="btn-primary" onclick="window.location.href='parent-reports.html'">ÙØªØ­ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</button>
        <button class="btn-muted" data-permission="view.student" onclick="window.location.href='student-profile.html#reports'">ØªÙ‚Ø§Ø±ÙŠØ± Ø³Ø±ÙŠØ¹Ø©</button>
      </div>
    </article>
  </section>
</div>
<div id="toast" class="toast"></div>

<script src="../../assets/js/security.js?v=20260214c"></script>
<script src="../../assets/js/ui-shell.js?v=20260214c"></script>
<script>
var parentTelemedSessionId = null;
var alertsCache = [];
var parentOverview = null;

function downloadTextFile(filename, text) {
  var blob = new Blob([String(text || '')], { type: 'text/plain;charset=utf-8' });
  var url = URL.createObjectURL(blob);
  var link = document.createElement('a');
  link.href = url;
  link.download = filename;
  document.body.appendChild(link);
  link.click();
  link.remove();
  URL.revokeObjectURL(url);
}

function scrollParentSection(id) {
  var target = document.getElementById(id);
  if (target) {
    target.scrollIntoView({ behavior: 'smooth', block: 'start' });
  }
}

function severityTone(value) {
  var level = String(value || '').toLowerCase();
  if (level === 'critical' || level === 'high' || level === 'Ø­Ø±Ø¬Ø©') return 'sc-severity-critical';
  if (level === 'medium' || level === 'warning' || level === 'Ù…ØªÙˆØ³Ø·Ø©') return 'sc-severity-medium';
  if (level === 'low' || level === 'stable' || level === 'Ù…Ø³ØªÙ‚Ø±Ø©') return 'sc-severity-low';
  return '';
}

function renderStats(snapshot) {
  var s = snapshot || {};
  var items = [
    ['Ø§Ù„Ø­Ø§Ù„Ø§Øª', Number(s.openCases || 0)],
    ['Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯/Ø§Ù„Ø·Ù„Ø¨Ø§Øª', Number(s.pendingVisits || 0)],
    ['Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª', Number(s.alerts || 0)]
  ];
  document.getElementById('stats').innerHTML = items.map(function (it) {
    return '<article class="sc-kpi-card"><div class="sc-kpi-label">' + it[0] + '</div><div class="sc-kpi-value">' + it[1] + '</div></article>';
  }).join('');
}

function riskLabel(risk) {
  var map = {
    critical: 'Ø­Ø±Ø¬',
    warning: 'Ù…ØªØ§Ø¨Ø¹Ø©',
    stable: 'Ù…Ø³ØªÙ‚Ø±',
    medium: 'Ù…ØªÙˆØ³Ø·',
    low: 'Ù…Ù†Ø®ÙØ¶',
    unknown: 'ØºÙŠØ± Ù…ØªÙˆÙØ±'
  };
  return map[risk] || map.unknown;
}

function statusBadgeClass(severity) {
  if (severity === 'critical' || severity === 'high') return 'b-danger';
  if (severity === 'medium') return 'b-warn';
  return 'b-ok';
}

function escapeHtml(value) {
  return String(value || '')
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&#39;');
}

function formatDateAr(value) {
  if (!value) return '-';
  var parsed = new Date(value);
  if (!Number.isFinite(parsed.getTime())) return '-';
  return parsed.toLocaleString('ar-SA');
}

function dayLabelAr(value) {
  var parsed = new Date(value + 'T12:00:00Z');
  if (!Number.isFinite(parsed.getTime())) return '-';
  return parsed.toLocaleDateString('ar-SA', { weekday: 'short' });
}

function conditionTone(direction) {
  if (direction === 'improving') return 'analytics-value-good';
  if (direction === 'deteriorating') return 'analytics-value-critical';
  return 'analytics-value-warn';
}

function adherenceTone(status) {
  if (status === 'excellent' || status === 'good') return 'analytics-value-good';
  if (status === 'warning') return 'analytics-value-critical';
  return 'analytics-value-warn';
}

function riskBarClass(risk) {
  if (risk === 'critical') return 'risk-critical';
  if (risk === 'warning') return 'risk-warning';
  return 'risk-stable';
}

function renderParentAnalytics(payload) {
  var analytics = (payload && payload.parentAnalytics) || {};
  var visits = analytics.visits || {};
  var condition = analytics.condition || {};
  var adherence = analytics.adherence || {};
  var risk = analytics.riskIndicators || {};
  var adherencePercent = Number(adherence.percent);
  if (!Number.isFinite(adherencePercent)) adherencePercent = null;

  var cards = [
    {
      title: 'Ø¹Ø¯Ø¯ Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª',
      value: String(Number(visits.total || 0)),
      subtitle: 'Ù…ÙƒØªÙ…Ù„: ' + Number(visits.completed || 0) + ' â€¢ Ù‚ÙŠØ¯ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©: ' + Number(visits.pending || 0),
      tone: ''
    },
    {
      title: 'ØªØ·ÙˆØ± Ø§Ù„Ø­Ø§Ù„Ø©',
      value: escapeHtml(condition.label || 'ØºÙŠØ± Ù…ØªÙˆÙØ±'),
      subtitle: escapeHtml(condition.summary || 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª ÙƒØ§ÙÙŠØ©'),
      tone: conditionTone(condition.direction)
    },
    {
      title: 'Ø§Ù„Ø§Ù„ØªØ²Ø§Ù… Ø§Ù„Ø¹Ù„Ø§Ø¬ÙŠ',
      value: adherencePercent === null ? 'ØºÙŠØ± Ù…ÙØ¹Ù„' : (String(Math.round(adherencePercent)) + '%'),
      subtitle: 'Ø§Ù„Ø­Ø§Ù„Ø©: ' + escapeHtml(adherence.statusLabel || 'ØºÙŠØ± Ù…ØªÙˆÙØ±'),
      tone: adherenceTone(adherence.status)
    },
    {
      title: 'Ù…Ø¤Ø´Ø± Ø§Ù„Ø®Ø·Ø± Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠ',
      value: String(Number(risk.highDays || 0)) + ' ÙŠÙˆÙ… Ù…Ø±ØªÙØ¹',
      subtitle: 'Ù…ØªÙˆØ³Ø·: ' + Number(risk.averageScore || 0) + ' â€¢ Ù…ØªÙˆØ³Ø· Ø§Ù„Ø®Ø·ÙˆØ±Ø©: ' + Number(risk.warningDays || 0),
      tone: Number(risk.highDays || 0) > 0 ? 'analytics-value-critical' : 'analytics-value-good'
    }
  ];
  var wrap = document.getElementById('parent-analytics-kpis');
  wrap.innerHTML = cards.map(function (card) {
    var tone = card.tone ? ' ' + card.tone : '';
    return '<article class="analytics-kpi-card">' +
      '<div class="analytics-kpi-title">' + card.title + '</div>' +
      '<div class="analytics-kpi-value' + tone + '">' + card.value + '</div>' +
      '<div class="analytics-kpi-sub">' + card.subtitle + '</div>' +
    '</article>';
  }).join('');

  renderRiskTimeline(analytics.riskTimeline || []);
  renderAdherenceSummary(adherence, visits);
}

function renderRiskTimeline(points) {
  var wrap = document.getElementById('risk-timeline');
  if (!Array.isArray(points) || !points.length) {
    wrap.innerHTML = '<div class="sc-muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø²Ù…Ù†ÙŠØ© ÙƒØ§ÙÙŠØ© Ø¨Ø¹Ø¯.</div>';
    return;
  }
  wrap.innerHTML = points.slice(-7).map(function (point) {
    var score = Math.max(0, Math.min(100, Number(point.score || 0)));
    var height = Math.max(18, Math.round((score / 100) * 94));
    var risk = String(point.risk || 'stable');
    return '<div class="risk-point">' +
      '<div class="risk-bar ' + riskBarClass(risk) + '" style="height:' + height + 'px"></div>' +
      '<div class="risk-point-day">' + dayLabelAr(String(point.date || '')) + '</div>' +
      '<div class="risk-point-value">' + score + '</div>' +
    '</div>';
  }).join('');
}

function renderAdherenceSummary(adherence, visits) {
  var wrap = document.getElementById('adherence-summary');
  var percent = Number(adherence && adherence.percent);
  if (!Number.isFinite(percent)) percent = null;
  var barWidth = percent === null ? 8 : Math.max(4, Math.min(100, Math.round(percent)));
  var summary = '';
  summary += '<div class="item">';
  summary += '<strong>Ù†Ø³Ø¨Ø© Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…:</strong> ' + (percent === null ? 'ØºÙŠØ± Ù…ÙØ¹Ù„Ø©' : (Math.round(percent) + '%'));
  summary += '<div class="adherence-progress"><div class="adherence-progress-fill" style="width:' + barWidth + '%"></div></div>';
  summary += '<div class="item-meta">Ø§Ù„Ù…ØªÙˆÙ‚Ø¹: ' + Number((adherence && adherence.expectedDoses) || 0) + ' â€¢ Ø§Ù„Ù…Ø£Ø®ÙˆØ°: ' + Number((adherence && adherence.takenDoses) || 0) + ' â€¢ Ø§Ù„Ù…ØªØ¬Ø§ÙˆØ²: ' + Number((adherence && adherence.skippedDoses) || 0) + '</div>';
  summary += '</div>';
  summary += '<div class="item"><strong>Ø¢Ø®Ø± Ø²ÙŠØ§Ø±Ø© Ù…ÙƒØªÙ…Ù„Ø©:</strong> ' + formatDateAr(visits && visits.lastVisitAt) + '</div>';
  summary += '<div class="item"><strong>Ø§Ù„Ø²ÙŠØ§Ø±Ø© Ø§Ù„Ù‚Ø§Ø¯Ù…Ø©:</strong> ' + formatDateAr(visits && visits.nextVisitAt) + '</div>';
  if (adherence && adherence.alert) {
    summary += '<div class="item"><strong>ØªÙ†Ø¨ÙŠÙ‡ Ø¹Ù„Ø§Ø¬ÙŠ:</strong> ' + escapeHtml(adherence.alert) + '</div>';
  }
  wrap.innerHTML = summary;
}

function renderParentGuidance(payload) {
  var guidance = (payload && payload.parentGuidance) || {};
  var tips = Array.isArray(guidance.tips) ? guidance.tips : [];
  var protocols = Array.isArray(guidance.protocols) ? guidance.protocols : [];
  var tipsWrap = document.getElementById('guidance-tips');
  var protocolsWrap = document.getElementById('guidance-protocols');

  if (!tips.length) {
    tipsWrap.innerHTML = '<article class="guidance-item">Ù„Ø§ ØªÙˆØ¬Ø¯ ØªÙˆØµÙŠØ§Øª Ù…Ø®ØµØµØ© Ø­Ø§Ù„ÙŠÙ‹Ø§.</article>';
  } else {
    tipsWrap.innerHTML = tips.map(function (tip) {
      return '<article class="guidance-item">' + escapeHtml(tip) + '</article>';
    }).join('');
  }

  if (!protocols.length) {
    protocolsWrap.innerHTML = '<article class="guidance-item">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨Ø±ÙˆØªÙˆÙƒÙˆÙ„Ø§Øª Ù…ØªØ§Ø­Ø© Ø­Ø§Ù„ÙŠÙ‹Ø§.</article>';
    return;
  }

  protocolsWrap.innerHTML = protocols.map(function (protocol) {
    var steps = Array.isArray(protocol.steps) ? protocol.steps.slice(0, 4) : [];
    return '<article class="guidance-item">' +
      '<div class="guidance-item-title">' + escapeHtml(protocol.title || 'Ø¨Ø±ÙˆØªÙˆÙƒÙˆÙ„') + '</div>' +
      '<div class="guidance-item-subtitle">' + escapeHtml(protocol.summary || '') + '</div>' +
      '<ol class="guidance-steps">' + steps.map(function (step) { return '<li>' + escapeHtml(step) + '</li>'; }).join('') + '</ol>' +
    '</article>';
  }).join('');
}

function refreshHeroMeta(payload) {
  var snapshot = (payload && payload.snapshot) || {};
  document.getElementById('status-mode').textContent = SmartClinicSecurity.isDemoMode() ? 'Demo' : 'Live';
  document.getElementById('status-sync').textContent = new Date().toLocaleTimeString('ar-SA');
  document.getElementById('status-risk').textContent = riskLabel(snapshot.latestVitalsRisk || 'unknown');
}

function renderLatestCase(item) {
  var statusEl = document.getElementById('student-current-status');
  if (!item) {
    document.getElementById('latest-case').textContent = 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø§Ù„Ø© Ù†Ø´Ø·Ø©.';
    document.getElementById('latest-case-badge').textContent = 'Ù…Ø³ØªÙ‚Ø±Ø©';
    document.getElementById('latest-case-badge').className = 'badge b-ok';
    statusEl.className = 'sc-badge sc-severity-low';
    statusEl.textContent = 'Ù…Ø³ØªÙ‚Ø±Ø©';
    return;
  }
  document.getElementById('latest-case').textContent = item.title + ' â€¢ Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«: ' + new Date(item.updatedAt).toLocaleString('ar-SA');
  document.getElementById('latest-case-badge').textContent = item.severity || 'low';
  document.getElementById('latest-case-badge').className = 'badge ' + statusBadgeClass(item.severity);
  statusEl.className = 'sc-badge ' + severityTone(item.severity);
  statusEl.textContent = riskLabel(item.severity || 'low');
}

function renderAlerts(items) {
  var wrap = document.getElementById('alerts-mini');
  if (!items || !items.length) {
    wrap.innerHTML = '<div class="item">Ù„Ø§ ØªÙˆØ¬Ø¯ ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø¬Ø¯ÙŠØ¯Ø©.</div>';
    return;
  }
  wrap.innerHTML = items.slice(0, 3).map(function (a) {
    var when = a.createdAt ? new Date(a.createdAt).toLocaleTimeString('ar-SA') : '-';
    return '<div class="item"><strong>' + (a.text || 'ØªÙ†Ø¨ÙŠÙ‡') + '</strong><div class="item-meta">' + when + '</div></div>';
  }).join('');
}

function applyAlertFilter() {
  var mode = document.getElementById('alert-filter') ? document.getElementById('alert-filter').value : 'all';
  var filtered = alertsCache.slice();
  if (mode === 'critical' || mode === 'operational' || mode === 'info') {
    filtered = filtered.filter(function (a) { return (a.type || 'info') === mode; });
  }
  renderAlerts(filtered);
}

async function loadOverview() {
  try {
    var result = await SmartClinicSecurity.apiJson('/student/overview');
    if (!result.ok || !result.data) {
      notifyParent(result.error || 'ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±.');
      renderParentAnalytics(null);
      renderParentGuidance(null);
      await refreshParentTelemed();
      return;
    }
    var payload = result.data;
    parentOverview = payload;
    refreshHeroMeta(payload);
    renderStats(payload.snapshot || {});
    renderLatestCase(payload.latestCase || null);
    renderParentAnalytics(payload);
    renderParentGuidance(payload);
    alertsCache = payload.alerts || [];
    applyAlertFilter();
    await refreshParentTelemed();
  } catch (err) {
    notifyParent('ØªØ¹Ø°Ø± Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù….');
    renderParentAnalytics(null);
    renderParentGuidance(null);
    await refreshParentTelemed();
  }
}

async function refreshParentTelemed() {
  var session = await SmartClinicSecurity.getLatestTelemedSession({
    role: 'parent'
  });
  var status = document.getElementById('telemed-parent-status');
  var joinBtn = document.getElementById('telemed-parent-join');

  if (!session) {
    parentTelemedSessionId = null;
    status.textContent = 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¯Ø¹ÙˆØ© Ù…Ø±Ø¦ÙŠØ© Ù…ÙØ¹Ù„Ø© Ù„ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø± Ø­Ø§Ù„ÙŠÙ‹Ø§.';
    document.getElementById('telemed-parent-badge').className = 'badge b-warn';
    document.getElementById('telemed-parent-badge').textContent = 'ØºÙŠØ± Ù†Ø´Ø·Ø©';
    joinBtn.disabled = true;
    return;
  }

  parentTelemedSessionId = session.id;
  var when = session.createdAt ? new Date(session.createdAt).toLocaleTimeString('ar-SA') : '-';
  status.textContent = 'Ø§Ù„Ø¯Ø¹ÙˆØ© Ù…ÙØ¹Ù„Ø© â€¢ Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø¬Ù„Ø³Ø© Ø¹Ù†Ø¯ ' + when;
  document.getElementById('telemed-parent-badge').className = 'badge b-ok';
  document.getElementById('telemed-parent-badge').textContent = 'Ù†Ø´Ø·Ø© Ø§Ù„Ø¢Ù†';
  joinBtn.disabled = false;
}

async function joinParentTelemed() {
  if (!parentTelemedSessionId) {
    await refreshParentTelemed();
    return;
  }
  var invite = await SmartClinicSecurity.createTelemedInvite(parentTelemedSessionId, 'parent');
  if (!invite.ok || !invite.item || !invite.item.token) {
    notifyParent('Ø§Ù„Ø¯Ø¹ÙˆØ© ØºÙŠØ± Ù…ØªØ§Ø­Ø© Ø­Ø§Ù„ÙŠÙ‹Ø§ Ø£Ùˆ Ù„Ù… ÙŠØªÙ… ØªÙØ¹ÙŠÙ„ Ù…Ø´Ø§Ø±ÙƒØ© ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±.');
    return;
  }
  window.location.href = SmartClinicSecurity.getTelemedRoomPath(parentTelemedSessionId, invite.item.token);
}

function notifyParent(text) {
  var el = document.getElementById('toast');
  el.textContent = text;
  el.style.display = 'block';
  window.setTimeout(function () { el.style.display = 'none'; }, 2200);
}

function openParentStudentProfile() {
  var latest = parentOverview && parentOverview.latestCase ? parentOverview.latestCase : null;
  var target = 'student-profile.html?studentId=u_student_1';
  if (latest && latest.id) {
    target += '&caseId=' + encodeURIComponent(latest.id);
  }
  window.location.href = target;
}

function openParentStudentCases() {
  var latest = parentOverview && parentOverview.latestCase ? parentOverview.latestCase : null;
  var target = 'student-profile.html?studentId=u_student_1#cases';
  if (latest && latest.id) {
    target = 'student-profile.html?studentId=u_student_1&caseId=' + encodeURIComponent(latest.id) + '#cases';
  }
  window.location.href = target;
}

async function exportParentReport() {
  var reportId = '';
  if (parentOverview && Array.isArray(parentOverview.reports) && parentOverview.reports.length) {
    reportId = String(parentOverview.reports[0].id || '');
  }
  var result = await SmartClinicSecurity.apiJson('/reports/export', {
    method: 'POST',
    body: JSON.stringify(reportId ? { reportId: reportId } : {})
  });
  if (!result.ok || !result.data) {
    notifyParent(result.error || 'ØªØ¹Ø°Ø± ØªØµØ¯ÙŠØ± Ø§Ù„ØªÙ‚Ø±ÙŠØ±.');
    return;
  }
  var snapshot = (parentOverview && parentOverview.snapshot) || {};
  var latestCase = (parentOverview && parentOverview.latestCase) || {};
  var analytics = (parentOverview && parentOverview.parentAnalytics) || {};
  var visits = analytics.visits || {};
  var condition = analytics.condition || {};
  var adherence = analytics.adherence || {};
  var risk = analytics.riskIndicators || {};
  var filename = String((result.data.filename || 'parent-report').replace(/\.pdf$/i, ''));
  var body = [
    'Smart Clinic Parent Portal Export',
    'Generated At: ' + new Date().toISOString(),
    'Open Cases: ' + Number(snapshot.openCases || 0),
    'Critical Cases: ' + Number(snapshot.criticalCases || 0),
    'Reports: ' + Number(snapshot.reports || 0),
    'Alerts: ' + Number(snapshot.alerts || 0),
    'Visits Total: ' + Number(visits.total || 0),
    'Visits Completed: ' + Number(visits.completed || 0),
    'Condition Trend: ' + String(condition.label || '-'),
    'Condition Summary: ' + String(condition.summary || '-'),
    'Treatment Adherence: ' + (Number.isFinite(Number(adherence.percent)) ? (Math.round(Number(adherence.percent)) + '%') : 'inactive'),
    'Risk High Days (7d): ' + Number(risk.highDays || 0),
    'Latest Case: ' + (latestCase.title || '-') + ' | ' + (latestCase.severity || '-') + ' | ' + (latestCase.updatedAt ? new Date(latestCase.updatedAt).toLocaleString('ar-SA') : '-')
  ].join('\n');
  downloadTextFile(filename + '-parent.txt', body);
  notifyParent(result.data.message || 'ØªÙ… ØªØ¬Ù‡ÙŠØ² Ø§Ù„ØªÙ‚Ø±ÙŠØ±.');
}

async function createParentQuickAppointment() {
  var reason = window.prompt('Ø³Ø¨Ø¨ Ø§Ù„Ù…ÙˆØ¹Ø¯:', 'Ù…ØªØ§Ø¨Ø¹Ø© Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ø§Ù„Ø¨');
  if (reason === null) return;
  reason = String(reason || '').trim();
  if (!reason) {
    notifyParent('Ø³Ø¨Ø¨ Ø§Ù„Ù…ÙˆØ¹Ø¯ Ù…Ø·Ù„ÙˆØ¨.');
    return;
  }
  var slotRaw = window.prompt('Ù…ÙˆØ¹Ø¯ Ø§Ù„Ø²ÙŠØ§Ø±Ø© (Ù…Ø«Ø§Ù„ 2026-02-12T10:30):', '');
  if (slotRaw === null) return;
  var slotDate = slotRaw ? new Date(slotRaw) : new Date(Date.now() + 24 * 60 * 60 * 1000);
  if (!Number.isFinite(slotDate.getTime())) {
    notifyParent('ØµÙŠØºØ© Ø§Ù„ØªØ§Ø±ÙŠØ® ØºÙŠØ± ØµØ­ÙŠØ­Ø©.');
    return;
  }
  var result = await SmartClinicSecurity.apiJson('/appointments', {
    method: 'POST',
    body: JSON.stringify({
      studentId: 'u_student_1',
      reason: reason,
      slotAt: slotDate.toISOString()
    })
  });
  if (!result.ok) {
    notifyParent(result.error || 'ØªØ¹Ø°Ø± Ø­Ø¬Ø² Ø§Ù„Ù…ÙˆØ¹Ø¯.');
    return;
  }
  notifyParent('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…ÙˆØ¹Ø¯ Ø¨Ù†Ø¬Ø§Ø­.');
}

window.addEventListener('DOMContentLoaded', function () {
  SmartClinicSecurity.requireAccess(['parent', 'admin'], 'Ø¨ÙˆØ§Ø¨Ø© ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±');
  if (window.SmartClinicUI) {
    SmartClinicUI.mountQuickNav({
      afterSelector: '.sc-page-header',
      onRefresh: loadOverview,
      links: [
        { label: 'Ø¨ÙˆØ§Ø¨Ø© ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±', href: 'parent-portal.html' },
        { label: 'Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±', href: 'parent-reports.html' },
        { label: 'Ø§Ù„Ø±Ø³Ø§Ø¦Ù„', href: 'parent-messages.html' },
        { label: 'Ù…Ø±ÙƒØ² Ø§Ù„ØªÙ†Ø³ÙŠÙ‚', href: 'care-center.html' },
        { label: 'Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª', href: 'notifications-center.html' }
      ]
    });
  }
  window.addEventListener('keydown', function (ev) {
    if (ev.defaultPrevented) return;
    if (ev.key && ev.key.toLowerCase() === 'r') {
      var tag = ev.target && ev.target.tagName ? ev.target.tagName.toLowerCase() : '';
      if (tag !== 'input' && tag !== 'textarea' && tag !== 'select') {
        loadOverview();
      }
    }
  });
  refreshParentTelemed();
  SmartClinicSecurity.createAutoRefresh(loadOverview, 20000, { immediate: true });
});
</script>
</body>
</html>
