<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„Ø·Ø§Ù„Ø¨ â€“ Smart Clinic</title>
<link rel="stylesheet" href="../../assets/css/variables.css">
<link rel="stylesheet" href="../../assets/css/layout.css">
<link rel="stylesheet" href="../../assets/css/cards.css">
<link rel="stylesheet" href="../../assets/css/tables.css">
<style>
.portal-meta {
  display: flex;
  gap: var(--sc-space-2);
  flex-wrap: wrap;
  margin-bottom: var(--sc-space-3);
}

.inline-help {
  margin-top: 6px;
  font-size: 12px;
  color: var(--sc-text-soft);
}

.ai-box {
  margin-top: 10px;
  border: 1px solid rgba(255,255,255,0.12);
  border-radius: var(--sc-radius-md);
  background: rgba(255,255,255,0.03);
  padding: 10px;
}

.toast {
  position: fixed;
  left: 16px;
  bottom: 16px;
  background: var(--sc-surface-strong);
  color: var(--sc-text);
  border: 1px solid var(--sc-border);
  border-radius: var(--sc-radius-md);
  padding: 10px 12px;
  font-size: 12px;
  display: none;
  z-index: 40;
}
</style>
</head>
<body class="sc-page">
<div class="sc-shell">
  <header class="sc-page-header">
    <div class="sc-page-header-main">
      <div class="sc-page-icon">ğŸ“</div>
      <div>
        <h1 class="sc-page-title">Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„Ø·Ø§Ù„Ø¨</h1>
        <p class="sc-page-subtitle">Ù…ØªØ§Ø¨Ø¹Ø© ØµØ­ÙŠØ© Ù…Ø¨Ø§Ø´Ø±Ø©ØŒ Ø·Ù„Ø¨Ø§Øª Ø²ÙŠØ§Ø±Ø©ØŒ Ø¥Ø´Ø¹Ø§Ø±Ø§ØªØŒ ÙˆÙ…Ø±Ø§Ø³Ù„Ø© Ø§Ù„Ø¹ÙŠØ§Ø¯Ø© Ù…Ù† ÙˆØ§Ø¬Ù‡Ø© Ù…ÙˆØ­Ø¯Ø©.</p>
      </div>
    </div>
    <div class="sc-header-actions">
      <span class="sc-role-chip">Ø§Ù„Ø¯ÙˆØ± Ø§Ù„Ø­Ø§Ù„ÙŠ: <strong data-session-role>Ø§Ù„Ø·Ø§Ù„Ø¨</strong></span>
      <button class="sc-action-btn" data-action="logout">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
    </div>
  </header>

  <section class="sc-panel sc-mb-24">
    <h2 class="sc-panel-title">Ù…Ù„Ø®Øµ Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ù„Ø­Ø¸ÙŠ</h2>
    <div class="portal-meta">
      <div class="meta-item">Ø§Ù„Ù†Ù…Ø·: <strong id="status-mode">-</strong></div>
      <div class="meta-item">Ø¢Ø®Ø± Ù…Ø²Ø§Ù…Ù†Ø©: <strong id="status-sync">-</strong></div>
      <div class="meta-item">Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø®Ø·Ø±: <strong id="status-risk">-</strong></div>
    </div>
    <div class="section-nav sc-section-nav">
      <button class="section-btn sc-action-btn" onclick="scrollStudentSection('student-care')">Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„ØµØ­ÙŠØ©</button>
      <button class="section-btn sc-action-btn" onclick="scrollStudentSection('student-comm')">Ø§Ù„ØªÙˆØ§ØµÙ„ ÙˆØ§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª</button>
      <button class="section-btn sc-action-btn" onclick="scrollStudentSection('student-tools')">Ø§Ù„Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ø°ÙƒÙŠØ©</button>
    </div>
  </section>

  <section id="stats" class="sc-grid-3 sc-kpi-grid sc-mb-24"></section>

  <h2 id="student-care" class="sc-section-title">Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„ØµØ­ÙŠØ© ÙˆØ§Ù„Ø²ÙŠØ§Ø±Ø§Øª</h2>
  <section class="sc-grid-3 sc-mb-24">
    <article class="sc-panel" data-permission="view.student">
      <h3 class="sc-panel-title">Ø­Ø§Ù„Ø© Ø§Ù„ÙŠÙˆÙ…</h3>
      <p id="latest-case-text" class="sc-panel-subtitle">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø£Ø­Ø¯Ø« Ø­Ø§Ù„Ø©...</p>
      <span id="latest-case-badge" class="badge b-ok">Ù…Ø³ØªÙ‚Ø±Ø©</span>
      <div class="inline-row" style="margin-top:12px;">
        <button class="btn-primary" onclick="openStudentProfile()">ÙØªØ­ Ø§Ù„Ù…Ù„Ù Ø§Ù„ØµØ­ÙŠ Ø§Ù„ÙƒØ§Ù…Ù„</button>
        <button class="btn-muted" data-permission="view.cases" onclick="jumpToCases()">Ø¹Ø±Ø¶ Ø§Ù„Ø­Ø§Ù„Ø§Øª</button>
      </div>
    </article>

    <article class="sc-panel" data-permission="request.visit">
      <h3 class="sc-panel-title">Ø·Ù„Ø¨ Ø²ÙŠØ§Ø±Ø© Ù„Ù„Ø¹ÙŠØ§Ø¯Ø©</h3>
      <p class="sc-panel-subtitle">Ø£Ø±Ø³Ù„ Ø·Ù„Ø¨ ÙØ­Øµ Ø¹Ø§Ø¯ÙŠ Ø£Ùˆ Ù…Ø³ØªØ¹Ø¬Ù„ Ù„Ù„ÙØ±ÙŠÙ‚ Ø§Ù„ØµØ­ÙŠ.</p>
      <select id="visit-priority">
        <option value="normal">Ø¹Ø§Ø¯ÙŠ</option>
        <option value="urgent">Ù…Ø³ØªØ¹Ø¬Ù„</option>
      </select>
      <div class="inline-row" style="margin-top:8px;">
        <button class="btn-muted" type="button" onclick="useVisitTemplate('ØµØ¯Ø§Ø¹ Ø´Ø¯ÙŠØ¯')">ØµØ¯Ø§Ø¹ Ø´Ø¯ÙŠØ¯</button>
        <button class="btn-muted" type="button" onclick="useVisitTemplate('Ø¶ÙŠÙ‚ ØªÙ†ÙØ³ Ù…ØªÙƒØ±Ø±')">Ø¶ÙŠÙ‚ ØªÙ†ÙØ³</button>
        <button class="btn-muted" type="button" onclick="useVisitTemplate('Ø£Ù„Ù… ÙÙŠ Ø§Ù„ØµØ¯Ø± Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ù†Ø´Ø§Ø·')">Ø£Ù„Ù… ØµØ¯Ø±</button>
      </div>
      <textarea id="visit-reason" rows="3" placeholder="Ø§ÙƒØªØ¨ Ø³Ø¨Ø¨ Ø§Ù„Ø·Ù„Ø¨..." oninput="updateVisitReasonMeta()"></textarea>
      <div class="inline-help">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø³Ø¨Ø¨: <span id="visit-reason-count">0</span>/220</div>
      <button class="btn-primary" onclick="requestVisit()">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨</button>
    </article>

    <article class="sc-panel" data-permission="view.student">
      <h3 class="sc-panel-title">Ø§Ù„Ø¹ÙŠØ§Ø¯Ø© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ© (ØµÙˆØª ÙˆØµÙˆØ±Ø©)</h3>
      <p id="telemed-student-status" class="sc-panel-subtitle">Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø¬Ù„Ø³Ø© Ù…Ø¨Ø§Ø´Ø±Ø©...</p>
      <span id="telemed-student-badge" class="badge b-ok">ØºÙŠØ± Ù†Ø´Ø·Ø©</span>
      <div class="inline-row" style="margin-top:12px;">
        <button class="btn-primary" id="telemed-student-join" onclick="joinStudentTelemed()" disabled>Ø§Ù†Ø¶Ù…Ø§Ù… Ù„Ù„Ø¬Ù„Ø³Ø©</button>
        <button class="btn-muted" onclick="refreshStudentTelemed()">ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø¬Ù„Ø³Ø©</button>
      </div>
    </article>

    <article class="sc-panel" data-permission="view.student">
      <h3 class="sc-panel-title">Ù…Ø±ÙƒØ² Ø§Ù„ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø¹Ù„Ø§Ø¬ÙŠ</h3>
      <p class="sc-panel-subtitle">Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø§Øª Ø§Ù„Ø±Ù‚Ù…ÙŠØ©ØŒ Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø·ÙˆØ§Ø±Ø¦ QRØŒ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ù…Ù†Ø²Ù„ÙŠØ©ØŒ ÙˆØ§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯ ÙÙŠ ØµÙØ­Ø© ÙˆØ§Ø­Ø¯Ø©.</p>
      <button class="btn-primary" onclick="window.location.href='care-center.html'">ÙØªØ­ Ø§Ù„Ù…Ø±ÙƒØ²</button>
    </article>
  </section>

  <h2 id="student-comm" class="sc-section-title">Ø§Ù„ØªÙˆØ§ØµÙ„ ÙˆØ§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª</h2>
  <section class="sc-grid-3 sc-mb-24">
    <article class="sc-panel" data-permission="send.message">
      <h3 class="sc-panel-title">Ù…Ø±Ø§Ø³Ù„Ø© Ø§Ù„Ø¹ÙŠØ§Ø¯Ø©</h3>
      <p class="sc-panel-subtitle">ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„ØµØ­ÙŠ Ù„Ø£ÙŠ Ø§Ø³ØªÙØ³Ø§Ø± Ø£Ùˆ Ù…ØªØ§Ø¨Ø¹Ø©.</p>
      <textarea id="message-text" rows="3" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ..." data-permission="send.message"></textarea>
      <div class="inline-row">
        <button class="btn-primary" data-permission="send.message" onclick="sendClinicMessage()">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©</button>
        <button class="btn-muted" data-permission="view.alerts" onclick="loadOverview()">ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
      </div>
    </article>

    <article class="sc-panel" data-permission="view.alerts">
      <h3 class="sc-panel-title">ØªÙ†Ø¨ÙŠÙ‡Ø§Øª ØµØ­ÙŠØ© Ù„Ùƒ</h3>
      <p class="sc-panel-subtitle">Ø¢Ø®Ø± Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ù…ØªØ§Ø¨Ø¹ØªÙƒ Ø§Ù„ØµØ­ÙŠØ©.</p>
      <select id="alert-filter" onchange="applyAlertFilter()">
        <option value="all">ÙƒÙ„ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª</option>
        <option value="critical">Ø­Ø±Ø¬</option>
        <option value="operational">ØªØ´ØºÙŠÙ„ÙŠ</option>
        <option value="info">Ù…Ø¹Ù„ÙˆÙ…Ø§ØªÙŠ</option>
      </select>
      <div id="alerts-list" class="list"></div>
    </article>

    <article class="sc-panel" data-permission="view.notifications">
      <h3 class="sc-panel-title">Ù…Ø±ÙƒØ² Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ù…ÙˆØ­Ø¯</h3>
      <p class="sc-panel-subtitle">Ø§Ø³ØªØ¹Ø±Ø¶ Ø¥Ø´Ø¹Ø§Ø±Ø§ØªÙƒ Ù…Ø¹ Ø§Ù„ÙÙ„Ø§ØªØ± Ø­Ø³Ø¨ Ø§Ù„Ù†ÙˆØ¹.</p>
      <button class="btn-primary" onclick="window.location.href='notifications-center.html'">ÙØªØ­ Ø§Ù„Ù…Ø±ÙƒØ²</button>
    </article>
  </section>

  <h2 id="student-tools" class="sc-section-title">Ø§Ù„Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ø°ÙƒÙŠØ©</h2>
  <section class="sc-grid-3">
    <article class="sc-panel" data-permission="use.ai.assistant">
      <h3 class="sc-panel-title">Ù…Ø³ØªØ´Ø§Ø± Ø§Ù„Ø·Ø§Ù„Ø¨ AI</h3>
      <p class="sc-panel-subtitle">ØªØ­Ù„ÙŠÙ„ ÙÙˆØ±ÙŠ Ù„Ù„Ø£Ø¹Ø±Ø§Ø¶ Ø§Ù„Ø­Ø§Ù„ÙŠØ© ÙˆØªÙˆØµÙŠØ§Øª Ø¹Ù…Ù„ÙŠØ© Ø­Ø³Ø¨ Ù…Ù„ÙÙƒ Ø§Ù„ØµØ­ÙŠ.</p>
      <textarea id="ai-student-input" rows="3" placeholder="Ø§ÙƒØªØ¨ Ø§Ù„Ø£Ø¹Ø±Ø§Ø¶ Ø£Ùˆ Ø­Ø§Ù„ØªÙƒ Ø§Ù„Ø¢Ù†..."></textarea>
      <div class="inline-row">
        <button class="btn-primary" onclick="askStudentAi()">ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø­Ø§Ù„Ø©</button>
        <button class="btn-muted" onclick="document.getElementById('ai-student-input').value=''">Ù…Ø³Ø­</button>
      </div>
      <div id="ai-student-output" class="ai-box">Ù„Ù… ÙŠØªÙ… ØªØ´ØºÙŠÙ„ Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø¨Ø¹Ø¯.</div>
    </article>

    <article class="sc-panel" data-permission="view.reports">
      <h3 class="sc-panel-title">ØªÙ‚Ø§Ø±ÙŠØ±ÙŠ Ø§Ù„ØµØ­ÙŠØ©</h3>
      <p class="sc-panel-subtitle">Ø£Ø­Ø¯Ø« Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ø·Ø¨ÙŠØ© Ø§Ù„Ù…ØªØ§Ø­Ø© Ù„Ùƒ.</p>
      <div id="reports-list" class="list"></div>
      <div class="inline-row">
        <button class="btn-muted" onclick="window.location.href='student-profile.html#reports'">Ø¹Ø±Ø¶ ÙƒÙ„ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</button>
        <button class="btn-muted" data-permission="export.report" onclick="exportStudentReport()">ØªØµØ¯ÙŠØ± Ø§Ù„ØªÙ‚Ø±ÙŠØ±</button>
      </div>
    </article>

    <article class="sc-panel" data-permission="view.tips">
      <h3 class="sc-panel-title">Ù†ØµÙŠØ­Ø© Ø°ÙƒÙŠØ© Ø§Ù„ÙŠÙˆÙ…</h3>
      <p id="tip-text" class="sc-panel-subtitle">Ø¬Ø§Ø±ÙŠ Ø§Ø®ØªÙŠØ§Ø± Ù†ØµÙŠØ­Ø© Ù…Ù†Ø§Ø³Ø¨Ø©...</p>
      <button class="btn-primary" onclick="nextTip()">Ù†ØµÙŠØ­Ø© Ø¬Ø¯ÙŠØ¯Ø©</button>
    </article>
  </section>
</div>

<div id="toast" class="toast"></div>
<script src="../../assets/js/security.js"></script>
<script src="../../assets/js/ui-shell.js"></script>
<script>
var lastOverview = null;
var alertsCache = [];
var tipIndex = 0;
var studentTelemedSessionId = null;
var tips = [
  'Ù†Ø¸Ù‘Ù… Ù†ÙˆÙ…Ùƒ Ø¥Ù„Ù‰ 8 Ø³Ø§Ø¹Ø§Øª ÙŠÙˆÙ…ÙŠÙ‹Ø§ Ù„ØªØ­Ø³ÙŠÙ† Ø§Ù„ØªØ±ÙƒÙŠØ² ÙˆØ§Ù„Ù…Ù†Ø§Ø¹Ø©.',
  'Ø§Ø´Ø±Ø¨ Ø§Ù„Ù…Ø§Ø¡ ÙƒÙ„ Ø³Ø§Ø¹Ø© Ø¯Ø±Ø§Ø³ÙŠØ© Ù„ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„ØµØ¯Ø§Ø¹ ÙˆØ§Ù„Ø¥Ø¬Ù‡Ø§Ø¯.',
  'Ø¥Ø°Ø§ Ø´Ø¹Ø±Øª Ø¨Ø¶ÙŠÙ‚ ØªÙ†ÙØ³ Ù…ØªÙƒØ±Ø±ØŒ Ø§Ø·Ù„Ø¨ Ø²ÙŠØ§Ø±Ø© ÙÙˆØ±ÙŠØ© Ù„Ù„Ø¹ÙŠØ§Ø¯Ø©.',
  'Ù‚Ù„Ù‘Ù„ Ø§Ù„Ù…Ø´Ø±ÙˆØ¨Ø§Øª Ø§Ù„Ø³ÙƒØ±ÙŠØ© ÙˆØ§Ø³ØªØ¨Ø¯Ù„Ù‡Ø§ Ø¨ÙˆØ¬Ø¨Ø§Øª Ø®ÙÙŠÙØ© ØµØ­ÙŠØ©.'
];

function notify(text) {
  var el = document.getElementById('toast');
  el.textContent = text;
  el.style.display = 'block';
  window.setTimeout(function () { el.style.display = 'none'; }, 2200);
}

function nextTip() {
  tipIndex = (tipIndex + 1) % tips.length;
  document.getElementById('tip-text').textContent = tips[tipIndex];
}

function scrollStudentSection(id) {
  var target = document.getElementById(id);
  if (target) {
    target.scrollIntoView({ behavior: 'smooth', block: 'start' });
  }
}

function statusBadgeClass(severity) {
  if (severity === 'critical' || severity === 'high') return 'b-danger';
  if (severity === 'medium') return 'b-warn';
  return 'b-ok';
}

function riskLabel(risk) {
  var map = {
    critical: 'Ø­Ø±Ø¬',
    warning: 'Ù…ØªØ§Ø¨Ø¹Ø©',
    stable: 'Ù…Ø³ØªÙ‚Ø±',
    medium: 'Ù…ØªÙˆØ³Ø·',
    low: 'Ù…Ù†Ø®ÙØ¶',
    unknown: 'ØºÙŠØ± Ù…ØªÙˆÙØ±'
  };
  return map[risk] || map.unknown;
}

function refreshHeroMeta(overview) {
  var risk = (((overview || {}).snapshot || {}).latestVitalsRisk) || 'unknown';
  document.getElementById('status-mode').textContent = SmartClinicSecurity.isDemoMode() ? 'Demo' : 'Live';
  document.getElementById('status-sync').textContent = new Date().toLocaleTimeString('ar-SA');
  document.getElementById('status-risk').textContent = riskLabel(risk);
}

function renderStats(snapshot) {
  var s = snapshot || {};
  var items = [
    ['Ø§Ù„Ø­Ø§Ù„Ø§Øª', Number(s.openCases || 0)],
    ['Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯/Ø§Ù„Ø·Ù„Ø¨Ø§Øª', Number(s.pendingVisits || 0)],
    ['Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª', Number(s.alerts || 0)]
  ];
  document.getElementById('stats').innerHTML = items.map(function (it) {
    return '<article class="sc-kpi-card"><div class="sc-kpi-label">' + it[0] + '</div><div class="sc-kpi-value">' + it[1] + '</div></article>';
  }).join('');
}

function renderLatestCase(item) {
  if (!item) {
    document.getElementById('latest-case-text').textContent = 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø§Ù„Ø§Øª Ù…Ø³Ø¬Ù„Ø© Ø­Ø§Ù„ÙŠÙ‹Ø§.';
    document.getElementById('latest-case-badge').textContent = 'Ù…Ø³ØªÙ‚Ø±Ø©';
    document.getElementById('latest-case-badge').className = 'badge b-ok';
    return;
  }
  document.getElementById('latest-case-text').textContent = (item.title || 'Ø­Ø§Ù„Ø© ØµØ­ÙŠØ©') + ' â€¢ Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«: ' + new Date(item.updatedAt).toLocaleString('ar-SA');
  document.getElementById('latest-case-badge').textContent = item.severity || 'low';
  document.getElementById('latest-case-badge').className = 'badge ' + statusBadgeClass(item.severity);
}

function renderAlerts(items) {
  var wrap = document.getElementById('alerts-list');
  if (!items || !items.length) {
    wrap.innerHTML = '<div class="item">Ù„Ø§ ØªÙˆØ¬Ø¯ ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø¬Ø¯ÙŠØ¯Ø©.</div>';
    return;
  }
  wrap.innerHTML = items.slice(0, 4).map(function (a) {
    var when = a.createdAt ? new Date(a.createdAt).toLocaleString('ar-SA') : '-';
    return '<div class="item"><strong>' + (a.text || 'ØªÙ†Ø¨ÙŠÙ‡') + '</strong><div style="color:#bfd5e6;font-size:12px;">' + when + '</div></div>';
  }).join('');
}

function applyAlertFilter() {
  var mode = document.getElementById('alert-filter') ? document.getElementById('alert-filter').value : 'all';
  var filtered = alertsCache.slice();
  if (mode === 'critical' || mode === 'operational' || mode === 'info') {
    filtered = filtered.filter(function (a) { return (a.type || 'info') === mode; });
  }
  renderAlerts(filtered);
}

function renderReports(items) {
  var wrap = document.getElementById('reports-list');
  if (!items || !items.length) {
    wrap.innerHTML = '<div class="item">Ù„Ø§ ØªÙˆØ¬Ø¯ ØªÙ‚Ø§Ø±ÙŠØ± Ù…ØªØ§Ø­Ø© Ø­Ø§Ù„ÙŠÙ‹Ø§.</div>';
    return;
  }
  wrap.innerHTML = items.slice(0, 4).map(function (r) {
    var when = r.createdAt ? new Date(r.createdAt).toLocaleDateString('ar-SA') : '-';
    return '<div class="item"><strong>' + (r.title || 'ØªÙ‚Ø±ÙŠØ± ØµØ­ÙŠ') + '</strong><div style="color:#bfd5e6;font-size:12px;">' + when + '</div></div>';
  }).join('');
}

async function loadOverview() {
  var result = await SmartClinicSecurity.apiJson('/student/overview');
  if (!result.ok || !result.data) {
    notify(result.error === 'request_timeout' ? 'Ø§Ù†ØªÙ‡Øª Ù…Ù‡Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.' : 'ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ø§Ù„Ø¨.');
    await refreshStudentTelemed();
    return;
  }
  lastOverview = result.data;
  renderStats(result.data.snapshot || {});
  renderLatestCase(result.data.latestCase || null);
  refreshHeroMeta(result.data);
  alertsCache = result.data.alerts || [];
  applyAlertFilter();
  renderReports(result.data.reports || []);
  await refreshStudentTelemed();
}

async function refreshStudentTelemed() {
  var session = await SmartClinicSecurity.getLatestTelemedSession({
    role: 'student'
  });
  var status = document.getElementById('telemed-student-status');
  var joinBtn = document.getElementById('telemed-student-join');

  if (!session) {
    studentTelemedSessionId = null;
    status.textContent = 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¬Ù„Ø³Ø© Ù…Ø¨Ø§Ø´Ø±Ø© Ù†Ø´Ø·Ø© Ø§Ù„Ø¢Ù†.';
    document.getElementById('telemed-student-badge').className = 'badge b-warn';
    document.getElementById('telemed-student-badge').textContent = 'ØºÙŠØ± Ù†Ø´Ø·Ø©';
    joinBtn.disabled = true;
    return;
  }

  studentTelemedSessionId = session.id;
  var when = session.createdAt ? new Date(session.createdAt).toLocaleTimeString('ar-SA') : '-';
  status.textContent = 'Ø¬Ù„Ø³Ø© Ù…ØªØ§Ø­Ø© Ø§Ù„Ø¢Ù† â€¢ Ø¨Ø¯Ø£Øª Ø¹Ù†Ø¯ ' + when;
  document.getElementById('telemed-student-badge').className = 'badge b-ok';
  document.getElementById('telemed-student-badge').textContent = 'Ù†Ø´Ø·Ø© Ø§Ù„Ø¢Ù†';
  joinBtn.disabled = false;
}

async function joinStudentTelemed() {
  if (!studentTelemedSessionId) {
    await refreshStudentTelemed();
    notify('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¬Ù„Ø³Ø© Ù…Ø±Ø¦ÙŠØ© Ù…ØªØ§Ø­Ø© Ø­Ø§Ù„ÙŠÙ‹Ø§.');
    return;
  }
  var invite = await SmartClinicSecurity.createTelemedInvite(studentTelemedSessionId, 'student');
  if (!invite.ok || !invite.item || !invite.item.token) {
    notify('ØªØ¹Ø°Ø± Ø¥Ù†Ø´Ø§Ø¡ Ø±Ø§Ø¨Ø· Ø¯Ø®ÙˆÙ„ Ø¢Ù…Ù† Ù„Ù„Ø¬Ù„Ø³Ø©.');
    return;
  }
  window.location.href = SmartClinicSecurity.getTelemedRoomPath(studentTelemedSessionId, invite.item.token);
}

function downloadTextFile(filename, text) {
  var blob = new Blob([String(text || '')], { type: 'text/plain;charset=utf-8' });
  var url = URL.createObjectURL(blob);
  var link = document.createElement('a');
  link.href = url;
  link.download = filename;
  document.body.appendChild(link);
  link.click();
  link.remove();
  URL.revokeObjectURL(url);
}

function openStudentProfile() {
  var target = 'student-profile.html';
  var latest = lastOverview && lastOverview.latestCase ? lastOverview.latestCase : null;
  if (latest && latest.id) {
    target += '?caseId=' + encodeURIComponent(latest.id);
  }
  window.location.href = target;
}

function jumpToCases() {
  window.location.href = 'student-profile.html#cases';
}

async function exportStudentReport() {
  var reportId = '';
  if (lastOverview && Array.isArray(lastOverview.reports) && lastOverview.reports.length) {
    reportId = String(lastOverview.reports[0].id || '');
  }
  var result = await SmartClinicSecurity.apiJson('/reports/export', {
    method: 'POST',
    body: JSON.stringify(reportId ? { reportId: reportId } : {})
  });
  if (!result.ok || !result.data) {
    notify(result.error || 'ØªØ¹Ø°Ø± ØªØµØ¯ÙŠØ± Ø§Ù„ØªÙ‚Ø±ÙŠØ±.');
    return;
  }
  var snapshot = (lastOverview && lastOverview.snapshot) || {};
  var latestCase = (lastOverview && lastOverview.latestCase) || {};
  var filename = String((result.data.filename || 'student-report').replace(/\.pdf$/i, ''));
  var body = [
    'Smart Clinic Student Portal Export',
    'Generated At: ' + new Date().toISOString(),
    'Open Cases: ' + Number(snapshot.openCases || 0),
    'Critical Cases: ' + Number(snapshot.criticalCases || 0),
    'Pending Visits: ' + Number(snapshot.pendingVisits || 0),
    'Alerts: ' + Number(snapshot.alerts || 0),
    'Latest Case: ' + (latestCase.title || '-') + ' | ' + (latestCase.severity || '-') + ' | ' + (latestCase.updatedAt ? new Date(latestCase.updatedAt).toLocaleString('ar-SA') : '-')
  ].join('\n');
  downloadTextFile(filename + '-portal.txt', body);
  notify(result.data.message || 'ØªÙ… ØªØ¬Ù‡ÙŠØ² Ø§Ù„ØªÙ‚Ø±ÙŠØ±.');
}

function updateVisitReasonMeta() {
  var text = document.getElementById('visit-reason').value || '';
  document.getElementById('visit-reason-count').textContent = String(text.trim().length);
}

function useVisitTemplate(text) {
  document.getElementById('visit-reason').value = text || '';
  updateVisitReasonMeta();
}

function renderStudentAi(item) {
  if (!item) {
    document.getElementById('ai-student-output').textContent = 'ØªØ¹Ø°Ø± Ø¹Ø±Ø¶ Ù†ØªÙŠØ¬Ø© Ø§Ù„ØªØ­Ù„ÙŠÙ„.';
    return;
  }
  var riskLabel = item.risk === 'critical' ? 'Ø­Ø±Ø¬' : (item.risk === 'medium' ? 'Ù…ØªÙˆØ³Ø·' : 'Ù…Ù†Ø®ÙØ¶');
  var actions = (item.actions || []).map(function (a) { return '<div class="item">â€¢ ' + a + '</div>'; }).join('');
  var triggers = (item.triggers || []).map(function (t) { return '<div class="item">' + t + '</div>'; }).join('');
  document.getElementById('ai-student-output').innerHTML =
    '<div><strong>Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø®Ø·ÙˆØ±Ø©: ' + riskLabel + '</strong></div>' +
    '<div style="margin-top:6px;color:#bfd5e6;">Ù…Ø³Ø¨Ø¨Ø§Øª Ø§Ù„ØªÙ‚ÙŠÙŠÙ…</div>' + triggers +
    '<div style="margin-top:6px;color:#bfd5e6;">Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ù…Ù‚ØªØ±Ø­Ø©</div>' + actions;
}

async function askStudentAi() {
  var text = document.getElementById('ai-student-input').value.trim();
  var result = await SmartClinicSecurity.apiJson('/ai/student-support', {
    method: 'POST',
    body: JSON.stringify({ text: text })
  });
  if (!result.ok || !result.data) {
    notify(result.error || 'ÙØ´Ù„ ØªØ­Ù„ÙŠÙ„ AI.');
    return;
  }
  renderStudentAi(result.data.item || null);
  notify('ØªÙ… ØªÙˆÙ„ÙŠØ¯ ØªÙˆØµÙŠØ© AI Ù„Ù„Ø·Ø§Ù„Ø¨.');
}

async function requestVisit() {
  var priority = document.getElementById('visit-priority').value;
  var reason = document.getElementById('visit-reason').value.trim();
  if (!reason || reason.length < 5) {
    notify('Ø§ÙƒØªØ¨ Ø³Ø¨Ø¨Ù‹Ø§ Ø£ÙˆØ¶Ø­ (5 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„).');
    return;
  }

  var result = await SmartClinicSecurity.apiJson('/visit-requests', {
    method: 'POST',
    body: JSON.stringify({ reason: '[' + priority + '] ' + reason })
  });
  if (!result.ok) {
    notify(result.error || 'ØªØ¹Ø°Ø± Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨.');
    return;
  }
  document.getElementById('visit-reason').value = '';
  updateVisitReasonMeta();
  notify('ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø§Ù„Ø²ÙŠØ§Ø±Ø© Ø¨Ù†Ø¬Ø§Ø­.');
  loadOverview();
}

async function sendClinicMessage() {
  var text = document.getElementById('message-text').value.trim();
  if (!text) {
    notify('Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø© Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„.');
    return;
  }

  var result = await SmartClinicSecurity.apiJson('/messages', {
    method: 'POST',
    body: JSON.stringify({ text: text })
  });
  if (!result.ok) {
    notify(result.error || 'ÙØ´Ù„ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©.');
    return;
  }
  document.getElementById('message-text').value = '';
  notify('ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù„Ù„ÙØ±ÙŠÙ‚ Ø§Ù„ØµØ­ÙŠ.');
}

window.addEventListener('DOMContentLoaded', function () {
  SmartClinicSecurity.requireAccess(['student', 'admin'], 'Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„Ø·Ø§Ù„Ø¨');
  if (window.SmartClinicUI) {
    SmartClinicUI.mountQuickNav({
      afterSelector: '.sc-page-header',
      onRefresh: loadOverview,
      links: [
        { label: 'Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„Ø·Ø§Ù„Ø¨', href: 'student-portal.html' },
        { label: 'Ø§Ù„Ù…Ù„Ù Ø§Ù„ØµØ­ÙŠ', href: 'student-profile.html' },
        { label: 'Ù…Ø±ÙƒØ² Ø§Ù„ØªÙ†Ø³ÙŠÙ‚', href: 'care-center.html' },
        { label: 'Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª', href: 'notifications-center.html' }
      ]
    });
  }
  document.getElementById('tip-text').textContent = tips[tipIndex];
  updateVisitReasonMeta();
  refreshStudentTelemed();
  SmartClinicSecurity.createAutoRefresh(loadOverview, 20000, { immediate: true });
});
</script>
</body>
</html>
