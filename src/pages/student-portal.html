<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„Ø·Ø§Ù„Ø¨ â€“ Smart Clinic</title>
<link rel="stylesheet" href="../../assets/css/variables.css">
<link rel="stylesheet" href="../../assets/css/layout.css">
<link rel="stylesheet" href="../../assets/css/cards.css">
<link rel="stylesheet" href="../../assets/css/tables.css">
<style>
.portal-meta {
  display: flex;
  gap: var(--sc-space-2);
  flex-wrap: wrap;
  margin-bottom: var(--sc-space-3);
}

.inline-help {
  margin-top: 6px;
  font-size: 12px;
  color: var(--sc-text-soft);
}

.student-overview {
  position: relative;
  overflow: hidden;
}

.student-overview::before {
  content: "";
  position: absolute;
  top: -120px;
  left: -120px;
  width: 280px;
  height: 280px;
  border-radius: 42% 58% 63% 37% / 45% 36% 64% 55%;
  background: radial-gradient(circle, rgba(129, 230, 217, 0.22), transparent 70%);
  filter: blur(2px);
  animation: driftShape 10s ease-in-out infinite;
  pointer-events: none;
}

.student-overview::after {
  content: "";
  position: absolute;
  inset: auto -120px -120px auto;
  width: 280px;
  height: 280px;
  border-radius: 50%;
  background: radial-gradient(circle, rgba(56, 189, 248, 0.18), transparent 70%);
  pointer-events: none;
}

@keyframes driftShape {
  0% {
    transform: translate(0, 0) rotate(0deg);
  }
  50% {
    transform: translate(12px, 10px) rotate(8deg);
  }
  100% {
    transform: translate(0, 0) rotate(0deg);
  }
}

.overview-top {
  display: flex;
  align-items: flex-start;
  justify-content: space-between;
  gap: 12px;
  flex-wrap: wrap;
}

.hero-cta {
  margin-top: 6px;
}

.primary-cta {
  min-width: 180px;
  box-shadow: 0 10px 24px rgba(56, 189, 248, 0.28);
}

.live-strip {
  margin-top: 14px;
  border: 1px solid rgba(255, 255, 255, 0.12);
  border-radius: var(--sc-radius-md);
  background: linear-gradient(145deg, rgba(56, 189, 248, 0.08), rgba(255, 255, 255, 0.02));
  padding: 12px;
  display: grid;
  grid-template-columns: repeat(5, minmax(0, 1fr));
  gap: 8px;
}

.live-cell {
  border: 1px solid rgba(255, 255, 255, 0.12);
  border-radius: var(--sc-radius-md);
  background: rgba(255, 255, 255, 0.02);
  padding: 8px 10px;
  min-height: 64px;
  display: flex;
  flex-direction: column;
  justify-content: center;
}

.live-label {
  font-size: 11px;
  color: var(--sc-text-soft);
}

.live-value {
  margin-top: 4px;
  font-size: 16px;
  font-weight: 800;
  line-height: 1.2;
}

.live-signal {
  display: inline-flex;
  align-items: center;
  gap: 6px;
}

.live-dot {
  width: 9px;
  height: 9px;
  border-radius: 50%;
  background: #36cfc9;
  box-shadow: 0 0 0 0 rgba(54, 207, 201, 0.45);
  animation: livePulse 1.6s infinite;
}

@keyframes livePulse {
  0% {
    box-shadow: 0 0 0 0 rgba(54, 207, 201, 0.45);
  }
  70% {
    box-shadow: 0 0 0 9px rgba(54, 207, 201, 0);
  }
  100% {
    box-shadow: 0 0 0 0 rgba(54, 207, 201, 0);
  }
}

.message-templates {
  margin: 8px 0 4px;
}

.status-banner {
  margin-top: 12px;
  border: 1px solid var(--sc-border);
  border-right: 4px solid var(--sc-accent);
  border-radius: var(--sc-radius-lg);
  background: rgba(255, 255, 255, 0.03);
  padding: 12px;
}

.status-line {
  display: flex;
  gap: 8px;
  align-items: center;
  justify-content: space-between;
  flex-wrap: wrap;
}

.status-title {
  margin: 0 0 4px;
  font-size: 13px;
  color: var(--sc-text-soft);
}

.status-text {
  font-size: 14px;
  font-weight: 600;
}

.status-foot {
  margin-top: 8px;
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
  align-items: center;
}

.status-chip {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 4px 10px;
  border-radius: 999px;
  border: 1px solid rgba(56, 189, 248, 0.45);
  background: rgba(56, 189, 248, 0.16);
  font-size: 12px;
}

.status-chip.pending {
  border-color: rgba(250, 140, 22, 0.55);
  background: rgba(250, 140, 22, 0.16);
  color: #ffd591;
}

.status-chip.clear {
  border-color: rgba(82, 196, 26, 0.55);
  background: rgba(82, 196, 26, 0.14);
  color: #d9f7be;
}

.risk-badge {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 4px 10px;
  border: 1px solid var(--sc-border);
  border-radius: 999px;
  font-size: 12px;
}

.risk-badge.critical {
  border-color: rgba(255, 77, 79, 0.6);
  color: var(--sc-critical);
  background: rgba(255, 77, 79, 0.14);
}

.risk-badge.warning {
  border-color: rgba(250, 140, 22, 0.6);
  color: var(--sc-medium);
  background: rgba(250, 140, 22, 0.14);
}

.risk-badge.stable {
  border-color: rgba(82, 196, 26, 0.6);
  color: var(--sc-low);
  background: rgba(82, 196, 26, 0.14);
}

.risk-badge.unknown {
  color: var(--sc-text-soft);
}

.vitals-cards {
  display: grid;
  grid-template-columns: repeat(2, minmax(0, 1fr));
  gap: 12px;
}

.vital-card {
  position: relative;
  border: 1px solid var(--sc-border);
  border-radius: var(--sc-radius-md);
  background: linear-gradient(160deg, rgba(255, 255, 255, 0.06), rgba(255, 255, 255, 0.02));
  box-shadow: 0 8px 24px rgba(0, 0, 0, 0.32), inset 0 1px 0 rgba(255, 255, 255, 0.08);
  padding: 14px;
  overflow: hidden;
}

.vital-card::after {
  content: "";
  position: absolute;
  inset: auto -40px -40px auto;
  width: 120px;
  height: 120px;
  border-radius: 50%;
  background: radial-gradient(circle, rgba(56, 189, 248, 0.2), transparent 70%);
}

.vital-card-hero .vital-value {
  font-size: 32px;
}

.vital-label {
  color: var(--sc-text-soft);
  font-size: 12px;
  position: relative;
  z-index: 1;
}

.vital-value {
  margin-top: 6px;
  font-size: 26px;
  font-weight: 800;
  line-height: 1.1;
  position: relative;
  z-index: 1;
}

.sensor-title {
  margin-top: 14px;
}

.sensor-grid {
  display: grid;
  grid-template-columns: repeat(2, minmax(0, 1fr));
  gap: 12px;
}

.sensor-card {
  --sensor-accent: var(--sc-accent);
  position: relative;
  border: 1px solid rgba(148, 186, 224, 0.35);
  border-radius: var(--sc-radius-md);
  background: linear-gradient(150deg, rgba(255, 255, 255, 0.08), rgba(255, 255, 255, 0.02));
  box-shadow: 0 10px 24px rgba(0, 0, 0, 0.28), inset 0 1px 0 rgba(255, 255, 255, 0.1);
  backdrop-filter: blur(14px);
  padding: 12px;
  transition: transform 0.2s ease, box-shadow 0.2s ease;
}

.sensor-card:hover {
  transform: translateY(-3px);
  box-shadow: 0 14px 28px rgba(0, 0, 0, 0.34), inset 0 1px 0 rgba(255, 255, 255, 0.14);
}

.sensor-card::before {
  content: "";
  position: absolute;
  top: 0;
  bottom: 0;
  right: 0;
  width: 4px;
  border-radius: 999px;
  background: var(--sensor-accent);
}

.sensor-head {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-bottom: 8px;
}

.sensor-dot {
  width: 10px;
  height: 10px;
  border-radius: 50%;
  background: var(--sensor-accent);
  box-shadow: 0 0 0 0 rgba(255, 255, 255, 0.45);
  animation: sensorPulse 1.7s infinite;
}

@keyframes sensorPulse {
  0% {
    box-shadow: 0 0 0 0 rgba(255, 255, 255, 0.4);
  }
  70% {
    box-shadow: 0 0 0 8px rgba(255, 255, 255, 0);
  }
  100% {
    box-shadow: 0 0 0 0 rgba(255, 255, 255, 0);
  }
}

.sensor-name {
  font-size: 14px;
  font-weight: 700;
}

.sensor-reading {
  font-size: 22px;
  font-weight: 800;
  color: var(--sensor-accent);
  margin-bottom: 4px;
}

.sensor-meta {
  font-size: 12px;
  color: var(--sc-text-soft);
}

.sensor-card.type-hr {
  --sensor-accent: #95de64;
}

.sensor-card.type-spo2 {
  --sensor-accent: #69c0ff;
}

.sensor-card.type-temp {
  --sensor-accent: #ff7875;
}

.sensor-card.type-bp {
  --sensor-accent: #b37feb;
}

.sensor-card.is-warning {
  --sensor-accent: #fa8c16;
}

.sensor-card.is-offline {
  --sensor-accent: #ff4d4f;
}

.ai-panel {
  background: linear-gradient(140deg, rgba(56, 189, 248, 0.08), rgba(255, 255, 255, 0.03));
}

.ai-box {
  margin-top: 10px;
  border: 1px solid rgba(255, 255, 255, 0.12);
  border-radius: var(--sc-radius-md);
  background: rgba(255, 255, 255, 0.03);
  padding: 10px;
}

.guide-steps {
  margin-top: 12px;
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.guide-step {
  border: 1px solid rgba(255, 255, 255, 0.12);
  border-radius: var(--sc-radius-md);
  background: rgba(255, 255, 255, 0.03);
  padding: 8px 10px;
  font-size: 12px;
}

.analytics-kpi-grid {
  display: grid;
  gap: var(--sc-space-2);
  grid-template-columns: repeat(4, minmax(0, 1fr));
  margin-bottom: var(--sc-space-3);
}

.analytics-kpi-card {
  border: 1px solid var(--sc-border);
  border-radius: var(--sc-radius-md);
  padding: 10px 12px;
  background:
    radial-gradient(120px 80px at 82% 0%, rgba(56, 189, 248, 0.18), transparent 72%),
    linear-gradient(155deg, rgba(255, 255, 255, 0.07), rgba(255, 255, 255, 0.02));
  box-shadow: 0 8px 18px rgba(2, 12, 24, 0.34);
  position: relative;
  overflow: hidden;
}

.analytics-kpi-card::before {
  content: "";
  position: absolute;
  top: 0;
  right: 0;
  width: 100%;
  height: 3px;
  background: linear-gradient(90deg, rgba(56, 189, 248, 0.1), rgba(56, 189, 248, 0.85), rgba(250, 140, 22, 0.6));
}

.analytics-kpi-title {
  color: var(--sc-text-soft);
  font-size: 12px;
}

.analytics-kpi-value {
  margin-top: 7px;
  font-size: 22px;
  font-weight: 800;
}

.analytics-kpi-sub {
  margin-top: 6px;
  color: var(--sc-text-soft);
  font-size: 12px;
}

.analytics-good {
  color: var(--sc-low);
}

.analytics-warn {
  color: var(--sc-medium);
}

.analytics-critical {
  color: var(--sc-critical);
}

.analytics-layout {
  display: grid;
  gap: var(--sc-space-2);
  grid-template-columns: repeat(2, minmax(0, 1fr));
}

.analytics-panel {
  border: 1px solid rgba(255, 255, 255, 0.12);
  border-radius: var(--sc-radius-md);
  background: linear-gradient(150deg, rgba(255, 255, 255, 0.05), rgba(255, 255, 255, 0.02));
  padding: 10px 12px;
}

.analytics-panel h3 {
  margin: 0 0 8px;
  font-size: 15px;
}

.risk-timeline {
  display: flex;
  align-items: end;
  justify-content: space-between;
  gap: 8px;
  min-height: 126px;
}

.risk-point {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 6px;
  flex: 1;
}

.risk-bar {
  width: 100%;
  min-width: 20px;
  border-radius: 999px;
  border: 1px solid rgba(255, 255, 255, 0.2);
}

.risk-bar.risk-critical {
  background: rgba(255, 77, 79, 0.4);
  border-color: rgba(255, 77, 79, 0.55);
}

.risk-bar.risk-warning {
  background: rgba(250, 140, 22, 0.36);
  border-color: rgba(250, 140, 22, 0.55);
}

.risk-bar.risk-stable {
  background: rgba(82, 196, 26, 0.3);
  border-color: rgba(82, 196, 26, 0.5);
}

.risk-point-day {
  color: var(--sc-text-soft);
  font-size: 11px;
}

.risk-point-value {
  font-size: 11px;
}

.adherence-progress {
  width: 100%;
  height: 9px;
  border-radius: 999px;
  border: 1px solid var(--sc-border);
  background: rgba(255, 255, 255, 0.05);
  overflow: hidden;
  margin: 8px 0;
}

.adherence-progress-fill {
  height: 100%;
  background: linear-gradient(90deg, rgba(255, 77, 79, 0.9), rgba(250, 140, 22, 0.85), rgba(82, 196, 26, 0.9));
  transition: width .35s ease;
}

.empty-hint {
  margin-top: 10px;
  border: 1px dashed rgba(255, 255, 255, 0.2);
  border-radius: var(--sc-radius-md);
  background: rgba(255, 255, 255, 0.02);
  color: var(--sc-text-soft);
  padding: 10px;
  font-size: 12px;
}

.toast {
  position: fixed;
  left: 16px;
  bottom: 16px;
  background: var(--sc-surface-strong);
  color: var(--sc-text);
  border: 1px solid var(--sc-border);
  border-radius: var(--sc-radius-md);
  padding: 10px 12px;
  font-size: 12px;
  display: none;
  z-index: 40;
}

@media (max-width: 1100px) {
  .live-strip {
    grid-template-columns: repeat(2, minmax(0, 1fr));
  }

  .sensor-grid {
    grid-template-columns: 1fr;
  }

  .analytics-kpi-grid {
    grid-template-columns: repeat(2, minmax(0, 1fr));
  }

  .analytics-layout {
    grid-template-columns: 1fr;
  }
}

@media (max-width: 780px) {
  .live-strip {
    grid-template-columns: 1fr;
  }

  .overview-top {
    flex-direction: column;
  }

  .vitals-cards {
    grid-template-columns: 1fr;
  }

  .vital-card-hero .vital-value {
    font-size: 28px;
  }

  .analytics-kpi-grid {
    grid-template-columns: 1fr;
  }
}
</style>
</head>
<body class="sc-page">
<div class="sc-shell">
  <header class="sc-page-header">
    <div class="sc-page-header-main">
      <div class="sc-page-icon">ğŸ“</div>
      <div>
        <h1 class="sc-page-title">Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„Ø·Ø§Ù„Ø¨</h1>
        <p class="sc-page-subtitle">ÙˆØ§Ø¬Ù‡Ø© Ù…Ø¨Ø³Ø·Ø© ØªØ¬Ù…Ø¹ Ø§Ù„Ø¹Ù„Ø§Ù…Ø§Øª Ø§Ù„Ø­ÙŠÙˆÙŠØ©ØŒ Ø·Ù„Ø¨ Ø§Ù„Ø²ÙŠØ§Ø±Ø©ØŒ Ø§Ù„ØªÙˆØ§ØµÙ„ØŒ ÙˆØ§Ù„Ù…Ø³ØªØ´Ø§Ø± Ø§Ù„Ø°ÙƒÙŠ.</p>
      </div>
    </div>
    <div class="sc-header-actions">
      <span class="sc-role-chip">Ø§Ù„Ø¯ÙˆØ± Ø§Ù„Ø­Ø§Ù„ÙŠ: <strong data-session-role>Ø§Ù„Ø·Ø§Ù„Ø¨</strong></span>
      <button class="sc-action-btn" data-action="logout">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
    </div>
  </header>

  <section class="sc-panel student-overview sc-mb-24">
    <div class="overview-top">
      <div>
        <h2 class="sc-panel-title">Ù„ÙˆØ­Ø© Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„ÙÙˆØ±ÙŠØ©</h2>
        <p class="sc-panel-subtitle">Ø§Ø¨Ø¯Ø£ Ø¨Ø§Ù„Ø­Ø³Ø§Ø³Ø§Øª Ø«Ù… Ø§Ù„Ù…Ø³ØªØ´Ø§Ø± Ø§Ù„Ø°ÙƒÙŠØŒ ÙˆØ¨Ø¹Ø¯Ù‡Ø§ Ù†ÙÙ‘Ø° Ø·Ù„Ø¨ Ø§Ù„Ø²ÙŠØ§Ø±Ø© Ø¥Ø°Ø§ Ø§Ø­ØªØ¬Øª.</p>
      </div>
      <div class="portal-meta">
        <div class="meta-item">Ø§Ù„Ù†Ù…Ø·: <strong id="status-mode">-</strong></div>
        <div class="meta-item">Ø¢Ø®Ø± Ù…Ø²Ø§Ù…Ù†Ø©: <strong id="status-sync">-</strong></div>
        <div class="meta-item">Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø®Ø·Ø±: <strong id="status-risk">-</strong></div>
      </div>
    </div>
    <div class="section-nav sc-section-nav">
      <button class="section-btn sc-action-btn" onclick="scrollStudentSection('insights-zone')">Ø±Ø­Ù„Ø© Ø§Ù„ØªØ¹Ø§ÙÙŠ</button>
      <button class="section-btn sc-action-btn" onclick="scrollStudentSection('vitals-zone')">Ø§Ù„Ø­Ø³Ø§Ø³Ø§Øª ÙˆØ§Ù„Ø­ÙŠÙˆÙŠØ©</button>
      <button class="section-btn sc-action-btn" onclick="scrollStudentSection('support-zone')">Ø§Ù„Ù…Ø³ØªØ´Ø§Ø± Ø§Ù„Ø°ÙƒÙŠ</button>
      <button class="section-btn sc-action-btn" onclick="scrollStudentSection('visit-zone')">Ø·Ù„Ø¨ Ø²ÙŠØ§Ø±Ø©</button>
      <button class="section-btn sc-action-btn" onclick="scrollStudentSection('communication-zone')">Ø§Ù„ØªÙˆØ§ØµÙ„ ÙˆØ§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª</button>
    </div>
    <div class="inline-row hero-cta">
      <button class="btn-primary primary-cta" onclick="focusVisitReason()">Ø·Ù„Ø¨ Ø²ÙŠØ§Ø±Ø© Ø§Ù„Ø¢Ù†</button>
      <button class="btn-muted" onclick="focusAiPanel()">Ø§Ø³ØªØ´Ø§Ø±Ø© Ø³Ø±ÙŠØ¹Ø©</button>
      <button class="btn-muted" onclick="openStudentProfile()">ÙØªØ­ Ø§Ù„Ù…Ù„Ù Ø§Ù„ØµØ­ÙŠ</button>
    </div>
    <div class="status-banner">
      <div class="status-line">
        <div>
          <div class="status-title">Ø­Ø§Ù„Ø© Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©</div>
          <div id="latest-case-text" class="status-text">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø£Ø­Ø¯Ø« Ø­Ø§Ù„Ø©...</div>
        </div>
        <span id="latest-case-badge" class="badge b-ok">Ù…Ø³ØªÙ‚Ø±Ø©</span>
      </div>
      <div class="status-foot">
        <span id="current-request-status" class="status-chip">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø²ÙŠØ§Ø±Ø©...</span>
        <span id="current-status-help" class="sc-muted">Ø³Ù†Ø¹Ø±Ø¶ Ù‡Ù†Ø§ Ù…Ø§Ø°Ø§ ØªÙØ¹Ù„ Ø§Ù„Ø¢Ù† Ø­Ø³Ø¨ Ø§Ù„Ø­Ø§Ù„Ø©.</span>
      </div>
    </div>
    <div class="live-strip" aria-live="polite">
      <div class="live-cell">
        <span class="live-label live-signal"><span class="live-dot"></span>ØªØ¯ÙÙ‚ Ù…Ø¨Ø§Ø´Ø±</span>
        <strong class="live-value" id="live-mode">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙ‡ÙŠØ¦Ø©...</strong>
      </div>
      <div class="live-cell">
        <span class="live-label">Ù†Ø¨Ø¶ Ø§Ù„Ù‚Ù„Ø¨</span>
        <strong class="live-value" id="live-hr">-</strong>
      </div>
      <div class="live-cell">
        <span class="live-label">Ø§Ù„Ø£ÙƒØ³Ø¬ÙŠÙ†</span>
        <strong class="live-value" id="live-spo2">-</strong>
      </div>
      <div class="live-cell">
        <span class="live-label">Ø¢Ø®Ø± ØªÙ†Ø¨ÙŠÙ‡</span>
        <strong class="live-value" id="live-alert">-</strong>
      </div>
      <div class="live-cell">
        <span class="live-label">Ø§Ù„Ø¬Ù„Ø³Ø© Ø§Ù„Ù…Ø±Ø¦ÙŠØ©</span>
        <strong class="live-value" id="live-session">ØºÙŠØ± Ù…ØªØ§Ø­Ø©</strong>
      </div>
    </div>
  </section>

  <section id="stats" class="sc-grid-3 sc-kpi-grid sc-mb-24"></section>

  <section id="insights-zone" class="sc-panel sc-mb-24">
    <h2 class="sc-panel-title">ØºØ±ÙØ© Ù‚ÙŠØ§Ø¯Ø© Ø§Ù„Ø·Ø§Ù„Ø¨ Ø§Ù„ØµØ­ÙŠØ©</h2>
    <p class="sc-panel-subtitle">Ù‚Ø±Ø§Ø¡Ø© Ø³Ø±ÙŠØ¹Ø© ØªØ³Ø§Ø¹Ø¯Ùƒ ØªØ¹Ø±Ù Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ø§Ù„Ø£Ù†Ø³Ø¨ Ø§Ù„ÙŠÙˆÙ…: Ù…ØªØ§Ø¨Ø¹Ø©ØŒ Ø·Ù„Ø¨ Ø²ÙŠØ§Ø±Ø©ØŒ Ø£Ùˆ ØªØµØ¹ÙŠØ¯ ÙÙˆØ±ÙŠ.</p>
    <div id="student-analytics-kpis" class="analytics-kpi-grid"></div>
    <div class="analytics-layout">
      <article class="analytics-panel">
        <h3>Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ø¶ØºØ· Ø§Ù„ØµØ­ÙŠ (7 Ø£ÙŠØ§Ù…)</h3>
        <div id="student-risk-timeline" class="risk-timeline"></div>
      </article>
      <article class="analytics-panel">
        <h3>Ø§Ù†Ø¶Ø¨Ø§Ø· Ø§Ù„Ø®Ø·Ø© Ø§Ù„ÙŠÙˆÙ…ÙŠØ©</h3>
        <div id="student-adherence-summary"></div>
      </article>
    </div>
  </section>

  <h2 id="vitals-zone" class="sc-section-title">Ø§Ù„Ø¹Ù„Ø§Ù…Ø§Øª Ø§Ù„Ø­ÙŠÙˆÙŠØ© ÙˆØ§Ù„Ø­Ø³Ø§Ø³Ø§Øª</h2>
  <section class="sc-grid-3 sc-mb-24">
    <article class="sc-panel sc-col-span-2" data-permission="view.student">
      <div class="inline-row" style="justify-content:space-between;align-items:center;margin-bottom:12px;">
        <span id="vt-risk" class="risk-badge unknown">Ø§Ù„Ø­Ø§Ù„Ø©: ØºÙŠØ± Ù…ØªÙˆÙØ±</span>
        <span class="sc-muted">Ø¢Ø®Ø± Ù‚Ø±Ø§Ø¡Ø©: <span id="vt-updated">-</span></span>
      </div>

      <div class="vitals-cards">
        <div class="vital-card vital-card-hero">
          <div class="vital-label">Ù†Ø¨Ø¶ Ø§Ù„Ù‚Ù„Ø¨</div>
          <div class="vital-value" id="vt-hr">-</div>
        </div>
        <div class="vital-card vital-card-hero">
          <div class="vital-label">Ø§Ù„Ø£ÙƒØ³Ø¬ÙŠÙ† SpO2</div>
          <div class="vital-value" id="vt-spo2">-</div>
        </div>
        <div class="vital-card">
          <div class="vital-label">Ø¯Ø±Ø¬Ø© Ø§Ù„Ø­Ø±Ø§Ø±Ø©</div>
          <div class="vital-value" id="vt-temp">-</div>
        </div>
        <div class="vital-card">
          <div class="vital-label">Ø¶ØºØ· Ø§Ù„Ø¯Ù…</div>
          <div class="vital-value" id="vt-bp">-</div>
        </div>
      </div>

      <h3 class="sc-panel-title sensor-title">Ø§Ù„Ø­Ø³Ø§Ø³Ø§Øª Ø§Ù„Ù†Ø´Ø·Ø©</h3>
      <div id="sensor-cards" class="sensor-grid"></div>
    </article>

    <article class="sc-panel ai-panel" id="support-zone" data-permission="use.ai.assistant">
      <h3 class="sc-panel-title">Ù…Ø³ØªØ´Ø§Ø± Ø§Ù„Ø·Ø§Ù„Ø¨ Ø§Ù„Ø°ÙƒÙŠ</h3>
      <p class="sc-panel-subtitle">Ø§ÙƒØªØ¨ Ù…Ø§ ØªØ´Ø¹Ø± Ø¨Ù‡ØŒ ÙˆØ³ÙŠØ¹Ø±Ø¶ Ø§Ù„Ù†Ø¸Ø§Ù… ØªØ­Ù„ÙŠÙ„Ù‹Ø§ Ø³Ø±ÙŠØ¹Ù‹Ø§ Ù…Ø¹ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ù…Ù‚ØªØ±Ø­Ø©.</p>
      <textarea id="ai-student-input" rows="3" placeholder="Ù…Ø«Ø§Ù„: Ø£Ø´Ø¹Ø± Ø¨Ø¶ÙŠÙ‚ ØªÙ†ÙØ³ Ø¨Ø¹Ø¯ Ø§Ù„Ù†Ø´Ø§Ø·..."></textarea>
      <div class="inline-row">
        <button class="btn-primary" onclick="askStudentAi()">ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø­Ø§Ù„Ø©</button>
        <button class="btn-muted" onclick="prefillAiEmergency()">ÙˆØµÙ Ø·Ø§Ø±Ø¦</button>
      </div>
      <div id="ai-student-output" class="ai-box">Ù„Ù… ÙŠØªÙ… ØªØ´ØºÙŠÙ„ Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø¨Ø¹Ø¯.</div>
      <div class="guide-steps">
        <div class="guide-step">1) Ø±Ø§Ù‚Ø¨ Ø§Ù„Ø­Ø³Ø§Ø³Ø§Øª ÙÙŠ Ø§Ù„Ø£Ø¹Ù„Ù‰ Ø£ÙˆÙ„Ù‹Ø§.</div>
        <div class="guide-step">2) Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…Ø³ØªØ´Ø§Ø± Ø§Ù„Ø°ÙƒÙŠ Ø¹Ù†Ø¯ Ø¸Ù‡ÙˆØ± Ø£Ø¹Ø±Ø§Ø¶ Ø¬Ø¯ÙŠØ¯Ø©.</div>
        <div class="guide-step">3) Ø¥Ø°Ø§ Ø§Ù„ØªÙˆØµÙŠØ© Ø¹Ø§Ø¬Ù„Ø©ØŒ Ù†ÙÙ‘Ø° Ø·Ù„Ø¨ Ø§Ù„Ø²ÙŠØ§Ø±Ø© Ù…Ø¨Ø§Ø´Ø±Ø©.</div>
      </div>
    </article>
  </section>

  <h2 id="visit-zone" class="sc-section-title">Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„ÙŠÙˆÙ…ÙŠØ©</h2>
  <section class="sc-grid-3">
    <article class="sc-panel" data-permission="request.visit">
      <h3 class="sc-panel-title">Ø·Ù„Ø¨ Ø²ÙŠØ§Ø±Ø© Ù„Ù„Ø¹ÙŠØ§Ø¯Ø©</h3>
      <p class="sc-panel-subtitle">Ù‡Ø°Ø§ Ù‡Ùˆ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ Ø¹Ù†Ø¯ ÙˆØ¬ÙˆØ¯ Ø£Ø¹Ø±Ø§Ø¶ ØªØ­ØªØ§Ø¬ ÙØ­ØµÙ‹Ø§.</p>
      <select id="visit-priority">
        <option value="normal">Ø¹Ø§Ø¯ÙŠ</option>
        <option value="urgent">Ù…Ø³ØªØ¹Ø¬Ù„</option>
      </select>
      <div class="inline-row" style="margin-top:8px;">
        <button class="btn-muted" type="button" onclick="useVisitTemplate('ØµØ¯Ø§Ø¹ Ø´Ø¯ÙŠØ¯')">ØµØ¯Ø§Ø¹ Ø´Ø¯ÙŠØ¯</button>
        <button class="btn-muted" type="button" onclick="useVisitTemplate('Ø¶ÙŠÙ‚ ØªÙ†ÙØ³ Ù…ØªÙƒØ±Ø±')">Ø¶ÙŠÙ‚ ØªÙ†ÙØ³</button>
        <button class="btn-muted" type="button" onclick="useVisitTemplate('Ø£Ù„Ù… ÙÙŠ Ø§Ù„ØµØ¯Ø± Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ù†Ø´Ø§Ø·')">Ø£Ù„Ù… ØµØ¯Ø±</button>
      </div>
      <textarea id="visit-reason" rows="3" maxlength="220" placeholder="Ø§ÙƒØªØ¨ Ø³Ø¨Ø¨ Ø§Ù„Ø·Ù„Ø¨..." oninput="updateVisitReasonMeta()"></textarea>
      <div class="inline-help">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø³Ø¨Ø¨: <span id="visit-reason-count">0</span>/220</div>
      <button class="btn-primary primary-cta" onclick="requestVisit()">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨</button>
    </article>

    <article class="sc-panel" data-permission="view.student">
      <h3 class="sc-panel-title">Ø§Ù„ØªÙˆØ§ØµÙ„ Ø§Ù„Ø·Ø¨ÙŠ Ø§Ù„Ù…Ø¨Ø§Ø´Ø±</h3>
      <p id="telemed-student-status" class="sc-panel-subtitle">Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø¬Ù„Ø³Ø© Ù…Ø¨Ø§Ø´Ø±Ø©...</p>
      <span id="telemed-student-badge" class="badge b-ok">ØºÙŠØ± Ù†Ø´Ø·Ø©</span>
      <div class="inline-row" style="margin-top:12px;">
        <button class="btn-primary" id="telemed-student-join" onclick="joinStudentTelemed()" disabled>Ø§Ù†Ø¶Ù…Ø§Ù… Ù„Ù„Ø¬Ù„Ø³Ø©</button>
        <button class="btn-muted" onclick="refreshStudentTelemed()">ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø¬Ù„Ø³Ø©</button>
      </div>
      <div class="empty-hint">Ø¥Ø°Ø§ Ù„Ù… ØªÙˆØ¬Ø¯ Ø¬Ù„Ø³Ø© Ù†Ø´Ø·Ø©ØŒ Ø§Ø±Ø³Ù„ Ø·Ù„Ø¨ Ø²ÙŠØ§Ø±Ø© Ù…Ø³ØªØ¹Ø¬Ù„ Ø£Ùˆ ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ø¹ÙŠØ§Ø¯Ø©.</div>
      <div class="inline-help">Ø¹Ù†Ø¯ ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¬Ù„Ø³Ø© Ø³ÙŠØªØºÙŠØ± Ø§Ù„Ù…Ø¤Ø´Ø± Ø§Ù„Ø­ÙŠ Ø£Ø¹Ù„Ù‰ Ø§Ù„ØµÙØ­Ø© Ù…Ø¨Ø§Ø´Ø±Ø©.</div>
    </article>

    <article class="sc-panel" id="communication-zone" data-permission="send.message">
      <h3 class="sc-panel-title">Ø§Ù„Ù…Ø±Ø§Ø³Ù„Ø© ÙˆØ§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª</h3>
      <p class="sc-panel-subtitle">Ø£Ø±Ø³Ù„ Ø±Ø³Ø§Ù„Ø© Ù„Ù„ÙØ±ÙŠÙ‚ Ø§Ù„ØµØ­ÙŠ ÙˆØ±Ø§Ø¬Ø¹ Ø¢Ø®Ø± Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ù…Ù† Ù†ÙØ³ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©.</p>
      <textarea id="message-text" rows="3" maxlength="280" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ..." data-permission="send.message" oninput="updateMessageMeta()"></textarea>
      <div class="inline-row message-templates">
        <button class="btn-muted" type="button" onclick="useMessageTemplate('Ø£Ø­ØªØ§Ø¬ Ù…Ø±Ø§Ø¬Ø¹Ø© Ù‚Ø±Ø§Ø¡Ø§Øª Ø§Ù„ÙŠÙˆÙ….')">Ù…Ø±Ø§Ø¬Ø¹Ø© Ù‚Ø±Ø§Ø¡Ø§Øª</button>
        <button class="btn-muted" type="button" onclick="useMessageTemplate('Ø£Ø·Ù„Ø¨ Ù…ØªØ§Ø¨Ø¹Ø© Ø­Ø§Ù„Ø© Ø§Ù„Ø²ÙŠØ§Ø±Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©.')">Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø²ÙŠØ§Ø±Ø©</button>
        <button class="btn-muted" type="button" onclick="useMessageTemplate('Ø£Ø­ØªØ§Ø¬ ØªÙˆØ§ØµÙ„Ù‹Ø§ Ø¹Ø§Ø¬Ù„Ù‹Ø§ Ù…Ø¹ Ø§Ù„Ø·Ø¨ÙŠØ¨.')">ØªÙˆØ§ØµÙ„ Ø¹Ø§Ø¬Ù„</button>
      </div>
      <div class="inline-help">Ø·ÙˆÙ„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©: <span id="message-count">0</span>/280</div>
      <div class="inline-row">
        <button class="btn-primary" data-permission="send.message" onclick="sendClinicMessage()">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©</button>
        <button class="btn-muted" type="button" onclick="clearMessageComposer()">Ù…Ø³Ø­ Ø§Ù„Ù†Øµ</button>
      </div>
      <select id="alert-filter" onchange="applyAlertFilter()">
        <option value="all">ÙƒÙ„ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª</option>
        <option value="critical">Ø­Ø±Ø¬</option>
        <option value="operational">ØªØ´ØºÙŠÙ„ÙŠ</option>
        <option value="info">Ù…Ø¹Ù„ÙˆÙ…Ø§ØªÙŠ</option>
      </select>
      <div id="alerts-list" class="list"></div>
    </article>

    <article class="sc-panel sc-col-span-3" data-permission="view.reports">
      <div class="two-col">
        <div>
          <h3 class="sc-panel-title">ØªÙ‚Ø§Ø±ÙŠØ±ÙŠ Ø§Ù„ØµØ­ÙŠØ©</h3>
          <p class="sc-panel-subtitle">Ø£Ø­Ø¯Ø« Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ø·Ø¨ÙŠØ© Ø§Ù„Ù…ØªØ§Ø­Ø© Ù„ÙƒØŒ Ù…Ø¹ Ø®ÙŠØ§Ø± Ø§Ù„ØªØµØ¯ÙŠØ±.</p>
          <div id="reports-list" class="list"></div>
          <div class="inline-row">
            <button class="btn-muted" onclick="window.location.href='student-profile.html#reports'">Ø¹Ø±Ø¶ ÙƒÙ„ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</button>
            <button class="btn-muted" data-permission="export.report" onclick="exportStudentReport()">ØªØµØ¯ÙŠØ± Ø§Ù„ØªÙ‚Ø±ÙŠØ±</button>
          </div>
        </div>
        <div>
          <h3 class="sc-panel-title">Ù†ØµÙŠØ­Ø© Ø§Ù„ÙŠÙˆÙ…</h3>
          <p id="tip-text" class="sc-panel-subtitle">Ø¬Ø§Ø±ÙŠ Ø§Ø®ØªÙŠØ§Ø± Ù†ØµÙŠØ­Ø© Ù…Ù†Ø§Ø³Ø¨Ø©...</p>
          <div class="inline-row">
            <button class="btn-primary" onclick="nextTip()">Ù†ØµÙŠØ­Ø© Ø¬Ø¯ÙŠØ¯Ø©</button>
          </div>
          <div class="empty-hint">Ù…Ø§Ø°Ø§ Ø£ÙØ¹Ù„ Ø§Ù„Ø¢Ù†ØŸ Ø§Ø¨Ø¯Ø£ Ø¨Ø§Ù„Ø­Ø³Ø§Ø³Ø§ØªØŒ Ø«Ù… Ø·Ø¨Ù‚ Ù†ØµÙŠØ­Ø© Ø§Ù„ÙŠÙˆÙ…ØŒ Ø«Ù… ØªØ§Ø¨Ø¹ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø£Ùˆ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„.</div>
        </div>
      </div>
    </article>
  </section>
</div>

<div id="toast" class="toast"></div>
<script src="../../assets/js/security.js?v=20260214c"></script>
<script src="../../assets/js/ui-shell.js?v=20260214c"></script>
<script>
var lastOverview = null;
var alertsCache = [];
var tipIndex = 0;
var studentTelemedSessionId = null;
var tips = [
  'Ù†Ø¸Ù‘Ù… Ù†ÙˆÙ…Ùƒ Ø¥Ù„Ù‰ 8 Ø³Ø§Ø¹Ø§Øª ÙŠÙˆÙ…ÙŠÙ‹Ø§ Ù„ØªØ­Ø³ÙŠÙ† Ø§Ù„ØªØ±ÙƒÙŠØ² ÙˆØ§Ù„Ù…Ù†Ø§Ø¹Ø©.',
  'Ø§Ø´Ø±Ø¨ Ø§Ù„Ù…Ø§Ø¡ ÙƒÙ„ Ø³Ø§Ø¹Ø© Ø¯Ø±Ø§Ø³ÙŠØ© Ù„ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„ØµØ¯Ø§Ø¹ ÙˆØ§Ù„Ø¥Ø¬Ù‡Ø§Ø¯.',
  'Ø¥Ø°Ø§ Ø´Ø¹Ø±Øª Ø¨Ø¶ÙŠÙ‚ ØªÙ†ÙØ³ Ù…ØªÙƒØ±Ø±ØŒ Ø§Ø·Ù„Ø¨ Ø²ÙŠØ§Ø±Ø© ÙÙˆØ±ÙŠØ© Ù„Ù„Ø¹ÙŠØ§Ø¯Ø©.',
  'Ù‚Ù„Ù‘Ù„ Ø§Ù„Ù…Ø´Ø±ÙˆØ¨Ø§Øª Ø§Ù„Ø³ÙƒØ±ÙŠØ© ÙˆØ§Ø³ØªØ¨Ø¯Ù„Ù‡Ø§ Ø¨ÙˆØ¬Ø¨Ø§Øª Ø®ÙÙŠÙØ© ØµØ­ÙŠØ©.'
];

function notify(text) {
  var el = document.getElementById('toast');
  el.textContent = text;
  el.style.display = 'block';
  window.setTimeout(function () { el.style.display = 'none'; }, 2200);
}

function fmtDate(value) {
  if (!value) return '-';
  var date = new Date(value);
  if (Number.isNaN(date.getTime())) return '-';
  return date.toLocaleString('ar-SA');
}

function fmtNum(value, digits, suffix) {
  var num = Number(value);
  if (!Number.isFinite(num)) return '-';
  var fixed = typeof digits === 'number' ? num.toFixed(digits) : String(Math.round(num));
  return suffix ? (fixed + suffix) : fixed;
}

function escapeHtml(value) {
  return String(value || '')
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&#039;');
}

function nextTip() {
  tipIndex = (tipIndex + 1) % tips.length;
  document.getElementById('tip-text').textContent = tips[tipIndex];
}

function scrollStudentSection(id) {
  var target = document.getElementById(id);
  if (target) {
    target.scrollIntoView({ behavior: 'smooth', block: 'start' });
  }
}

function focusVisitReason() {
  scrollStudentSection('visit-zone');
  var input = document.getElementById('visit-reason');
  if (input) input.focus();
}

function focusAiPanel() {
  scrollStudentSection('support-zone');
  var input = document.getElementById('ai-student-input');
  if (input) input.focus();
}

function prefillAiEmergency() {
  var input = document.getElementById('ai-student-input');
  input.value = 'Ø£Ø´Ø¹Ø± Ø¨Ø¶ÙŠÙ‚ ØªÙ†ÙØ³ ÙˆØ£Ù„Ù… ÙÙŠ Ø§Ù„ØµØ¯Ø± Ù…Ø¹ Ø¯ÙˆØ®Ø©.';
  input.focus();
}

function statusBadgeClass(severity) {
  if (severity === 'critical' || severity === 'high') return 'b-danger';
  if (severity === 'medium') return 'b-warn';
  return 'b-ok';
}

function severityLabel(value) {
  var map = {
    critical: 'Ø­Ø±Ø¬',
    high: 'Ù…Ø±ØªÙØ¹',
    medium: 'Ù…ØªÙˆØ³Ø·',
    low: 'Ù…Ù†Ø®ÙØ¶',
    stable: 'Ù…Ø³ØªÙ‚Ø±'
  };
  return map[value] || 'Ù…Ø³ØªÙ‚Ø±Ø©';
}

function riskLabel(risk) {
  var map = {
    critical: 'Ø­Ø±Ø¬',
    warning: 'Ù…ØªØ§Ø¨Ø¹Ø©',
    stable: 'Ù…Ø³ØªÙ‚Ø±',
    medium: 'Ù…ØªÙˆØ³Ø·',
    low: 'Ù…Ù†Ø®ÙØ¶',
    unknown: 'ØºÙŠØ± Ù…ØªÙˆÙØ±'
  };
  return map[risk] || map.unknown;
}

function trendTone(direction) {
  if (direction === 'improving') return 'analytics-good';
  if (direction === 'deteriorating') return 'analytics-critical';
  return 'analytics-warn';
}

function adherenceTone(status) {
  if (status === 'excellent' || status === 'good') return 'analytics-good';
  if (status === 'warning') return 'analytics-critical';
  return 'analytics-warn';
}

function riskBarClass(risk) {
  if (risk === 'critical') return 'risk-critical';
  if (risk === 'warning') return 'risk-warning';
  return 'risk-stable';
}

function dayLabelAr(value) {
  var parsed = new Date(String(value || '') + 'T12:00:00Z');
  if (!Number.isFinite(parsed.getTime())) return '-';
  return parsed.toLocaleDateString('ar-SA', { weekday: 'short' });
}

function renderStudentRiskTimeline(points) {
  var wrap = document.getElementById('student-risk-timeline');
  if (!Array.isArray(points) || !points.length) {
    wrap.innerHTML = '<div class="sc-muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø²Ù…Ù†ÙŠØ© ÙƒØ§ÙÙŠØ© Ø¨Ø¹Ø¯.</div>';
    return;
  }
  wrap.innerHTML = points.slice(-7).map(function (point) {
    var score = Math.max(0, Math.min(100, Number(point.score || 0)));
    var height = Math.max(18, Math.round((score / 100) * 92));
    var risk = String(point.risk || 'stable');
    return '<div class="risk-point">' +
      '<div class="risk-bar ' + riskBarClass(risk) + '" style="height:' + height + 'px"></div>' +
      '<div class="risk-point-day">' + dayLabelAr(point.date) + '</div>' +
      '<div class="risk-point-value">' + score + '</div>' +
    '</div>';
  }).join('');
}

function renderStudentAdherenceSummary(adherence, visits) {
  var wrap = document.getElementById('student-adherence-summary');
  var hasPercent = adherence && adherence.percent !== null && adherence.percent !== undefined && Number.isFinite(Number(adherence.percent));
  var percent = hasPercent ? Number(adherence.percent) : null;
  var barWidth = percent === null ? 8 : Math.max(4, Math.min(100, Math.round(percent)));
  var html = '';
  html += '<div class="item">';
  html += '<strong>Ø§Ù†Ø¶Ø¨Ø§Ø· Ø§Ù„Ø¯ÙˆØ§Ø¡:</strong> ' + (percent === null ? 'ØºÙŠØ± Ù…ÙØ¹Ù‘Ù„' : (Math.round(percent) + '%'));
  html += '<div class="adherence-progress"><div class="adherence-progress-fill" style="width:' + barWidth + '%"></div></div>';
  html += '<div class="item-meta">Ø§Ù„Ù…ØªÙˆÙ‚Ø¹: ' + Number((adherence && adherence.expectedDoses) || 0) + ' â€¢ Ø§Ù„Ù…Ø£Ø®ÙˆØ°: ' + Number((adherence && adherence.takenDoses) || 0) + ' â€¢ Ø§Ù„Ù…ØªØ¬Ø§ÙˆØ²: ' + Number((adherence && adherence.skippedDoses) || 0) + '</div>';
  html += '</div>';
  html += '<div class="item"><strong>Ø¢Ø®Ø± Ù…Ø±Ø§Ø¬Ø¹Ø© Ù…ÙƒØªÙ…Ù„Ø©:</strong> ' + fmtDate(visits && visits.lastVisitAt) + '</div>';
  html += '<div class="item"><strong>Ø§Ù„Ù…ÙˆØ¹Ø¯ Ø§Ù„Ù‚Ø§Ø¯Ù…:</strong> ' + fmtDate(visits && visits.nextVisitAt) + '</div>';
  if (adherence && adherence.alert) {
    html += '<div class="item"><strong>ØªÙ†Ø¨ÙŠÙ‡ Ø¯ÙˆØ§Ø¦ÙŠ:</strong> ' + escapeHtml(adherence.alert) + '</div>';
  }
  wrap.innerHTML = html;
}

function studentNextAction(condition, adherence, risk) {
  var direction = String((condition && condition.direction) || '');
  var highDays = Number((risk && risk.highDays) || 0);
  var adherenceStatus = String((adherence && adherence.status) || '');
  if (direction === 'deteriorating' || highDays >= 2) {
    return 'Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ø§Ù„Ø¢Ù†: Ø§Ø·Ù„Ø¨ Ø²ÙŠØ§Ø±Ø© Ù…Ø³ØªØ¹Ø¬Ù„Ø© Ø«Ù… Ø£Ø¨Ù„Øº Ø§Ù„Ø¹ÙŠØ§Ø¯Ø© Ø¨Ø±Ø³Ø§Ù„Ø© Ù…Ø®ØªØµØ±Ø©.';
  }
  if (adherenceStatus === 'warning') {
    return 'Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ø§Ù„Ø¢Ù†: Ø«Ø¨Ù‘Øª Ù…ÙˆØ§Ø¹ÙŠØ¯ Ø§Ù„Ø¬Ø±Ø¹Ø§Øª Ø§Ù„ÙŠÙˆÙ… ÙˆÙØ¹Ù‘Ù„ ØªØ°ÙƒÙŠØ± Ù‚Ø¨Ù„ Ø§Ù„Ø¬Ø±Ø¹Ø© Ø§Ù„Ù‚Ø§Ø¯Ù…Ø©.';
  }
  return 'Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ø§Ù„Ø¢Ù†: Ø§Ø³ØªÙ…Ø± Ø¨Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø¯ÙˆØ±ÙŠØ© ÙˆÙ„Ø§Ø­Ø¸ Ø£ÙŠ ØªØºÙŠØ± ØºÙŠØ± Ù…Ø¹ØªØ§Ø¯.';
}

function renderStudentAnalytics(payload) {
  var analytics = (payload && payload.parentAnalytics) || {};
  var visits = analytics.visits || {};
  var condition = analytics.condition || {};
  var adherence = analytics.adherence || {};
  var risk = analytics.riskIndicators || {};
  var hasPercent = adherence && adherence.percent !== null && adherence.percent !== undefined && Number.isFinite(Number(adherence.percent));
  var adherencePercent = hasPercent ? Number(adherence.percent) : null;
  var cards = [
    {
      title: 'Ø¥ÙŠÙ‚Ø§Ø¹ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©',
      value: String(Number(visits.total || 0)),
      subtitle: 'Ù…ÙƒØªÙ…Ù„: ' + Number(visits.completed || 0) + ' â€¢ Ù‚ÙŠØ¯ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©: ' + Number(visits.pending || 0),
      tone: ''
    },
    {
      title: 'Ø§ØªØ¬Ø§Ù‡ Ø§Ù„ØªØ¹Ø§ÙÙŠ',
      value: escapeHtml(condition.label || 'ØºÙŠØ± Ù…ØªÙˆÙØ±'),
      subtitle: escapeHtml(condition.summary || 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª ÙƒØ§ÙÙŠØ©'),
      tone: trendTone(condition.direction)
    },
    {
      title: 'Ø§Ù†Ø¶Ø¨Ø§Ø· Ø§Ù„Ø®Ø·Ø©',
      value: adherencePercent === null ? 'ØºÙŠØ± Ù…ÙØ¹Ù‘Ù„' : (String(Math.round(adherencePercent)) + '%'),
      subtitle: 'Ø§Ù„ØªÙ‚ÙŠÙŠÙ…: ' + escapeHtml(adherence.statusLabel || 'ØºÙŠØ± Ù…ØªÙˆÙØ±'),
      tone: adherenceTone(adherence.status)
    },
    {
      title: 'Ø¶ØºØ· Ø£Ø³Ø¨ÙˆØ¹ÙŠ Ù…Ø±ØªÙØ¹',
      value: String(Number(risk.highDays || 0)) + ' ÙŠÙˆÙ…',
      subtitle: 'Ù…ØªÙˆØ³Ø· Ø§Ù„Ø¶ØºØ·: ' + Number(risk.averageScore || 0),
      tone: Number(risk.highDays || 0) > 0 ? 'analytics-critical' : 'analytics-good'
    }
  ];
  document.getElementById('student-analytics-kpis').innerHTML = cards.map(function (card) {
    var tone = card.tone ? ' ' + card.tone : '';
    return '<article class="analytics-kpi-card">' +
      '<div class="analytics-kpi-title">' + card.title + '</div>' +
      '<div class="analytics-kpi-value' + tone + '">' + card.value + '</div>' +
      '<div class="analytics-kpi-sub">' + card.subtitle + '</div>' +
    '</article>';
  }).join('');
  renderStudentRiskTimeline(analytics.riskTimeline || []);
  renderStudentAdherenceSummary(adherence, visits);
  var summaryWrap = document.getElementById('student-adherence-summary');
  if (summaryWrap) {
    summaryWrap.innerHTML += '<div class="item"><strong>' + studentNextAction(condition, adherence, risk) + '</strong></div>';
  }
}

function refreshHeroMeta(overview) {
  var risk = (((overview || {}).snapshot || {}).latestVitalsRisk) || 'unknown';
  var liveMode = document.getElementById('live-mode');
  document.getElementById('status-mode').textContent = SmartClinicSecurity.isDemoMode() ? 'Demo' : 'Live';
  document.getElementById('status-sync').textContent = new Date().toLocaleTimeString('ar-SA');
  document.getElementById('status-risk').textContent = riskLabel(risk);
  if (liveMode) {
    liveMode.textContent = SmartClinicSecurity.isDemoMode() ? 'Ù…Ø­Ø§ÙƒØ§Ø© ØªØ¯Ø±ÙŠØ¨ÙŠØ©' : 'Ù…Ø±Ø§Ù‚Ø¨Ø© Ù…Ø¨Ø§Ø´Ø±Ø©';
  }
}

function updateCurrentStatus(snapshot, analytics) {
  var s = snapshot || {};
  var a = analytics || {};
  var condition = a.condition || {};
  var pending = Number(s.pendingVisits || 0);
  var chip = document.getElementById('current-request-status');
  var help = document.getElementById('current-status-help');

  if (condition.direction === 'deteriorating' && pending === 0) {
    chip.className = 'status-chip pending';
    chip.textContent = 'Ø§ØªØ¬Ø§Ù‡ Ø§Ù„Ø­Ø§Ù„Ø© ÙŠØ­ØªØ§Ø¬ ØªØ¯Ø®Ù„Ù‹Ø§ Ø£Ø³Ø±Ø¹';
    help.textContent = 'ÙŠÙˆØµÙ‰ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø·Ù„Ø¨ Ø²ÙŠØ§Ø±Ø© Ù…Ø³ØªØ¹Ø¬Ù„ Ø£Ùˆ Ø§Ù„ØªÙˆØ§ØµÙ„ Ø§Ù„ÙÙˆØ±ÙŠ Ù…Ø¹ Ø§Ù„Ø¹ÙŠØ§Ø¯Ø©.';
    return;
  }

  if (pending > 0) {
    chip.className = 'status-chip pending';
    chip.textContent = 'Ù„Ø¯ÙŠÙƒ ' + pending + ' Ø·Ù„Ø¨ Ø²ÙŠØ§Ø±Ø© Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©';
    help.textContent = 'ØªØ§Ø¨Ø¹ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø£Ùˆ Ø§ÙØªØ­ Ø§Ù„Ø¬Ù„Ø³Ø© Ø§Ù„Ù…Ø±Ø¦ÙŠØ© Ø¥Ø°Ø§ Ø£ØµØ¨Ø­Øª Ù…ØªØ§Ø­Ø©.';
    return;
  }

  chip.className = 'status-chip clear';
  chip.textContent = 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ù…Ø¹Ù„Ù‚Ø©';
  help.textContent = 'Ø¥Ø°Ø§ Ø¸Ù‡Ø±Øª Ø£Ø¹Ø±Ø§Ø¶ Ø¬Ø¯ÙŠØ¯Ø© Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…Ø³ØªØ´Ø§Ø± Ø§Ù„Ø°ÙƒÙŠ Ø«Ù… Ø£Ø±Ø³Ù„ Ø·Ù„Ø¨ Ø²ÙŠØ§Ø±Ø©.';
}

function renderStats(snapshot) {
  var s = snapshot || {};
  var items = [
    ['Ø§Ù„Ø­Ø§Ù„Ø§Øª', Number(s.openCases || 0)],
    ['Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯/Ø§Ù„Ø·Ù„Ø¨Ø§Øª', Number(s.pendingVisits || 0)],
    ['Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª', Number(s.alerts || 0)]
  ];
  document.getElementById('stats').innerHTML = items.map(function (it) {
    return '<article class="sc-kpi-card"><div class="sc-kpi-label">' + it[0] + '</div><div class="sc-kpi-value">' + it[1] + '</div></article>';
  }).join('');
}

function renderLatestCase(item) {
  if (!item) {
    document.getElementById('latest-case-text').textContent = 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø§Ù„Ø§Øª Ù†Ø´Ø·Ø© Ø§Ù„Ø¢Ù†. Ø§Ø³ØªÙ…Ø± ÙÙŠ Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø­Ø³Ø§Ø³Ø§Øª.';
    document.getElementById('latest-case-badge').textContent = 'Ù…Ø³ØªÙ‚Ø±Ø©';
    document.getElementById('latest-case-badge').className = 'badge b-ok';
    return;
  }
  document.getElementById('latest-case-text').textContent = (item.title || 'Ø­Ø§Ù„Ø© ØµØ­ÙŠØ©') + ' â€¢ Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«: ' + fmtDate(item.updatedAt);
  document.getElementById('latest-case-badge').textContent = severityLabel(item.severity || 'low');
  document.getElementById('latest-case-badge').className = 'badge ' + statusBadgeClass(item.severity);
}

function sensorCardType(type) {
  var val = String(type || '').toLowerCase();
  if (val === 'hr') return 'type-hr';
  if (val === 'spo2') return 'type-spo2';
  if (val === 'temp') return 'type-temp';
  if (val === 'bp') return 'type-bp';
  return '';
}

function sensorCardState(sensor) {
  var status = String((sensor && sensor.status) || '').toLowerCase();
  var battery = Number(sensor && sensor.battery);
  if (status === 'disconnected' || status === 'offline' || status === 'inactive' || status === 'error') {
    return 'is-offline';
  }
  if (Number.isFinite(battery) && battery < 25) {
    return 'is-warning';
  }
  return 'is-online';
}

function renderSensors(sensors) {
  var wrap = document.getElementById('sensor-cards');
  if (!Array.isArray(sensors) || !sensors.length) {
    wrap.innerHTML = '<div class="empty-hint">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø³Ø§Ø³Ø§Øª Ù…Ø±ØªØ¨Ø·Ø©. Ù…Ø§Ø°Ø§ Ø£ÙØ¹Ù„ Ø§Ù„Ø¢Ù†ØŸ Ø±Ø§Ø¬Ø¹ Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„ØµØ­ÙŠ Ù„Ø±Ø¨Ø· Ø§Ù„Ø¬Ù‡Ø§Ø².</div>';
    return;
  }

  wrap.innerHTML = sensors.map(function (s) {
    var tone = sensorCardState(s);
    var typeClass = sensorCardType(s.type);
    var battery = fmtNum(s.battery, 0, '%');
    var status = escapeHtml(s.status || 'unknown');
    return '<article class="sensor-card ' + typeClass + ' ' + tone + '">' +
      '<div class="sensor-head"><span class="sensor-dot"></span><span class="sensor-name">' + escapeHtml(s.label || 'Ø­Ø³Ø§Ø³') + '</span></div>' +
      '<div class="sensor-reading">' + battery + '</div>' +
      '<div class="sensor-meta">Ø§Ù„Ø­Ø§Ù„Ø©: ' + status + '</div>' +
      '<div class="sensor-meta">Ø¢Ø®Ø± ØªÙˆØ§ØµÙ„: ' + escapeHtml(fmtDate(s.lastSeenAt)) + '</div>' +
    '</article>';
  }).join('');
}

function renderVitals(data) {
  var latest = data && data.latestVitals ? data.latestVitals : null;
  var risk = latest ? (latest.risk || 'unknown') : 'unknown';
  var riskEl = document.getElementById('vt-risk');
  riskEl.className = 'risk-badge ' + risk;
  riskEl.textContent = 'Ø§Ù„Ø­Ø§Ù„Ø©: ' + riskLabel(risk);
  document.getElementById('vt-updated').textContent = latest ? fmtDate(latest.measuredAt) : '-';
  document.getElementById('vt-temp').textContent = latest ? fmtNum(latest.temp, 1, 'Â°C') : '-';
  document.getElementById('vt-spo2').textContent = latest ? fmtNum(latest.spo2, 0, '%') : '-';
  document.getElementById('vt-hr').textContent = latest ? fmtNum(latest.hr, 0, ' bpm') : '-';
  document.getElementById('vt-bp').textContent = latest ? (fmtNum(latest.bpSys, 0) + '/' + fmtNum(latest.bpDia, 0) + ' mmHg') : '-';
  renderSensors((data && data.sensors) || []);
}

function renderAlerts(items) {
  var wrap = document.getElementById('alerts-list');
  if (!items || !items.length) {
    wrap.innerHTML = '<div class="item">Ù„Ø§ ØªÙˆØ¬Ø¯ ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø¬Ø¯ÙŠØ¯Ø©. Ù…Ø§Ø°Ø§ Ø£ÙØ¹Ù„ Ø§Ù„Ø¢Ù†ØŸ Ø§Ø³ØªÙ…Ø± Ø¨Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø­Ø³Ø§Ø³Ø§Øª ÙˆÙ†ØµÙŠØ­Ø© Ø§Ù„ÙŠÙˆÙ….</div>';
    return;
  }
  wrap.innerHTML = items.slice(0, 4).map(function (a) {
    var when = a.createdAt ? new Date(a.createdAt).toLocaleString('ar-SA') : '-';
    return '<div class="item"><strong>' + (a.text || 'ØªÙ†Ø¨ÙŠÙ‡') + '</strong><div style="color:#bfd5e6;font-size:12px;">' + when + '</div></div>';
  }).join('');
}

function applyAlertFilter() {
  var mode = document.getElementById('alert-filter') ? document.getElementById('alert-filter').value : 'all';
  var filtered = alertsCache.slice();
  if (mode === 'critical' || mode === 'operational' || mode === 'info') {
    filtered = filtered.filter(function (a) { return (a.type || 'info') === mode; });
  }
  renderAlerts(filtered);
}

function renderReports(items) {
  var wrap = document.getElementById('reports-list');
  if (!items || !items.length) {
    wrap.innerHTML = '<div class="item">Ù„Ø§ ØªÙˆØ¬Ø¯ ØªÙ‚Ø§Ø±ÙŠØ± Ù…ØªØ§Ø­Ø© Ø­Ø§Ù„ÙŠÙ‹Ø§. ÙŠÙ…ÙƒÙ†Ùƒ Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ù‚ÙŠØ§Ø³Ø§Øª Ø«Ù… Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ø§Ø­Ù‚Ù‹Ø§.</div>';
    return;
  }
  wrap.innerHTML = items.slice(0, 4).map(function (r) {
    var when = r.createdAt ? new Date(r.createdAt).toLocaleDateString('ar-SA') : '-';
    return '<div class="item"><strong>' + (r.title || 'ØªÙ‚Ø±ÙŠØ± ØµØ­ÙŠ') + '</strong><div style="color:#bfd5e6;font-size:12px;">' + when + '</div></div>';
  }).join('');
}

function trimText(value, max) {
  var text = String(value || '').trim();
  if (!text) return '-';
  if (text.length <= max) return text;
  return text.slice(0, max - 1) + 'â€¦';
}

function renderLiveStrip(data) {
  var latest = data && data.latestVitals ? data.latestVitals : null;
  var alerts = (data && data.alerts) || [];
  document.getElementById('live-hr').textContent = latest ? fmtNum(latest.hr, 0, ' bpm') : '-';
  document.getElementById('live-spo2').textContent = latest ? fmtNum(latest.spo2, 0, '%') : '-';
  if (!alerts.length) {
    document.getElementById('live-alert').textContent = 'Ù„Ø§ ÙŠÙˆØ¬Ø¯';
  } else {
    document.getElementById('live-alert').textContent = trimText(alerts[0].text || alerts[0].type || 'ØªÙ†Ø¨ÙŠÙ‡ Ø¬Ø¯ÙŠØ¯', 20);
  }
}

async function loadOverview() {
  var result = await SmartClinicSecurity.apiJson('/student/overview');
  if (!result.ok || !result.data) {
    notify(result.error === 'request_timeout' ? 'Ø§Ù†ØªÙ‡Øª Ù…Ù‡Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.' : 'ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ø§Ù„Ø¨.');
    await refreshStudentTelemed();
    return;
  }
  lastOverview = result.data;
  renderStats(result.data.snapshot || {});
  renderLatestCase(result.data.latestCase || null);
  renderStudentAnalytics(result.data || {});
  refreshHeroMeta(result.data);
  updateCurrentStatus(result.data.snapshot || {}, result.data.parentAnalytics || {});
  renderVitals(result.data || {});
  alertsCache = result.data.alerts || [];
  applyAlertFilter();
  renderReports(result.data.reports || []);
  renderLiveStrip(result.data || {});
  await refreshStudentTelemed();
}

async function refreshStudentTelemed() {
  var session = await SmartClinicSecurity.getLatestTelemedSession({
    role: 'student'
  });
  var status = document.getElementById('telemed-student-status');
  var joinBtn = document.getElementById('telemed-student-join');
  var liveSession = document.getElementById('live-session');

  if (!session) {
    studentTelemedSessionId = null;
    status.textContent = 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¬Ù„Ø³Ø© Ù…Ø¨Ø§Ø´Ø±Ø© Ù†Ø´Ø·Ø© Ø§Ù„Ø¢Ù†.';
    document.getElementById('telemed-student-badge').className = 'badge b-warn';
    document.getElementById('telemed-student-badge').textContent = 'ØºÙŠØ± Ù†Ø´Ø·Ø©';
    joinBtn.disabled = true;
    if (liveSession) {
      liveSession.textContent = 'ØºÙŠØ± Ù…ØªØ§Ø­Ø©';
    }
    return;
  }

  studentTelemedSessionId = session.id;
  var when = session.createdAt ? new Date(session.createdAt).toLocaleTimeString('ar-SA') : '-';
  status.textContent = 'Ø¬Ù„Ø³Ø© Ù…ØªØ§Ø­Ø© Ø§Ù„Ø¢Ù† â€¢ Ø¨Ø¯Ø£Øª Ø¹Ù†Ø¯ ' + when;
  document.getElementById('telemed-student-badge').className = 'badge b-ok';
  document.getElementById('telemed-student-badge').textContent = 'Ù†Ø´Ø·Ø© Ø§Ù„Ø¢Ù†';
  joinBtn.disabled = false;
  if (liveSession) {
    liveSession.textContent = 'Ù†Ø´Ø·Ø© Ø§Ù„Ø¢Ù†';
  }
}

async function joinStudentTelemed() {
  if (!studentTelemedSessionId) {
    await refreshStudentTelemed();
    notify('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¬Ù„Ø³Ø© Ù…Ø±Ø¦ÙŠØ© Ù…ØªØ§Ø­Ø© Ø­Ø§Ù„ÙŠÙ‹Ø§.');
    return;
  }
  var invite = await SmartClinicSecurity.createTelemedInvite(studentTelemedSessionId, 'student');
  if (!invite.ok || !invite.item || !invite.item.token) {
    notify('ØªØ¹Ø°Ø± Ø¥Ù†Ø´Ø§Ø¡ Ø±Ø§Ø¨Ø· Ø¯Ø®ÙˆÙ„ Ø¢Ù…Ù† Ù„Ù„Ø¬Ù„Ø³Ø©.');
    return;
  }
  window.location.href = SmartClinicSecurity.getTelemedRoomPath(studentTelemedSessionId, invite.item.token);
}

function downloadTextFile(filename, text) {
  var blob = new Blob([String(text || '')], { type: 'text/plain;charset=utf-8' });
  var url = URL.createObjectURL(blob);
  var link = document.createElement('a');
  link.href = url;
  link.download = filename;
  document.body.appendChild(link);
  link.click();
  link.remove();
  URL.revokeObjectURL(url);
}

function openStudentProfile() {
  var target = 'student-profile.html';
  var latest = lastOverview && lastOverview.latestCase ? lastOverview.latestCase : null;
  if (latest && latest.id) {
    target += '?caseId=' + encodeURIComponent(latest.id);
  }
  window.location.href = target;
}

async function exportStudentReport() {
  var reportId = '';
  if (lastOverview && Array.isArray(lastOverview.reports) && lastOverview.reports.length) {
    reportId = String(lastOverview.reports[0].id || '');
  }
  var result = await SmartClinicSecurity.apiJson('/reports/export', {
    method: 'POST',
    body: JSON.stringify(reportId ? { reportId: reportId } : {})
  });
  if (!result.ok || !result.data) {
    notify(result.error || 'ØªØ¹Ø°Ø± ØªØµØ¯ÙŠØ± Ø§Ù„ØªÙ‚Ø±ÙŠØ±.');
    return;
  }
  var snapshot = (lastOverview && lastOverview.snapshot) || {};
  var latestCase = (lastOverview && lastOverview.latestCase) || {};
  var analytics = (lastOverview && lastOverview.parentAnalytics) || {};
  var visits = analytics.visits || {};
  var condition = analytics.condition || {};
  var adherence = analytics.adherence || {};
  var risk = analytics.riskIndicators || {};
  var filename = String((result.data.filename || 'student-report').replace(/\.pdf$/i, ''));
  var body = [
    'Smart Clinic Student Portal Export',
    'Generated At: ' + new Date().toISOString(),
    'Open Cases: ' + Number(snapshot.openCases || 0),
    'Critical Cases: ' + Number(snapshot.criticalCases || 0),
    'Pending Visits: ' + Number(snapshot.pendingVisits || 0),
    'Alerts: ' + Number(snapshot.alerts || 0),
    'Follow-up Rhythm: ' + Number(visits.total || 0),
    'Recovery Trend: ' + String(condition.label || '-'),
    'Recovery Summary: ' + String(condition.summary || '-'),
    'Plan Discipline: ' + (adherence && adherence.percent !== null && adherence.percent !== undefined && Number.isFinite(Number(adherence.percent)) ? (Math.round(Number(adherence.percent)) + '%') : 'inactive'),
    'High Pressure Days (7d): ' + Number(risk.highDays || 0),
    'Latest Case: ' + (latestCase.title || '-') + ' | ' + (latestCase.severity || '-') + ' | ' + (latestCase.updatedAt ? new Date(latestCase.updatedAt).toLocaleString('ar-SA') : '-')
  ].join('\n');
  downloadTextFile(filename + '-portal.txt', body);
  notify(result.data.message || 'ØªÙ… ØªØ¬Ù‡ÙŠØ² Ø§Ù„ØªÙ‚Ø±ÙŠØ±.');
}

function updateVisitReasonMeta() {
  var text = document.getElementById('visit-reason').value || '';
  document.getElementById('visit-reason-count').textContent = String(text.trim().length);
}

function useVisitTemplate(text) {
  document.getElementById('visit-reason').value = text || '';
  updateVisitReasonMeta();
}

function updateMessageMeta() {
  var text = document.getElementById('message-text').value || '';
  document.getElementById('message-count').textContent = String(text.trim().length);
}

function clearMessageComposer() {
  document.getElementById('message-text').value = '';
  updateMessageMeta();
}

function useMessageTemplate(text) {
  document.getElementById('message-text').value = text || '';
  updateMessageMeta();
}

function localStudentAiFallback(text) {
  var t = String(text || '');
  var emergency = t.includes('ØµØ¯Ø±') || t.includes('ØªÙ†ÙØ³') || t.includes('Ø¥ØºÙ…Ø§Ø¡') || t.includes('Ø¯ÙˆØ®Ø©');
  if (emergency) {
    return {
      risk: 'critical',
      triggers: ['Ø±ØµØ¯ ÙƒÙ„Ù…Ø§Øª Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ø£Ø¹Ø±Ø§Ø¶ Ø­Ø±Ø¬Ø© ÙÙŠ Ø§Ù„ÙˆØµÙ'],
      actions: ['Ø£Ø±Ø³Ù„ Ø·Ù„Ø¨ Ø²ÙŠØ§Ø±Ø© Ù…Ø³ØªØ¹Ø¬Ù„ Ø§Ù„Ø¢Ù†', 'Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø¹Ø±Ø¶ Ø´Ø¯ÙŠØ¯Ù‹Ø§ØŒ ØªÙˆØ¬Ù‡ ÙÙˆØ±Ù‹Ø§ Ù„Ù„Ø¹ÙŠØ§Ø¯Ø© Ø£Ùˆ Ø§Ù„Ø·ÙˆØ§Ø±Ø¦']
    };
  }
  return {
    risk: 'low',
    triggers: ['Ø§Ù„ÙˆØµÙ Ù„Ø§ ÙŠØªØ¶Ù…Ù† Ù…Ø¤Ø´Ø±Ø§Øª Ø·Ø§Ø±Ø¦Ø© ÙˆØ§Ø¶Ø­Ø©'],
    actions: ['Ø±Ø§Ù‚Ø¨ Ø§Ù„Ø¹Ù„Ø§Ù…Ø§Øª Ø§Ù„Ø­ÙŠÙˆÙŠØ© Ø®Ù„Ø§Ù„ Ø§Ù„Ø³Ø§Ø¹Ø© Ø§Ù„Ù‚Ø§Ø¯Ù…Ø©', 'Ø§Ø­Ø¬Ø² Ø²ÙŠØ§Ø±Ø© Ø¹Ø§Ø¯ÙŠØ© Ø¥Ø°Ø§ Ø§Ø³ØªÙ…Ø± Ø§Ù„Ø¹Ø±Ø¶']
  };
}

function renderStudentAi(item) {
  if (!item) {
    document.getElementById('ai-student-output').textContent = 'ØªØ¹Ø°Ø± Ø¹Ø±Ø¶ Ù†ØªÙŠØ¬Ø© Ø§Ù„ØªØ­Ù„ÙŠÙ„.';
    return;
  }
  var risk = String(item.risk || '').toLowerCase();
  var riskText = risk === 'critical' ? 'Ø­Ø±Ø¬' : (risk === 'medium' ? 'Ù…ØªÙˆØ³Ø·' : 'Ù…Ù†Ø®ÙØ¶');
  var actions = (item.actions || []).map(function (a) { return '<div class="item">â€¢ ' + escapeHtml(a) + '</div>'; }).join('');
  var triggers = (item.triggers || []).map(function (t) { return '<div class="item">' + escapeHtml(t) + '</div>'; }).join('');
  document.getElementById('ai-student-output').innerHTML =
    '<div><strong>Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø®Ø·ÙˆØ±Ø©: ' + riskText + '</strong></div>' +
    '<div style="margin-top:6px;color:#bfd5e6;">Ù…Ø³Ø¨Ø¨Ø§Øª Ø§Ù„ØªÙ‚ÙŠÙŠÙ…</div>' + (triggers || '<div class="item">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø³Ø¨Ø¨Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©.</div>') +
    '<div style="margin-top:6px;color:#bfd5e6;">Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ù…Ù‚ØªØ±Ø­Ø©</div>' + (actions || '<div class="item">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ù…Ù‚ØªØ±Ø­Ø©.</div>');
}

async function askStudentAi() {
  var text = document.getElementById('ai-student-input').value.trim();
  if (!text) {
    notify('Ø§ÙƒØªØ¨ ÙˆØµÙ Ø§Ù„Ø­Ø§Ù„Ø© Ø£ÙˆÙ„Ù‹Ø§.');
    return;
  }

  var result = await SmartClinicSecurity.apiJson('/ai/student-support', {
    method: 'POST',
    body: JSON.stringify({ text: text })
  });
  if (!result.ok || !result.data) {
    renderStudentAi(localStudentAiFallback(text));
    notify('ØªÙ… ØªÙ‚Ø¯ÙŠÙ… ØªÙˆØµÙŠØ© Ù…Ø¨Ø¯Ø¦ÙŠØ© (Ø¨Ø¯ÙˆÙ† Ø§ØªØµØ§Ù„ ÙƒØ§Ù…Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…).');
    return;
  }
  renderStudentAi(result.data.item || null);
  notify('ØªÙ… ØªÙˆÙ„ÙŠØ¯ ØªÙˆØµÙŠØ© AI Ù„Ù„Ø·Ø§Ù„Ø¨.');
}

async function requestVisit() {
  var priority = document.getElementById('visit-priority').value;
  var reason = document.getElementById('visit-reason').value.trim();
  if (!reason || reason.length < 5) {
    notify('Ø§ÙƒØªØ¨ Ø³Ø¨Ø¨Ù‹Ø§ Ø£ÙˆØ¶Ø­ (5 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„).');
    return;
  }

  var result = await SmartClinicSecurity.apiJson('/visit-requests', {
    method: 'POST',
    body: JSON.stringify({ reason: '[' + priority + '] ' + reason })
  });
  if (!result.ok) {
    notify(result.error || 'ØªØ¹Ø°Ø± Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨.');
    return;
  }
  document.getElementById('visit-reason').value = '';
  updateVisitReasonMeta();
  notify('ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø§Ù„Ø²ÙŠØ§Ø±Ø© Ø¨Ù†Ø¬Ø§Ø­.');
  loadOverview();
}

async function sendClinicMessage() {
  var text = document.getElementById('message-text').value.trim();
  if (!text) {
    notify('Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø© Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„.');
    return;
  }

  var result = await SmartClinicSecurity.apiJson('/messages', {
    method: 'POST',
    body: JSON.stringify({ text: text })
  });
  if (!result.ok) {
    notify(result.error || 'ÙØ´Ù„ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©.');
    return;
  }
  document.getElementById('message-text').value = '';
  updateMessageMeta();
  notify('ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù„Ù„ÙØ±ÙŠÙ‚ Ø§Ù„ØµØ­ÙŠ.');
}

window.addEventListener('DOMContentLoaded', function () {
  SmartClinicSecurity.requireAccess(['student', 'admin'], 'Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„Ø·Ø§Ù„Ø¨');
  if (window.SmartClinicUI) {
    SmartClinicUI.mountQuickNav({
      afterSelector: '.sc-page-header',
      onRefresh: loadOverview,
      links: [
        { label: 'Ø§Ù„Ù…Ù„Ù Ø§Ù„ØµØ­ÙŠ', href: 'student-profile.html' },
        { label: 'Ù…Ø±ÙƒØ² Ø§Ù„ØªÙ†Ø³ÙŠÙ‚', href: 'care-center.html', roles: ['admin'] },
        { label: 'Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª', href: 'notifications-center.html' }
      ],
      hideShellActions: true
    });
  }
  document.getElementById('tip-text').textContent = tips[tipIndex];
  updateVisitReasonMeta();
  updateMessageMeta();
  refreshStudentTelemed();
  SmartClinicSecurity.createAutoRefresh(loadOverview, 20000, { immediate: true });
});
</script>
</body>
</html>
