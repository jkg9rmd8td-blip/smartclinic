<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1">
<title>إدارة المستخدمين – Smart Clinic</title>
<link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
<style>
body{margin:0;font-family:"Tajawal",sans-serif;background:#2a1a06;color:#f8fafc;padding:18px 14px}.shell{max-width:1100px;margin:0 auto}.panel{background:rgba(35,30,20,.86);border:1px solid rgba(251,191,36,.35);border-radius:16px;padding:16px}.top{display:flex;justify-content:space-between;gap:8px;flex-wrap:wrap;margin-bottom:10px}.btn{border:1px solid rgba(251,191,36,.35);background:transparent;color:#f8fafc;padding:8px 12px;border-radius:8px;font:inherit;cursor:pointer}.table{margin-top:12px;display:grid;gap:8px}.row{display:grid;grid-template-columns:1.4fr 1fr 1.2fr 1fr;gap:8px;background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.1);border-radius:10px;padding:8px;align-items:center}.pill{padding:4px 8px;border-radius:999px;background:rgba(251,191,36,.15);border:1px solid rgba(251,191,36,.4);font-size:12px;display:inline-block}.act{border:none;background:#fbbf24;color:#1f2937;padding:7px 10px;border-radius:8px;font:inherit;font-weight:700;cursor:pointer}.toggle{border:none;background:#334155;color:#e2e8f0;padding:7px 10px;border-radius:8px;font:inherit;cursor:pointer}.hint{font-size:12px;color:#d7d1c0;margin-top:8px}
</style>
</head>
<body>
<div class="shell">
  <div class="top">
    <button class="btn" onclick="window.location.href='admin-dashboard.html'">العودة للوحة الإدارة</button>
    <button class="btn" data-action="logout">تسجيل الخروج</button>
  </div>
  <section class="panel">
    <h1 style="margin:0;font-size:30px">إدارة المستخدمين والصلاحيات</h1>
    <p style="color:#d7d1c0">تفعيل/تعطيل الحسابات وتعديل الأدوار مباشرة من الخادم.</p>
    <div id="usersTable" class="table"></div>
    <div class="hint">التعديل بين الأدوار يتم بالتدوير: طالب ← ولي أمر ← طبيب ← إدارة.</div>
  </section>
</div>
<script src="../../assets/js/security.js"></script>
<script>
var roleOrder = ['student', 'parent', 'doctor', 'admin'];
var roleLabel = { student: 'طالب', parent: 'ولي أمر', doctor: 'طبيب', admin: 'إدارة' };

function nextRole(current) {
  var idx = roleOrder.indexOf(current);
  return roleOrder[(idx + 1) % roleOrder.length];
}

async function loadUsers() {
  var table = document.getElementById('usersTable');
  table.innerHTML = 'جاري التحميل...';
  try {
    var response = await SmartClinicSecurity.apiRequest('/users');
    var payload = await response.json();
    if (!response.ok) {
      table.innerHTML = 'تعذر تحميل المستخدمين.';
      return;
    }
    var items = payload.items || [];
    table.innerHTML = items.map(function (u) {
      return '<div class="row">' +
        '<strong>' + u.name + '</strong>' +
        '<span class="pill">' + (roleLabel[u.role] || u.role) + '</span>' +
        '<button class="act" onclick="changeRole(\'' + u.id + '\', \'' + u.role + '\')">تبديل الدور</button>' +
        '<button class="toggle" onclick="toggleUser(\'' + u.id + '\', ' + (!!u.active) + ')">' + (u.active ? 'تعطيل الحساب' : 'تفعيل الحساب') + '</button>' +
      '</div>';
    }).join('');
  } catch (err) {
    table.innerHTML = 'تعذر الاتصال بالخادم.';
  }
}

async function changeRole(id, currentRole) {
  var newRole = nextRole(currentRole);
  var response = await SmartClinicSecurity.apiRequest('/users/' + id, {
    method: 'PATCH',
    body: JSON.stringify({ role: newRole })
  });
  if (!response.ok) {
    alert('فشل تعديل الدور.');
    return;
  }
  alert('تم تحديث الدور إلى: ' + (roleLabel[newRole] || newRole));
  loadUsers();
}

async function toggleUser(id, active) {
  var response = await SmartClinicSecurity.apiRequest('/users/' + id, {
    method: 'PATCH',
    body: JSON.stringify({ active: !active })
  });
  if (!response.ok) {
    alert('فشل تحديث حالة الحساب.');
    return;
  }
  alert('تم تحديث حالة الحساب.');
  loadUsers();
}

window.addEventListener('DOMContentLoaded', function(){
  SmartClinicSecurity.requireAccess(['admin'], 'إدارة المستخدمين');
  loadUsers();
});
</script>
</body>
</html>
