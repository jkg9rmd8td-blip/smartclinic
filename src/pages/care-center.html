<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Ù…Ø±ÙƒØ² Ø§Ù„ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø¹Ù„Ø§Ø¬ÙŠ â€“ Smart Clinic</title>
<link rel="stylesheet" href="../../assets/css/variables.css">
<link rel="stylesheet" href="../../assets/css/layout.css">
<link rel="stylesheet" href="../../assets/css/cards.css">
<link rel="stylesheet" href="../../assets/css/tables.css">
<style>
.care-hero h2 {
  margin: 0 0 var(--sc-title-mb);
  font-size: 32px;
}

.care-hero p {
  margin-bottom: 12px;
}

.care-grid > .care-card {
  min-height: 320px;
}

.stats {
  margin-top: 10px;
  display: grid;
  grid-template-columns: repeat(2, minmax(0, 1fr));
  gap: 10px;
}

.ticket-thread {
  margin-top: 10px;
  max-height: 220px;
  overflow: auto;
}

.qr-box {
  width: 120px;
  height: 120px;
  border: 1px solid rgba(255, 255, 255, 0.12);
  border-radius: var(--sc-radius-md);
  overflow: hidden;
  background: rgba(255, 255, 255, 0.04);
}

.qr-box img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.toast {
  position: fixed;
  left: 16px;
  bottom: 16px;
  border: 1px solid var(--sc-border);
  border-radius: var(--sc-radius-md);
  background: var(--sc-surface-strong);
  color: var(--sc-text);
  padding: 10px 12px;
  display: none;
  z-index: 40;
}

@media (max-width: 780px) {
  .stats {
    grid-template-columns: 1fr;
  }
}
</style>
</head>
<body class="sc-page">
<div class="sc-shell">
  <header class="sc-page-header">
    <div class="sc-page-header-main">
      <div class="sc-page-icon">ğŸ¥</div>
      <div>
        <h1 class="sc-page-title">Ù…Ø±ÙƒØ² Ø§Ù„ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø¹Ù„Ø§Ø¬ÙŠ</h1>
        <p class="sc-page-subtitle">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø§ØªØŒ Ø§Ù„Ø·ÙˆØ§Ø±Ø¦ØŒ Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯ØŒ Ø§Ù„ØªØ°Ø§ÙƒØ±ØŒ ÙˆØ§Ù„Ø§Ù„ØªØ²Ø§Ù… Ø§Ù„Ø¯ÙˆØ§Ø¦ÙŠ Ù…Ù† Ù„ÙˆØ­Ø© Ù…ÙˆØ­Ø¯Ø©.</p>
      </div>
    </div>
    <div class="sc-header-actions">
      <span class="sc-role-chip">Ø§Ù„Ø¯ÙˆØ± Ø§Ù„Ø­Ø§Ù„ÙŠ: <strong data-session-role>-</strong></span>
      <button class="sc-action-btn" data-action="logout">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
    </div>
  </header>

  <section class="sc-panel care-hero sc-mb-24">
    <h2>Ù…Ø±ÙƒØ² Ø§Ù„ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø¹Ù„Ø§Ø¬ÙŠ Ø§Ù„Ù…ØªÙ‚Ø¯Ù…</h2>
    <p>Ù…ÙˆØ§ÙÙ‚Ø§Øª Ø±Ù‚Ù…ÙŠØ©ØŒ Ø¨Ø·Ø§Ù‚Ø© Ø·ÙˆØ§Ø±Ø¦ QRØŒ Ù…ØªØ§Ø¨Ø¹Ø© Ù…Ù†Ø²Ù„ÙŠØ©ØŒ Ù…ÙˆØ§Ø¹ÙŠØ¯ØŒ ØªØ°Ø§ÙƒØ±ØŒ Ø§Ù„ØªØ²Ø§Ù… Ø¯ÙˆØ§Ø¦ÙŠØŒ Ø¥Ø­Ø§Ù„Ø§Øª PDFØŒ ÙˆØªÙ‚Ø§Ø±ÙŠØ± Ø´Ù‡Ø±ÙŠØ© ØªÙ†ÙÙŠØ°ÙŠØ©.</p>
    <div class="meta">
      <div class="meta-item">Ø§Ù„ÙˆØ¶Ø¹: <strong id="meta-mode">-</strong></div>
      <div class="meta-item">Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«: <strong id="meta-sync">-</strong></div>
      <div class="meta-item">Ø§Ù„ØªØ°ÙƒØ±Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©: <strong id="meta-ticket">-</strong></div>
    </div>
  </section>

  <section class="sc-grid-3 care-grid">
    <article class="sc-panel care-card">
      <h2>Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø§Øª Ø§Ù„Ø±Ù‚Ù…ÙŠØ© Ù„ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±</h2>
      <p>Ø¥Ù†Ø´Ø§Ø¡ Ø·Ù„Ø¨ Ù…ÙˆØ§ÙÙ‚Ø© (Ø¯ÙˆØ§Ø¡/ØªØ­ÙˆÙŠÙ„/Ø¬Ù„Ø³Ø© Ù…Ø±Ø¦ÙŠØ©) ÙˆØªØ³Ø¬ÙŠÙ„ Ù‚Ø±Ø§Ø± Ù‚Ø§Ù†ÙˆÙ†ÙŠ Ø¨ØªÙˆÙ‚ÙŠØª ÙˆØªÙˆÙ‚ÙŠØ¹ Ø±Ù‚Ù…ÙŠ.</p>
      <div id="consent-create-box" data-permission="approve.referral">
        <div class="two-col">
          <select id="consent-type">
            <option value="medication">Ù…ÙˆØ§ÙÙ‚Ø© Ø¯ÙˆØ§Ø¦ÙŠØ©</option>
            <option value="referral">Ù…ÙˆØ§ÙÙ‚Ø© ØªØ­ÙˆÙŠÙ„ Ø®Ø§Ø±Ø¬ÙŠ</option>
            <option value="telemed">Ù…ÙˆØ§ÙÙ‚Ø© Ø¬Ù„Ø³Ø© Ù…Ø±Ø¦ÙŠØ©</option>
          </select>
          <input id="consent-title" placeholder="Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø·Ù„Ø¨">
        </div>
        <textarea id="consent-details" placeholder="ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨..."></textarea>
        <div class="row">
          <button class="cta" onclick="createConsent()">Ø¥Ù†Ø´Ø§Ø¡ Ø·Ù„Ø¨ Ù…ÙˆØ§ÙÙ‚Ø©</button>
        </div>
      </div>
      <div id="consents-list" class="item-list"></div>
    </article>

    <article class="sc-panel care-card">
      <h2>Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø·ÙˆØ§Ø±Ø¦ QR Ù„Ù„Ø·Ø§Ù„Ø¨</h2>
      <p>Ø§Ù„ÙˆØµÙˆÙ„ Ø§Ù„Ø³Ø±ÙŠØ¹ Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¥Ø³Ø¹Ø§Ù (Ø§Ù„Ø­Ø³Ø§Ø³ÙŠØ©ØŒ Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø²Ù…Ù†Ø©ØŒ Ø¬Ù‡Ø© Ø§Ù„Ø§ØªØµØ§Ù„).</p>
      <div class="qr-wrap">
        <div class="qr-box"><img id="emergency-qr" alt="QR"></div>
        <div>
          <div id="emergency-name"><strong>-</strong></div>
          <div id="emergency-facts" class="muted">-</div>
          <div class="row" style="margin-top:8px;">
            <button class="cta" onclick="loadEmergencyCard()">ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©</button>
            <button class="btn" onclick="openEmergencyPublic()">ÙØªØ­ Ø±Ø§Ø¨Ø· Ø§Ù„Ø·ÙˆØ§Ø±Ø¦</button>
          </div>
        </div>
      </div>
    </article>

    <article class="sc-panel care-card">
      <h2>Ø®Ø·Ø© Ù…ØªØ§Ø¨Ø¹Ø© Ù…Ù†Ø²Ù„ÙŠØ©</h2>
      <p>Checklist ÙŠÙˆÙ…ÙŠ (Ø¯ÙˆØ§Ø¡/Ø³ÙˆØ§Ø¦Ù„/Ø±Ø§Ø­Ø©/Ø£Ø¹Ø±Ø§Ø¶) Ù…Ø¹ ØªØ­Ø¯ÙŠØ«Ø§Øª Ù…Ù† Ø§Ù„Ø·Ø§Ù„Ø¨ Ø£Ùˆ ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±.</p>
      <div id="home-create-box" data-permission="edit.careplan">
        <input id="home-title" placeholder="Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø®Ø·Ø©">
        <textarea id="home-items" placeholder="Ø§ÙƒØªØ¨ ÙƒÙ„ Ø¹Ù†ØµØ± ÙÙŠ Ø³Ø·Ø± Ù…Ø³ØªÙ‚Ù„"></textarea>
        <div class="two-col">
          <input id="home-reminder" placeholder="ÙˆÙ‚Øª Ø§Ù„ØªØ°ÙƒÙŠØ± (Ù…Ø«Ø§Ù„ 19:00)">
          <button class="cta" onclick="createHomePlan()">Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø®Ø·Ø©</button>
        </div>
      </div>
      <div id="home-list" class="item-list"></div>
    </article>

    <article class="sc-panel care-card">
      <h2>Ù†Ø¸Ø§Ù… Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ</h2>
      <p>Ø­Ø¬Ø² Ù…ÙˆØ¹Ø¯ Ù…Ø­Ø¯Ø¯ Ø¨Ø­Ø§Ù„Ø© ØªØ´ØºÙŠÙ„ÙŠØ©: Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±ØŒ Ù…Ø¤ÙƒØ¯ØŒ Ù…ÙƒØªÙ…Ù„ØŒ Ù…Ù„ØºÙŠ.</p>
      <div>
        <input id="appointment-reason" placeholder="Ø³Ø¨Ø¨ Ø§Ù„Ù…ÙˆØ¹Ø¯">
        <div class="two-col">
          <input id="appointment-slot" type="datetime-local">
          <button class="cta" onclick="createAppointment()">Ø­Ø¬Ø² Ø§Ù„Ù…ÙˆØ¹Ø¯</button>
        </div>
      </div>
      <div id="appointments-list" class="item-list"></div>
    </article>

    <article class="sc-panel care-card">
      <h2>Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª ÙƒØªØ°Ø§ÙƒØ± Tickets</h2>
      <p>ÙƒÙ„ Ø§Ø³ØªÙØ³Ø§Ø± ÙŠØªØ­ÙˆÙ„ Ù„ØªØ°ÙƒØ±Ø© Ø¨Ø±Ù‚Ù… ÙˆØ­Ø§Ù„Ø© ÙˆÙ…Ø³Ø¤ÙˆÙ„ ÙˆØªØ§Ø±ÙŠØ® Ø¥ØºÙ„Ø§Ù‚.</p>
      <div>
        <input id="ticket-subject" placeholder="Ù…ÙˆØ¶ÙˆØ¹ Ø§Ù„ØªØ°ÙƒØ±Ø©">
        <div class="two-col">
          <select id="ticket-priority">
            <option value="normal">Ø£ÙˆÙ„ÙˆÙŠØ© Ø¹Ø§Ø¯ÙŠØ©</option>
            <option value="high">Ø£ÙˆÙ„ÙˆÙŠØ© Ø¹Ø§Ù„ÙŠØ©</option>
            <option value="critical">Ø£ÙˆÙ„ÙˆÙŠØ© Ø­Ø±Ø¬Ø©</option>
            <option value="low">Ø£ÙˆÙ„ÙˆÙŠØ© Ù…Ù†Ø®ÙØ¶Ø©</option>
          </select>
          <button class="cta" onclick="createTicket()">ÙØªØ­ ØªØ°ÙƒØ±Ø©</button>
        </div>
        <textarea id="ticket-text" placeholder="ÙˆØµÙ Ø§Ù„Ø§Ø³ØªÙØ³Ø§Ø±..."></textarea>
      </div>
      <div id="tickets-list" class="item-list"></div>
      <div id="ticket-thread" class="ticket-thread"></div>
      <div class="row" style="margin-top:8px;">
        <input id="ticket-reply" placeholder="Ø±Ø¯ Ø¹Ù„Ù‰ Ø§Ù„ØªØ°ÙƒØ±Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©">
        <button class="cta" onclick="replyTicket()">Ø¥Ø±Ø³Ø§Ù„ Ø±Ø¯</button>
      </div>
    </article>

    <article class="sc-panel care-card">
      <h2>Ù„ÙˆØ­Ø© Ø§Ù„Ø§Ù…ØªØ«Ø§Ù„ Ø§Ù„Ø¯ÙˆØ§Ø¦ÙŠ</h2>
      <p>ØªØªØ¨Ø¹ Ø§Ù„Ø¬Ø±Ø¹Ø§Øª ÙˆÙ†Ø³Ø¨Ø© Ø§Ù„Ø§Ù„ØªØ²Ø§Ù… Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠØ© Ù…Ø¹ Ø¥Ù†Ø°Ø§Ø± Ø¹Ù†Ø¯ Ø§Ù„Ø§Ù†Ø®ÙØ§Ø¶.</p>
      <div id="med-plan-create" data-permission="prescribe.medication">
        <div class="two-col">
          <input id="med-name" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¯ÙˆØ§Ø¡">
          <input id="med-doses" type="number" min="1" max="8" value="2" placeholder="Ø¬Ø±Ø¹Ø§Øª ÙŠÙˆÙ…ÙŠØ©">
        </div>
        <input id="med-instructions" placeholder="ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø§Ù„Ø¬Ø±Ø¹Ø©">
        <button class="cta" onclick="createMedicationPlan()">Ø¥Ø¶Ø§ÙØ© Ø®Ø·Ø© Ø¯ÙˆØ§Ø¦ÙŠØ©</button>
      </div>
      <div class="row" style="margin-top:8px;">
        <select id="med-plan-select"></select>
        <button class="cta ok" onclick="logMedication('taken')">ØªÙ… Ø£Ø®Ø° Ø§Ù„Ø¬Ø±Ø¹Ø©</button>
        <button class="cta warn" onclick="logMedication('skipped')">ØªÙ… ØªØ¬Ø§ÙˆØ² Ø§Ù„Ø¬Ø±Ø¹Ø©</button>
      </div>
      <div id="med-stats" class="stats"></div>
      <div id="med-logs" class="item-list"></div>
    </article>

    <article class="sc-panel care-card">
      <h2>Ù†Ù…ÙˆØ°Ø¬ Ø¥Ø­Ø§Ù„Ø© Ø®Ø§Ø±Ø¬ÙŠ Ù…ÙˆØ­Ø¯</h2>
      <p>Ø¥Ù†Ø´Ø§Ø¡ Ø¥Ø­Ø§Ù„Ø© Ù„Ù„Ù…Ø³ØªØ´ÙÙ‰ ÙˆØªØµØ¯ÙŠØ± ØªÙ‚Ø±ÙŠØ± PDF Ø¬Ø§Ù‡Ø².</p>
      <div id="referral-create" data-permission="approve.referral">
        <input id="ref-destination" placeholder="Ø¬Ù‡Ø© Ø§Ù„ØªØ­ÙˆÙŠÙ„">
        <input id="ref-reason" placeholder="Ø³Ø¨Ø¨ Ø§Ù„ØªØ­ÙˆÙŠÙ„">
        <input id="ref-diagnosis" placeholder="Ø§Ù„ØªØ´Ø®ÙŠØµ Ø§Ù„Ø£ÙˆÙ„ÙŠ">
        <textarea id="ref-summary" placeholder="Ø§Ù„Ù…Ù„Ø®Øµ Ø§Ù„Ø³Ø±ÙŠØ±ÙŠ"></textarea>
        <button class="cta" onclick="createReferral()">Ø¥Ù†Ø´Ø§Ø¡ Ø¥Ø­Ø§Ù„Ø©</button>
      </div>
      <div id="referrals-list" class="item-list"></div>
    </article>

    <article class="sc-panel care-card" data-permission="export.executive">
      <h2>ØªÙ‚Ø§Ø±ÙŠØ± ØªÙ†ÙÙŠØ°ÙŠØ© Ø´Ù‡Ø±ÙŠØ© ØªÙ„Ù‚Ø§Ø¦ÙŠØ©</h2>
      <p>Ù…Ù„Ø®Øµ Ø´Ù‡Ø±ÙŠ Ù„Ù„Ø¥Ø¯Ø§Ø±Ø©: Ø§Ù„Ø­Ø§Ù„Ø§Øª Ø§Ù„Ø­Ø±Ø¬Ø©ØŒ Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø©ØŒ Ù†Ø³Ø¨ Ø§Ù„Ø¥ØºÙ„Ø§Ù‚ Ø¨ØµÙŠØºØ© PDF.</p>
      <div class="two-col">
        <input id="monthly-month" type="month">
        <button class="cta" onclick="loadMonthlyReport()">ØªÙˆÙ„ÙŠØ¯ Ø§Ù„ØªÙ‚Ø±ÙŠØ±</button>
      </div>
      <div id="monthly-stats" class="stats"></div>
      <div class="row" style="margin-top:8px;">
        <button class="cta" onclick="downloadMonthlyPdf()">ØªØ­Ù…ÙŠÙ„ PDF</button>
      </div>
    </article>
  </section>
</div>
<div id="toast" class="toast"></div>
<script src="../../assets/js/security.js"></script>
<script src="../../assets/js/ui-shell.js"></script>
<script>
var currentSession = null;
var selectedTicketId = '';
var emergencyPublicUrl = '';
var ticketCache = [];
var medicationPlanCache = [];
var monthlyReportCache = null;
var homeReminderSeen = {};

function notify(text) {
  var el = document.getElementById('toast');
  el.textContent = text;
  el.style.display = 'block';
  window.setTimeout(function () { el.style.display = 'none'; }, 2300);
}

function safeHtml(text) {
  return String(text || '')
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&#039;');
}

function formatTime(iso) {
  if (!iso) return '-';
  return new Date(iso).toLocaleString('ar-SA');
}

function shouldTriggerReminder(reminderTime) {
  if (!reminderTime || String(reminderTime).indexOf(':') === -1) return false;
  var bits = String(reminderTime).split(':');
  var h = Number(bits[0]);
  var m = Number(bits[1]);
  if (!Number.isFinite(h) || !Number.isFinite(m)) return false;
  var now = new Date();
  var stamp = now.getFullYear() + '-' + String(now.getMonth() + 1).padStart(2, '0') + '-' + String(now.getDate()).padStart(2, '0');
  var currentMin = (now.getHours() * 60) + now.getMinutes();
  var reminderMin = (h * 60) + m;
  return currentMin >= reminderMin && !homeReminderSeen[stamp + ':' + reminderTime];
}

function statusBadge(status) {
  var cls = 'b-ok';
  if (status === 'pending' || status === 'in_progress') cls = 'b-warn';
  if (status === 'rejected' || status === 'cancelled' || status === 'closed') cls = 'b-danger';
  return '<span class="badge ' + cls + '">' + safeHtml(status || '-') + '</span>';
}

async function openPdf(path, filename) {
  var response = await SmartClinicSecurity.apiRequest(path);
  if (!response.ok) {
    notify('ØªØ¹Ø°Ø± ØªØ¬Ù‡ÙŠØ² Ù…Ù„Ù PDF.');
    return;
  }
  var blob = await response.blob();
  var url = URL.createObjectURL(blob);
  var a = document.createElement('a');
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}

function refreshMeta() {
  document.getElementById('meta-mode').textContent = SmartClinicSecurity.isDemoMode() ? 'Demo' : 'Live';
  document.getElementById('meta-sync').textContent = new Date().toLocaleTimeString('ar-SA');
  document.getElementById('meta-ticket').textContent = selectedTicketId || '-';
}

function isParentOrAdmin() {
  return currentSession && (currentSession.role === 'parent' || currentSession.role === 'admin');
}

function isDoctorOrAdmin() {
  return currentSession && (currentSession.role === 'doctor' || currentSession.role === 'admin');
}

async function createConsent() {
  var title = document.getElementById('consent-title').value.trim();
  var details = document.getElementById('consent-details').value.trim();
  var type = document.getElementById('consent-type').value;
  if (!title || !details) {
    notify('Ø§ÙƒØªØ¨ Ø¹Ù†ÙˆØ§Ù†Ù‹Ø§ ÙˆØªÙØ§ØµÙŠÙ„ Ù„Ù„Ù…ÙˆØ§ÙÙ‚Ø©.');
    return;
  }
  var result = await SmartClinicSecurity.apiJson('/consents', {
    method: 'POST',
    body: JSON.stringify({ title: title, details: details, type: type })
  });
  if (!result.ok) {
    notify(result.error || 'ØªØ¹Ø°Ø± Ø¥Ù†Ø´Ø§Ø¡ Ø·Ù„Ø¨ Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø©.');
    return;
  }
  document.getElementById('consent-title').value = '';
  document.getElementById('consent-details').value = '';
  notify('ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø·Ù„Ø¨ Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø©.');
  loadConsents();
}

async function decideConsent(id, decision) {
  var note = window.prompt(decision === 'approve' ? 'Ù…Ù„Ø§Ø­Ø¸Ø© Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ):' : 'Ø³Ø¨Ø¨ Ø§Ù„Ø±ÙØ¶ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ):', '') || '';
  var result = await SmartClinicSecurity.apiJson('/consents/' + encodeURIComponent(id) + '/decision', {
    method: 'POST',
    body: JSON.stringify({
      decision: decision,
      note: note,
      signature: (currentSession ? currentSession.role : 'user') + ':' + Date.now()
    })
  });
  if (!result.ok) {
    notify(result.error || 'ØªØ¹Ø°Ø± ØªØ³Ø¬ÙŠÙ„ Ù‚Ø±Ø§Ø± Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø©.');
    return;
  }
  notify('ØªÙ… ØªØ­Ø¯ÙŠØ« Ù‚Ø±Ø§Ø± Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø©.');
  loadConsents();
}

async function loadConsents() {
  var result = await SmartClinicSecurity.apiJson('/consents');
  var wrap = document.getElementById('consents-list');
  if (!result.ok || !result.data) {
    wrap.innerHTML = '<div class="item">ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø§Øª.</div>';
    return;
  }
  var items = result.data.items || [];
  if (!items.length) {
    wrap.innerHTML = '<div class="item">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ù…ÙˆØ§ÙÙ‚Ø© Ø­Ø§Ù„ÙŠÙ‹Ø§.</div>';
    return;
  }
  wrap.innerHTML = items.slice(0, 6).map(function (item) {
    var actions = '';
    if (isParentOrAdmin() && item.status === 'pending') {
      actions = '<div class="row" style="margin-top:6px;">' +
        '<button class="cta ok" onclick="decideConsent(\'' + item.id + '\',\'approve\')">Ø§Ø¹ØªÙ…Ø§Ø¯</button>' +
        '<button class="cta danger" onclick="decideConsent(\'' + item.id + '\',\'reject\')">Ø±ÙØ¶</button>' +
      '</div>';
    }
    var legal = Array.isArray(item.legalLog) && item.legalLog.length ? '<div class="muted">Ø³Ø¬Ù„ Ù‚Ø§Ù†ÙˆÙ†ÙŠ: ' + item.legalLog.length + ' Ø­Ø¯Ø«</div>' : '';
    return '<div class="item">' +
      '<strong>' + safeHtml(item.title) + '</strong> â€¢ ' + safeHtml(item.type) +
      statusBadge(item.status) +
      '<div class="muted">Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«: ' + formatTime(item.updatedAt || item.createdAt) + '</div>' +
      '<div>' + safeHtml(item.details || '-') + '</div>' +
      legal + actions +
    '</div>';
  }).join('');
}

async function loadEmergencyCard() {
  var result = await SmartClinicSecurity.apiJson('/emergency-card');
  if (!result.ok || !result.data || !result.data.card) {
    notify(result.error || 'ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø·ÙˆØ§Ø±Ø¦.');
    return;
  }
  var card = result.data.card;
  document.getElementById('emergency-name').innerHTML = '<strong>' + safeHtml(card.studentName) + '</strong> â€¢ ' + safeHtml(card.grade || '-');
  document.getElementById('emergency-facts').textContent = 'Ø­Ø³Ø§Ø³ÙŠØ©: ' + card.allergies + ' | Ù…Ø²Ù…Ù†: ' + card.chronicCondition + ' | Ø§ØªØµØ§Ù„: ' + card.emergencyContact;
  document.getElementById('emergency-qr').src = result.data.qrImageUrl || '';
  emergencyPublicUrl = result.data.publicUrl || '';
}

function openEmergencyPublic() {
  if (!emergencyPublicUrl) {
    notify('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø±Ø§Ø¨Ø· Ø·ÙˆØ§Ø±Ø¦ Ø­Ø§Ù„ÙŠÙ‹Ø§.');
    return;
  }
  window.open(emergencyPublicUrl, '_blank');
}

async function createHomePlan() {
  var title = document.getElementById('home-title').value.trim();
  var itemsText = document.getElementById('home-items').value.trim();
  var reminder = document.getElementById('home-reminder').value.trim() || '19:00';
  if (!title) {
    notify('Ø§ÙƒØªØ¨ Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø®Ø·Ø©.');
    return;
  }
  var result = await SmartClinicSecurity.apiJson('/home-care/plans', {
    method: 'POST',
    body: JSON.stringify({ title: title, itemsText: itemsText, reminderTime: reminder })
  });
  if (!result.ok) {
    notify(result.error || 'ØªØ¹Ø°Ø± Ø¥Ù†Ø´Ø§Ø¡ Ø®Ø·Ø© Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©.');
    return;
  }
  document.getElementById('home-title').value = '';
  document.getElementById('home-items').value = '';
  notify('ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø®Ø·Ø© Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ù…Ù†Ø²Ù„ÙŠØ©.');
  loadHomePlans();
}

async function toggleHomeItem(planId, itemId, done) {
  var result = await SmartClinicSecurity.apiJson('/home-care/plans/' + encodeURIComponent(planId) + '/check', {
    method: 'POST',
    body: JSON.stringify({ itemId: itemId, done: done })
  });
  if (!result.ok) {
    notify(result.error || 'ØªØ¹Ø°Ø± ØªØ­Ø¯ÙŠØ« Ø¹Ù†ØµØ± Ø§Ù„Ø®Ø·Ø©.');
    return;
  }
  loadHomePlans();
}

async function loadHomePlans() {
  var result = await SmartClinicSecurity.apiJson('/home-care/plans');
  var wrap = document.getElementById('home-list');
  if (!result.ok || !result.data) {
    wrap.innerHTML = '<div class="item">ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø®Ø·Ø· Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©.</div>';
    return;
  }
  var plans = result.data.items || [];
  if (!plans.length) {
    wrap.innerHTML = '<div class="item">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø®Ø·Ø· Ù…ØªØ§Ø¨Ø¹Ø© Ù†Ø´Ø·Ø©.</div>';
    return;
  }
  var reminders = [];
  wrap.innerHTML = plans.slice(0, 4).map(function (plan) {
    var checklist = (plan.checklist || []).map(function (task) {
      var checked = task.done ? 'checked' : '';
      var disabled = (currentSession && currentSession.role === 'doctor') ? 'disabled' : '';
      var mark = task.done ? 'b-ok' : 'b-warn';
      if (!task.done && shouldTriggerReminder(task.reminderTime || '')) {
        reminders.push(task.reminderTime);
      }
      return '<label class="item" style="margin-top:6px;display:block;">' +
        '<input type="checkbox" ' + checked + ' ' + disabled + ' onchange="toggleHomeItem(\'' + plan.id + '\',\'' + task.id + '\',this.checked)">' +
        ' ' + safeHtml(task.label) + ' <span class="badge ' + mark + '">' + (task.done ? 'Ù…Ù†ÙØ°' : 'Ù…Ø¹Ù„Ù‚') + '</span>' +
        '<div class="muted">ØªØ°ÙƒÙŠØ±: ' + safeHtml(task.reminderTime || '-') + '</div>' +
      '</label>';
    }).join('');
    return '<div class="item">' +
      '<strong>' + safeHtml(plan.title) + '</strong> ' + statusBadge(plan.status) +
      '<div class="muted">ØªÙ… Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡: ' + formatTime(plan.createdAt) + '</div>' +
      checklist +
    '</div>';
  }).join('');
  if (reminders.length) {
    var now = new Date();
    var stamp = now.getFullYear() + '-' + String(now.getMonth() + 1).padStart(2, '0') + '-' + String(now.getDate()).padStart(2, '0');
    reminders.forEach(function (time) {
      homeReminderSeen[stamp + ':' + time] = true;
    });
    notify('ØªØ°ÙƒÙŠØ± Ù…ØªØ§Ø¨Ø¹Ø© Ù…Ù†Ø²Ù„ÙŠØ©: Ù„Ø¯ÙŠÙƒ Ø¹Ù†Ø§ØµØ± ØºÙŠØ± Ù…Ù†ÙØ°Ø© Ø¨Ù…ÙˆØ¹Ø¯ Ø§Ù„ØªØ°ÙƒÙŠØ± Ø§Ù„Ø­Ø§Ù„ÙŠ.');
  }
}

async function createAppointment() {
  var reason = document.getElementById('appointment-reason').value.trim();
  var slot = document.getElementById('appointment-slot').value;
  if (!reason || !slot) {
    notify('Ø£Ø¯Ø®Ù„ Ø³Ø¨Ø¨ Ø§Ù„Ù…ÙˆØ¹Ø¯ ÙˆØ§Ù„ØªØ§Ø±ÙŠØ®.');
    return;
  }
  var iso = new Date(slot).toISOString();
  var result = await SmartClinicSecurity.apiJson('/appointments', {
    method: 'POST',
    body: JSON.stringify({ reason: reason, slotAt: iso })
  });
  if (!result.ok) {
    notify(result.error || 'ØªØ¹Ø°Ø± Ø­Ø¬Ø² Ø§Ù„Ù…ÙˆØ¹Ø¯.');
    return;
  }
  document.getElementById('appointment-reason').value = '';
  notify('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø·Ù„Ø¨ Ø§Ù„Ù…ÙˆØ¹Ø¯.');
  loadAppointments();
}

async function setAppointmentStatus(id, status) {
  var result = await SmartClinicSecurity.apiJson('/appointments/' + encodeURIComponent(id) + '/status', {
    method: 'POST',
    body: JSON.stringify({ status: status })
  });
  if (!result.ok) {
    notify(result.error || 'ØªØ¹Ø°Ø± ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ù…ÙˆØ¹Ø¯.');
    return;
  }
  loadAppointments();
}

async function loadAppointments() {
  var query = isDoctorOrAdmin() ? '?all=1' : '';
  var result = await SmartClinicSecurity.apiJson('/appointments' + query);
  var wrap = document.getElementById('appointments-list');
  if (!result.ok || !result.data) {
    wrap.innerHTML = '<div class="item">ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯.</div>';
    return;
  }
  var items = result.data.items || [];
  if (!items.length) {
    wrap.innerHTML = '<div class="item">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ÙˆØ§Ø¹ÙŠØ¯ Ø­Ø§Ù„ÙŠØ©.</div>';
    return;
  }
  wrap.innerHTML = items.slice(0, 8).map(function (item) {
    var controls = '';
    if (isDoctorOrAdmin()) {
      controls = '<div class="row" style="margin-top:6px;">' +
        '<button class="btn" onclick="setAppointmentStatus(\'' + item.id + '\',\'confirmed\')">ØªØ£ÙƒÙŠØ¯</button>' +
        '<button class="btn" onclick="setAppointmentStatus(\'' + item.id + '\',\'completed\')">Ø¥ÙƒÙ…Ø§Ù„</button>' +
        '<button class="btn" onclick="setAppointmentStatus(\'' + item.id + '\',\'cancelled\')">Ø¥Ù„ØºØ§Ø¡</button>' +
      '</div>';
    }
    return '<div class="item">' +
      '<strong>' + safeHtml(item.reason) + '</strong> ' + statusBadge(item.status) +
      '<div class="muted">Ø§Ù„Ù…ÙˆØ¹Ø¯: ' + formatTime(item.slotAt) + '</div>' +
      controls +
    '</div>';
  }).join('');
}

async function createTicket() {
  var subject = document.getElementById('ticket-subject').value.trim();
  var text = document.getElementById('ticket-text').value.trim();
  var priority = document.getElementById('ticket-priority').value;
  if (!subject || !text) {
    notify('Ø£Ø¯Ø®Ù„ Ù…ÙˆØ¶ÙˆØ¹ Ø§Ù„ØªØ°ÙƒØ±Ø© ÙˆØ§Ù„Ù†Øµ.');
    return;
  }
  var result = await SmartClinicSecurity.apiJson('/tickets', {
    method: 'POST',
    body: JSON.stringify({ subject: subject, text: text, priority: priority })
  });
  if (!result.ok || !result.data) {
    notify(result.error || 'ØªØ¹Ø°Ø± ÙØªØ­ Ø§Ù„ØªØ°ÙƒØ±Ø©.');
    return;
  }
  document.getElementById('ticket-subject').value = '';
  document.getElementById('ticket-text').value = '';
  selectedTicketId = (result.data.item || {}).id || '';
  notify('ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØªØ°ÙƒØ±Ø©.');
  loadTickets();
}

async function setTicketStatus(id, status) {
  var result = await SmartClinicSecurity.apiJson('/tickets/' + encodeURIComponent(id), {
    method: 'PATCH',
    body: JSON.stringify({ status: status })
  });
  if (!result.ok) {
    notify(result.error || 'ØªØ¹Ø°Ø± ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„ØªØ°ÙƒØ±Ø©.');
    return;
  }
  loadTickets();
}

async function loadTicketThread(id) {
  if (!id) return;
  selectedTicketId = id;
  refreshMeta();
  var result = await SmartClinicSecurity.apiJson('/tickets/' + encodeURIComponent(id) + '/messages');
  var wrap = document.getElementById('ticket-thread');
  if (!result.ok || !result.data) {
    wrap.innerHTML = '<div class="msg">ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©.</div>';
    return;
  }
  var messages = result.data.messages || [];
  wrap.innerHTML = messages.map(function (m) {
    return '<div class="msg"><strong>' + safeHtml(m.fromRole) + '</strong>: ' + safeHtml(m.text) + '<div class="muted">' + formatTime(m.createdAt) + '</div></div>';
  }).join('');
}

async function replyTicket() {
  if (!selectedTicketId) {
    notify('Ø§Ø®ØªØ± ØªØ°ÙƒØ±Ø© Ø£ÙˆÙ„Ù‹Ø§.');
    return;
  }
  var text = document.getElementById('ticket-reply').value.trim();
  if (!text) {
    notify('Ø£Ø¯Ø®Ù„ Ù†Øµ Ø§Ù„Ø±Ø¯.');
    return;
  }
  var result = await SmartClinicSecurity.apiJson('/tickets/' + encodeURIComponent(selectedTicketId) + '/messages', {
    method: 'POST',
    body: JSON.stringify({ text: text })
  });
  if (!result.ok) {
    notify(result.error || 'ØªØ¹Ø°Ø± Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø¯.');
    return;
  }
  document.getElementById('ticket-reply').value = '';
  loadTickets();
  loadTicketThread(selectedTicketId);
}

async function loadTickets() {
  var result = await SmartClinicSecurity.apiJson('/tickets');
  var wrap = document.getElementById('tickets-list');
  if (!result.ok || !result.data) {
    wrap.innerHTML = '<div class="item">ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØ°Ø§ÙƒØ±.</div>';
    return;
  }
  ticketCache = result.data.items || [];
  if (!ticketCache.length) {
    wrap.innerHTML = '<div class="item">Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØ°Ø§ÙƒØ± Ø­Ø§Ù„ÙŠØ©.</div>';
    document.getElementById('ticket-thread').innerHTML = '';
    return;
  }
  if (!selectedTicketId) {
    selectedTicketId = ticketCache[0].id;
  }
  refreshMeta();
  wrap.innerHTML = ticketCache.slice(0, 8).map(function (t) {
    var controls = '';
    if (isDoctorOrAdmin()) {
      controls = '<div class="row" style="margin-top:6px;">' +
        '<button class="btn" onclick="setTicketStatus(\'' + t.id + '\',\'in_progress\')">Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©</button>' +
        '<button class="btn" onclick="setTicketStatus(\'' + t.id + '\',\'closed\')">Ø¥ØºÙ„Ø§Ù‚</button>' +
      '</div>';
    }
    return '<div class="item">' +
      '<strong>' + safeHtml(t.number + ' - ' + t.subject) + '</strong> ' + statusBadge(t.status) +
      '<div class="muted">Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«: ' + formatTime(t.updatedAt) + '</div>' +
      '<div class="row" style="margin-top:6px;"><button class="btn" onclick="loadTicketThread(\'' + t.id + '\')">ÙØªØ­ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©</button></div>' +
      controls +
    '</div>';
  }).join('');
  loadTicketThread(selectedTicketId);
}

function renderMedicationStats(summary) {
  var wrap = document.getElementById('med-stats');
  wrap.innerHTML = [
    ['Ù†Ø³Ø¨Ø© Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…', String(summary.adherencePercent || 0) + '%'],
    ['Ø¬Ø±Ø¹Ø§Øª Ù…ØªÙˆÙ‚Ø¹Ø©', summary.expectedDoses || 0],
    ['Ø¬Ø±Ø¹Ø§Øª Ù…Ø£Ø®ÙˆØ°Ø©', summary.takenDoses || 0],
    ['Ø¬Ø±Ø¹Ø§Øª Ù…ØªØ¬Ø§ÙˆØ²Ø©', summary.skippedDoses || 0]
  ].map(function (item) {
    return '<div class="stat"><div class="l">' + item[0] + '</div><div class="v">' + item[1] + '</div></div>';
  }).join('');
}

function renderMedicationPlans(plans) {
  medicationPlanCache = plans || [];
  var select = document.getElementById('med-plan-select');
  if (!medicationPlanCache.length) {
    select.innerHTML = '<option value="">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø®Ø·Ø© Ø¯ÙˆØ§Ø¦ÙŠØ©</option>';
    return;
  }
  select.innerHTML = medicationPlanCache.map(function (p) {
    return '<option value="' + p.id + '">' + safeHtml(p.name) + ' (' + p.dosesPerDay + '/ÙŠÙˆÙ…)</option>';
  }).join('');
}

async function createMedicationPlan() {
  var name = document.getElementById('med-name').value.trim();
  var doses = Number(document.getElementById('med-doses').value || 1);
  var instructions = document.getElementById('med-instructions').value.trim();
  if (!name) {
    notify('Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ø¯ÙˆØ§Ø¡.');
    return;
  }
  var result = await SmartClinicSecurity.apiJson('/medications/plans', {
    method: 'POST',
    body: JSON.stringify({ name: name, dosesPerDay: doses, instructions: instructions })
  });
  if (!result.ok) {
    notify(result.error || 'ØªØ¹Ø°Ø± Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø®Ø·Ø© Ø§Ù„Ø¯ÙˆØ§Ø¦ÙŠØ©.');
    return;
  }
  document.getElementById('med-name').value = '';
  document.getElementById('med-instructions').value = '';
  notify('ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø®Ø·Ø© Ø§Ù„Ø¯ÙˆØ§Ø¦ÙŠØ©.');
  loadMedication();
}

async function logMedication(status) {
  var planId = document.getElementById('med-plan-select').value;
  if (!planId) {
    notify('Ø§Ø®ØªØ± Ø®Ø·Ø© Ø¯ÙˆØ§Ø¦ÙŠØ© Ø£ÙˆÙ„Ù‹Ø§.');
    return;
  }
  var result = await SmartClinicSecurity.apiJson('/medications/logs', {
    method: 'POST',
    body: JSON.stringify({ planId: planId, status: status })
  });
  if (!result.ok) {
    notify(result.error || 'ØªØ¹Ø°Ø± ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¬Ø±Ø¹Ø©.');
    return;
  }
  notify(status === 'taken' ? 'ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¬Ø±Ø¹Ø© ÙƒÙ…Ø£Ø®ÙˆØ°Ø©.' : 'ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¬Ø±Ø¹Ø© ÙƒÙ…ØªØ¬Ø§ÙˆØ²Ø©.');
  loadMedication();
}

async function loadMedication() {
  var result = await SmartClinicSecurity.apiJson('/medications/adherence');
  var logsWrap = document.getElementById('med-logs');
  if (!result.ok || !result.data) {
    logsWrap.innerHTML = '<div class="item">ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯ÙˆØ§Ø¡.</div>';
    return;
  }
  renderMedicationStats(result.data);
  renderMedicationPlans(result.data.plans || []);
  var logs = result.data.recentLogs || [];
  if (!logs.length) {
    logsWrap.innerHTML = '<div class="item">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª Ø¬Ø±Ø¹Ø§Øª Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†.</div>';
  } else {
    logsWrap.innerHTML = logs.slice(0, 6).map(function (log) {
      return '<div class="item"><strong>' + safeHtml(log.planName || 'Ø¬Ø±Ø¹Ø©') + '</strong> ' + statusBadge(log.status) +
        '<div class="muted">' + formatTime(log.takenAt || log.createdAt) + '</div></div>';
    }).join('');
  }
  if (result.data.alert) {
    notify(result.data.alert);
  }
}

async function createReferral() {
  var destination = document.getElementById('ref-destination').value.trim();
  var reason = document.getElementById('ref-reason').value.trim();
  var diagnosis = document.getElementById('ref-diagnosis').value.trim();
  var summary = document.getElementById('ref-summary').value.trim();
  if (!destination || !reason) {
    notify('Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¬Ù‡Ø© ÙˆØ³Ø¨Ø¨ Ø§Ù„ØªØ­ÙˆÙŠÙ„.');
    return;
  }
  var result = await SmartClinicSecurity.apiJson('/referrals', {
    method: 'POST',
    body: JSON.stringify({
      destination: destination,
      reason: reason,
      diagnosis: diagnosis,
      clinicalSummary: summary
    })
  });
  if (!result.ok) {
    notify(result.error || 'ØªØ¹Ø°Ø± Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¥Ø­Ø§Ù„Ø©.');
    return;
  }
  document.getElementById('ref-destination').value = '';
  document.getElementById('ref-reason').value = '';
  document.getElementById('ref-diagnosis').value = '';
  document.getElementById('ref-summary').value = '';
  notify('ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¥Ø­Ø§Ù„Ø© Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠØ©.');
  loadReferrals();
}

async function downloadReferralPdf(id) {
  openPdf('/referrals/' + encodeURIComponent(id) + '/pdf', 'referral-' + id + '.pdf');
}

async function loadReferrals() {
  var result = await SmartClinicSecurity.apiJson('/referrals');
  var wrap = document.getElementById('referrals-list');
  if (!result.ok || !result.data) {
    wrap.innerHTML = '<div class="item">ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø­Ø§Ù„Ø§Øª.</div>';
    return;
  }
  var items = result.data.items || [];
  if (!items.length) {
    wrap.innerHTML = '<div class="item">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ø­Ø§Ù„Ø§Øª Ø­Ø§Ù„ÙŠØ©.</div>';
    return;
  }
  wrap.innerHTML = items.slice(0, 6).map(function (item) {
    return '<div class="item">' +
      '<strong>' + safeHtml(item.destination || '-') + '</strong> â€¢ ' + safeHtml(item.reason || '-') +
      '<div class="muted">' + formatTime(item.createdAt) + '</div>' +
      '<div class="row" style="margin-top:6px;"><button class="btn" onclick="downloadReferralPdf(\'' + item.id + '\')">ØªØ­Ù…ÙŠÙ„ PDF</button></div>' +
    '</div>';
  }).join('');
}

function renderMonthlyStats(metrics) {
  var wrap = document.getElementById('monthly-stats');
  if (!metrics) {
    wrap.innerHTML = '<div class="stat"><div class="l">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</div><div class="v">-</div></div>';
    return;
  }
  var items = [
    ['Ø­Ø§Ù„Ø§Øª Ø­Ø±Ø¬Ø©', metrics.criticalCases || 0],
    ['Ø·Ù„Ø¨Ø§Øª Ø²ÙŠØ§Ø±Ø©', metrics.visitRequests || 0],
    ['Ù…ÙˆØ§Ø¹ÙŠØ¯ Ù…ÙƒØªÙ…Ù„Ø©', metrics.appointmentsCompleted || 0],
    ['Ù†Ø³Ø¨Ø© Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ØªØ°Ø§ÙƒØ±', String(metrics.ticketClosureRate || 0) + '%']
  ];
  wrap.innerHTML = items.map(function (item) {
    return '<div class="stat"><div class="l">' + item[0] + '</div><div class="v">' + item[1] + '</div></div>';
  }).join('');
}

async function loadMonthlyReport() {
  var month = document.getElementById('monthly-month').value;
  if (!month) {
    notify('Ø§Ø®ØªØ± Ø§Ù„Ø´Ù‡Ø± Ø£ÙˆÙ„Ù‹Ø§.');
    return;
  }
  var result = await SmartClinicSecurity.apiJson('/reports/monthly?month=' + encodeURIComponent(month));
  if (!result.ok || !result.data || !result.data.item) {
    notify(result.error || 'ØªØ¹Ø°Ø± ØªÙˆÙ„ÙŠØ¯ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø´Ù‡Ø±ÙŠ.');
    return;
  }
  monthlyReportCache = result.data.item;
  renderMonthlyStats(monthlyReportCache.metrics);
  notify('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø´Ù‡Ø±ÙŠ: ' + monthlyReportCache.month);
}

function downloadMonthlyPdf() {
  var month = document.getElementById('monthly-month').value;
  if (!month) {
    notify('Ø§Ø®ØªØ± Ø§Ù„Ø´Ù‡Ø± Ø£ÙˆÙ„Ù‹Ø§.');
    return;
  }
  openPdf('/reports/monthly/pdf?month=' + encodeURIComponent(month), 'monthly-executive-' + month + '.pdf');
}

function initMonthField() {
  var now = new Date();
  var month = now.getFullYear() + '-' + String(now.getMonth() + 1).padStart(2, '0');
  document.getElementById('monthly-month').value = month;
}

async function refreshAll() {
  refreshMeta();
  await Promise.all([
    loadConsents(),
    loadEmergencyCard(),
    loadHomePlans(),
    loadAppointments(),
    loadTickets(),
    loadMedication(),
    loadReferrals()
  ]);
  if (isDoctorOrAdmin() && currentSession && currentSession.role === 'admin') {
    loadMonthlyReport();
  }
  refreshMeta();
}

window.addEventListener('DOMContentLoaded', function () {
  currentSession = SmartClinicSecurity.requireAccess(['student', 'doctor', 'parent', 'admin'], 'Ù…Ø±ÙƒØ² Ø§Ù„ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø¹Ù„Ø§Ø¬ÙŠ');
  if (window.SmartClinicUI) {
    SmartClinicUI.mountQuickNav({
      afterSelector: '.sc-page-header',
      onRefresh: refreshAll,
      links: [
        { label: 'Ù…Ø±ÙƒØ² Ø§Ù„ØªÙ†Ø³ÙŠÙ‚', href: 'care-center.html' },
        { label: 'Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„Ø¯ÙˆØ±', href: SmartClinicSecurity.getRoleHomePath() },
        { label: 'Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª', href: 'notifications-center.html' }
      ]
    });
  }
  initMonthField();
  refreshAll();
  SmartClinicSecurity.createAutoRefresh(refreshAll, 25000, { immediate: false });
});
</script>
</body>
</html>
