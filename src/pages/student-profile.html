<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>الملف الصحي للطالب – Smart Clinic</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="../../assets/css/variables.css">
<link rel="stylesheet" href="../../assets/css/layout.css">
<link rel="stylesheet" href="../../assets/css/cards.css">
<link rel="stylesheet" href="../../assets/css/tables.css">
<style>
.profile-overview-grid {
  display: grid;
  grid-template-columns: repeat(2, minmax(0, 1fr));
  gap: 12px;
}

.profile-overview-item {
  border: 1px solid rgba(255, 255, 255, 0.12);
  border-radius: var(--sc-radius-md);
  background: rgba(255, 255, 255, 0.02);
  padding: 10px 12px;
}

.profile-overview-label {
  color: var(--sc-text-soft);
  font-size: 12px;
}

.profile-overview-value {
  margin-top: 4px;
  font-size: 14px;
  font-weight: 600;
}

.vitals-grid {
  display: grid;
  grid-template-columns: repeat(2, minmax(0, 1fr));
  gap: 12px;
  margin-bottom: 14px;
}

.vital {
  border: 1px solid var(--sc-border);
  border-radius: var(--sc-radius-md);
  background: rgba(255, 255, 255, 0.03);
  padding: 12px;
}

.vital-label {
  color: var(--sc-text-soft);
  font-size: 12px;
}

.vital-value {
  margin-top: 4px;
  font-size: 26px;
  font-weight: 800;
}

.risk-badge {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 4px 10px;
  border: 1px solid var(--sc-border);
  border-radius: 999px;
  font-size: 12px;
}

.vitals-trend-grid {
  display: grid;
  grid-template-columns: repeat(3, minmax(0, 1fr));
  gap: 12px;
  margin-bottom: 14px;
}

.spark-card {
  border: 1px solid var(--sc-border);
  border-radius: var(--sc-radius-md);
  background: rgba(255, 255, 255, 0.03);
  padding: 10px;
}

.spark-head {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 6px;
}

.spark-title {
  font-size: 12px;
  color: var(--sc-text-soft);
}

.spark-value {
  font-size: 13px;
  font-weight: 700;
}

.spark-svg {
  width: 100%;
  height: 78px;
  display: block;
}

.spark-meta {
  margin-top: 6px;
  color: var(--sc-text-soft);
  font-size: 11px;
}

#med-adherence-stats {
  display: grid;
  grid-template-columns: repeat(2, minmax(0, 1fr));
  gap: 12px;
  margin-bottom: 14px;
}

.doc-meta-grid {
  display: grid;
  grid-template-columns: repeat(5, minmax(0, 1fr));
  gap: 10px;
  margin-bottom: 12px;
}

.doc-meta-item {
  border: 1px solid rgba(255, 255, 255, 0.12);
  border-radius: var(--sc-radius-md);
  background: rgba(255, 255, 255, 0.03);
  padding: 10px 12px;
}

.doc-meta-label {
  color: var(--sc-text-soft);
  font-size: 12px;
}

.doc-meta-value {
  margin-top: 5px;
  font-size: 14px;
  font-weight: 700;
}

.doc-grid {
  display: grid;
  grid-template-columns: repeat(2, minmax(0, 1fr));
  gap: 12px;
}

.doc-card {
  border: 1px solid rgba(255, 255, 255, 0.12);
  border-radius: var(--sc-radius-md);
  background: linear-gradient(160deg, rgba(255, 255, 255, 0.06), rgba(255, 255, 255, 0.02));
  padding: 10px 12px;
}

.doc-card h3 {
  margin: 0 0 8px;
  font-size: 15px;
}

.doc-risk-bars {
  margin-top: 8px;
  display: grid;
  gap: 8px;
}

.doc-risk-row {
  display: grid;
  grid-template-columns: 70px 1fr 42px;
  gap: 8px;
  align-items: center;
}

.doc-risk-label {
  color: var(--sc-text-soft);
  font-size: 11px;
}

.doc-risk-track {
  height: 9px;
  border-radius: 999px;
  border: 1px solid var(--sc-border);
  background: rgba(255, 255, 255, 0.05);
  overflow: hidden;
}

.doc-risk-fill {
  height: 100%;
  background: linear-gradient(90deg, rgba(82, 196, 26, 0.9), rgba(250, 140, 22, 0.85), rgba(255, 77, 79, 0.9));
}

.doc-risk-value {
  font-size: 11px;
  color: var(--sc-text-soft);
  text-align: left;
}

.doc-compliance-grid {
  display: grid;
  grid-template-columns: repeat(2, minmax(0, 1fr));
  gap: 10px;
  margin-top: 8px;
}

.doc-compliance-item {
  border: 1px solid rgba(255, 255, 255, 0.12);
  border-radius: var(--sc-radius-md);
  background: rgba(255, 255, 255, 0.03);
  padding: 10px;
}

.doc-compliance-label {
  color: var(--sc-text-soft);
  font-size: 12px;
}

.doc-compliance-value {
  margin-top: 6px;
  font-size: 20px;
  font-weight: 800;
}

.doc-value-good {
  color: var(--sc-low);
}

.doc-value-warn {
  color: var(--sc-medium);
}

.doc-value-critical {
  color: var(--sc-critical);
}

.timeline-toolbar {
  display: grid;
  grid-template-columns: repeat(3, minmax(0, 1fr));
  gap: 8px;
  margin-bottom: 12px;
}

.timeline-list {
  display: grid;
  gap: 8px;
}

.timeline-item {
  border: 1px solid rgba(255, 255, 255, 0.12);
  border-radius: var(--sc-radius-md);
  background: rgba(255, 255, 255, 0.03);
  padding: 10px 12px;
}

.timeline-head {
  display: flex;
  justify-content: space-between;
  align-items: center;
  gap: 8px;
  flex-wrap: wrap;
}

.timeline-title {
  font-size: 14px;
  font-weight: 700;
}

.timeline-meta {
  margin-top: 4px;
  color: var(--sc-text-soft);
  font-size: 12px;
}

.timeline-tags {
  margin-top: 6px;
  display: flex;
  gap: 6px;
  flex-wrap: wrap;
}

.timeline-tag {
  display: inline-flex;
  align-items: center;
  padding: 2px 8px;
  border-radius: 999px;
  border: 1px solid rgba(255, 255, 255, 0.16);
  font-size: 11px;
}

.tag-critical {
  border-color: rgba(255, 77, 79, 0.5);
  color: var(--sc-critical);
  background: rgba(255, 77, 79, 0.14);
}

.tag-warning {
  border-color: rgba(250, 140, 22, 0.5);
  color: var(--sc-medium);
  background: rgba(250, 140, 22, 0.14);
}

.tag-info {
  border-color: rgba(56, 189, 248, 0.45);
  color: #8fd4ff;
  background: rgba(56, 189, 248, 0.12);
}

#alerts-list {
  margin-bottom: 12px;
}

.toast {
  position: fixed;
  left: 16px;
  bottom: 16px;
  background: var(--sc-surface-strong);
  border: 1px solid var(--sc-border);
  color: var(--sc-text);
  border-radius: var(--sc-radius-md);
  padding: 10px 12px;
  font-size: 12px;
  display: none;
  z-index: 40;
}

@media (max-width: 780px) {
  .doc-meta-grid,
  .doc-grid,
  .doc-compliance-grid,
  .timeline-toolbar,
  .profile-overview-grid,
  .vitals-grid,
  .vitals-trend-grid,
  #med-adherence-stats {
    grid-template-columns: 1fr;
  }
}
</style>
</head>
<body class="sc-page">
<div class="sc-shell">
  <header class="sc-page-header">
    <div class="sc-page-header-main">
      <div class="sc-page-icon" id="avatar-letter">ط</div>
      <div>
        <h1 class="sc-page-title" id="student-name">الملف الصحي للطالب</h1>
        <p class="sc-page-subtitle">الوصول حسب الصلاحية: <span data-session-role>الطالب</span></p>
      </div>
    </div>
    <div class="sc-header-actions">
      <span class="sc-role-chip">Health Passport</span>
      <button class="sc-action-btn" onclick="goRoleHome()">العودة</button>
    </div>
  </header>

  <section class="section-nav sc-section-nav">
    <button class="section-btn sc-action-btn" onclick="scrollProfileSection('documentation')">ملخص التوثيق</button>
    <button class="section-btn sc-action-btn" onclick="scrollProfileSection('timeline')">الخط الزمني</button>
    <button class="section-btn sc-action-btn" onclick="scrollProfileSection('cases')">سجل الحالات</button>
    <button class="section-btn sc-action-btn" onclick="scrollProfileSection('reports')">التقارير</button>
    <button class="section-btn sc-action-btn" onclick="scrollProfileSection('medication')">الالتزام الدوائي</button>
    <button class="section-btn sc-action-btn" onclick="scrollProfileSection('alerts')">التنبيهات والتواصل</button>
  </section>

  <section class="sc-grid-3 sc-kpi-grid sc-mb-24">
    <article class="sc-kpi-card">
      <div class="sc-kpi-label">الحالات المفتوحة</div>
      <div id="st-open" class="sc-kpi-value">0</div>
    </article>
    <article class="sc-kpi-card">
      <div class="sc-kpi-label">طلبات زيارة معلقة</div>
      <div id="st-pending" class="sc-kpi-value">0</div>
    </article>
    <article class="sc-kpi-card">
      <div class="sc-kpi-label">عدد التقارير</div>
      <div id="st-reports" class="sc-kpi-value">0</div>
    </article>
  </section>

  <section id="documentation" class="sc-panel sc-mb-24">
    <h2 class="sc-panel-title">ملخص التوثيق السريري</h2>
    <p class="sc-panel-subtitle">نسخة مخصصة للاعتماد: حالة الطالب، الامتثال العلاجي، ومؤشرات المراقبة في شاشة واحدة.</p>
    <div class="doc-meta-grid">
      <div class="doc-meta-item"><div class="doc-meta-label">النمط</div><div id="doc-mode" class="doc-meta-value">-</div></div>
      <div class="doc-meta-item"><div class="doc-meta-label">آخر مزامنة</div><div id="doc-sync" class="doc-meta-value">-</div></div>
      <div class="doc-meta-item"><div class="doc-meta-label">نطاق السجل</div><div id="doc-scope" class="doc-meta-value">-</div></div>
      <div class="doc-meta-item"><div class="doc-meta-label">اتجاه الحالة</div><div id="doc-trend" class="doc-meta-value">-</div></div>
      <div class="doc-meta-item"><div class="doc-meta-label">نسخة التوثيق</div><div id="doc-version" class="doc-meta-value">SC-CLN-2026.02</div></div>
    </div>
    <div class="doc-grid">
      <article class="doc-card">
        <h3>ملخص المسار العلاجي</h3>
        <div id="doc-summary-text" class="sc-muted">جاري بناء الملخص الطبي...</div>
        <div id="doc-next-action" class="item" style="margin-top:8px;">-</div>
        <div id="doc-risk-bars" class="doc-risk-bars"></div>
      </article>
      <article class="doc-card">
        <h3>مؤشرات الامتثال والمتابعة</h3>
        <div class="doc-compliance-grid">
          <div class="doc-compliance-item"><div class="doc-compliance-label">الالتزام الدوائي</div><div id="doc-kpi-adherence" class="doc-compliance-value">-</div></div>
          <div class="doc-compliance-item"><div class="doc-compliance-label">الأيام عالية الخطورة</div><div id="doc-kpi-riskdays" class="doc-compliance-value">-</div></div>
          <div class="doc-compliance-item"><div class="doc-compliance-label">زيارات مكتملة</div><div id="doc-kpi-visits" class="doc-compliance-value">-</div></div>
          <div class="doc-compliance-item"><div class="doc-compliance-label">التنبيهات الحرجة</div><div id="doc-kpi-alerts" class="doc-compliance-value">-</div></div>
        </div>
      </article>
    </div>
  </section>

  <section class="sc-grid-3">
    <section class="sc-panel sc-col-span-3" id="timeline">
      <h2 class="sc-panel-title">الخط الزمني السريري</h2>
      <p class="sc-panel-subtitle">تسلسل موحد للأحداث: قراءات، حالات، زيارات، تقارير، التزام دوائي، وتنبيهات.</p>
      <div class="timeline-toolbar">
        <select id="timeline-type-filter" onchange="applyTimelineFilters()">
          <option value="all">كل الأحداث</option>
          <option value="clinical">سريرية</option>
          <option value="operations">تشغيلية</option>
          <option value="communication">تواصل وتنبيهات</option>
        </select>
        <select id="timeline-window-filter" onchange="applyTimelineFilters()">
          <option value="7">آخر 7 أيام</option>
          <option value="30">آخر 30 يوم</option>
          <option value="90">آخر 90 يوم</option>
          <option value="all">كل المدة</option>
        </select>
        <button class="btn-muted" type="button" onclick="loadProfile()">تحديث الخط الزمني</button>
      </div>
      <div id="timeline-summary" class="sc-muted sc-mb-16">جاري تجهيز السجل الزمني...</div>
      <div id="clinical-timeline" class="timeline-list"></div>
    </section>

    <section class="sc-panel">
      <h2 class="sc-panel-title">الملف الصحي الأساسي</h2>
      <p class="sc-panel-subtitle">مرجع الملف الصحي للبيانات والتاريخ الطبي، بينما التنفيذ اليومي يتم عبر البوابة الحية لكل دور.</p>

      <div class="profile-overview-grid sc-mb-16">
        <div class="profile-overview-item"><div class="profile-overview-label">الاسم</div><div class="profile-overview-value" id="info-name">-</div></div>
        <div class="profile-overview-item"><div class="profile-overview-label">المعرف</div><div class="profile-overview-value" id="info-id">-</div></div>
        <div class="profile-overview-item"><div class="profile-overview-label">العمر</div><div class="profile-overview-value" id="info-age">-</div></div>
        <div class="profile-overview-item"><div class="profile-overview-label">الصف</div><div class="profile-overview-value" id="info-grade">-</div></div>
        <div class="profile-overview-item"><div class="profile-overview-label">تواصل ولي الأمر</div><div class="profile-overview-value" id="info-guardian">-</div></div>
        <div class="profile-overview-item"><div class="profile-overview-label">آخر حالة</div><div class="profile-overview-value" id="info-latest-case">-</div></div>
        <div class="profile-overview-item"><div class="profile-overview-label">آخر تحديث</div><div class="profile-overview-value" id="info-updated">-</div></div>
      </div>

      <div class="inline-row">
        <button class="btn-primary" onclick="goRoleHome()">العودة إلى البوابة الحية</button>
        <button class="btn-muted" data-permission="view.case" onclick="openLinkedCase()">تفاصيل الحالة</button>
        <button class="btn-muted" id="profile-telemed-btn" onclick="handleProfileTelemed()">الجلسة المرئية</button>
        <button class="btn-muted" data-permission="export.report" onclick="exportProfileReport()">تصدير تقرير</button>
      </div>
    </section>

    <section class="sc-panel sc-col-span-2">
      <h2 class="sc-panel-title">العلامات الحيوية والحساسات</h2>
      <p class="sc-panel-subtitle">لوحة موحدة لقراءات الحيوية، حالة الخطورة، والحساسات المرتبطة.</p>

      <div class="inline-row" style="justify-content:space-between;align-items:center;margin-bottom:12px;">
        <span id="vt-risk" class="risk-badge unknown">غير متوفر</span>
        <span class="sc-muted">آخر تحديث: <span id="vt-updated">-</span></span>
      </div>

      <div class="vitals-grid">
        <div class="vital"><div class="vital-label">الحرارة</div><div class="vital-value" id="vt-temp">-</div></div>
        <div class="vital"><div class="vital-label">الأكسجين SpO2</div><div class="vital-value" id="vt-spo2">-</div></div>
        <div class="vital"><div class="vital-label">نبض القلب</div><div class="vital-value" id="vt-hr">-</div></div>
        <div class="vital"><div class="vital-label">الضغط</div><div class="vital-value" id="vt-bp">-</div></div>
      </div>

      <div class="inline-row sc-mb-16">
        <button class="btn-primary" data-permission="update.vitals" onclick="generateVitalsReading()">توليد قراءة حساسات</button>
        <button class="btn-muted" onclick="loadProfile()">تحديث القراءات</button>
      </div>

      <h3 class="sc-panel-title">الحساسات المرتبطة</h3>
      <div id="sensors-list" class="list sc-mb-16"></div>

      <h3 class="sc-panel-title">المقارنة الزمنية للعلامات الحيوية</h3>
      <div id="vitals-trend-grid" class="vitals-trend-grid sc-mb-16"></div>

      <h3 class="sc-panel-title">آخر القراءات</h3>
      <div id="vitals-history-list" class="list"></div>
    </section>

    <section class="sc-panel sc-col-span-3" id="cases">
      <h2 class="sc-panel-title">سجل الحالات</h2>
      <p class="sc-panel-subtitle">جميع الحالات المرتبطة بالطالب حسب الصلاحية.</p>
      <div class="sc-table-wrap">
        <table class="sc-table">
          <thead>
            <tr>
              <th>عنوان الحالة</th>
              <th>الخطورة</th>
              <th>الحالة</th>
              <th>آخر تحديث</th>
            </tr>
          </thead>
          <tbody id="cases-table-body">
            <tr><td colspan="4" class="sc-table-empty">لا توجد حالات مسجلة.</td></tr>
          </tbody>
        </table>
      </div>
    </section>

    <section class="sc-panel" id="reports">
      <h2 class="sc-panel-title">التقارير الصحية</h2>
      <p class="sc-panel-subtitle">تقارير قابلة للعرض والتصدير.</p>
      <div class="sc-table-wrap">
        <table class="sc-table">
          <thead>
            <tr>
              <th>اسم التقرير</th>
              <th>التاريخ</th>
              <th>إجراء</th>
            </tr>
          </thead>
          <tbody id="reports-table-body">
            <tr><td colspan="3" class="sc-table-empty">لا توجد تقارير متاحة.</td></tr>
          </tbody>
        </table>
      </div>
    </section>

    <section class="sc-panel sc-col-span-2" id="medication">
      <h2 class="sc-panel-title">الالتزام الدوائي الأسبوعي</h2>
      <p class="sc-panel-subtitle">قياس الجرعات المنفذة والتنبيه قبل انخفاض الالتزام.</p>
      <div id="med-adherence-stats" class="stats"></div>
      <div class="inline-row sc-mb-16">
        <select id="med-plan-select"></select>
        <button class="btn-primary" onclick="logMedicationFromProfile('taken')">تم أخذ الجرعة</button>
        <button class="btn-muted" onclick="logMedicationFromProfile('skipped')">تم تجاوز الجرعة</button>
      </div>
      <div class="inline-row sc-mb-16" data-permission="prescribe.medication">
        <button class="btn-primary" onclick="createMedicationPlanFromProfile()">إضافة خطة دوائية</button>
      </div>
      <div id="med-recent-logs" class="list"></div>
    </section>

    <section class="sc-panel sc-col-span-3" id="alerts">
      <h2 class="sc-panel-title">التنبيهات والتواصل</h2>
      <p class="sc-panel-subtitle">تنبيهاتك الصحية مع قناة تواصل مباشرة.</p>
      <div id="alerts-list" class="list"></div>
      <textarea id="msg-box" rows="3" data-permission="send.message" placeholder="اكتب رسالتك للعيادة..."></textarea>
      <div class="inline-row" style="margin-top:12px;">
        <button class="btn-primary" data-permission="send.message" onclick="sendMessage()">إرسال الرسالة</button>
        <button class="btn-muted" onclick="loadProfile()">تحديث</button>
      </div>
    </section>
  </section>
</div>

<div id="toast" class="toast"></div>

<script src="../../assets/js/security.js?v=20260214c"></script>
<script src="../../assets/js/ui-shell.js?v=20260214c"></script>
<script>
var latestData = null;
var latestTelemedSessionId = '';
var profileStudentId = '';
var linkedCaseId = '';
var medPlansCache = [];
var medicationSummaryCache = null;
var messagesCache = [];
var timelineCache = [];

function qs(name) {
  var params = new URLSearchParams(window.location.search || '');
  return params.get(name);
}

function notify(text) {
  var el = document.getElementById('toast');
  el.textContent = text;
  el.style.display = 'block';
  window.setTimeout(function () { el.style.display = 'none'; }, 2200);
}

function fmtDate(value) {
  if (!value) return '-';
  return new Date(value).toLocaleString('ar-SA');
}

function fmtNum(value, digits, suffix) {
  var n = Number(value);
  if (!isFinite(n)) return '-';
  var fixed = typeof digits === 'number' ? n.toFixed(digits) : String(Math.round(n));
  return suffix ? (fixed + suffix) : fixed;
}

function escapeHtml(value) {
  return String(value || '')
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&#039;');
}

function roleAllowsStudentScope(role) {
  return role === 'doctor' || role === 'admin';
}

function getScopedStudentId() {
  var session = SmartClinicSecurity.getSession() || {};
  var requested = String(qs('studentId') || '').trim();
  if (requested && roleAllowsStudentScope(session.role)) {
    return requested;
  }
  return '';
}

function buildStudentScopeQuery() {
  var session = SmartClinicSecurity.getSession() || {};
  var scoped = profileStudentId || getScopedStudentId();
  if (!scoped || !roleAllowsStudentScope(session.role)) {
    return '';
  }
  return '?studentId=' + encodeURIComponent(scoped);
}

function downloadTextFile(filename, text) {
  var blob = new Blob([String(text || '')], { type: 'text/plain;charset=utf-8' });
  var url = URL.createObjectURL(blob);
  var link = document.createElement('a');
  link.href = url;
  link.download = filename;
  document.body.appendChild(link);
  link.click();
  link.remove();
  URL.revokeObjectURL(url);
}

function riskLabel(risk) {
  var map = {
    stable: 'مستقرة',
    warning: 'تحتاج متابعة',
    critical: 'حرجة',
    unknown: 'غير متوفر'
  };
  return map[risk] || map.unknown;
}

function severityTone(value) {
  var level = String(value || '').toLowerCase();
  if (level === 'critical' || level === 'حرجة') return 'sc-severity-critical';
  if (level === 'medium' || level === 'moderate' || level === 'warning' || level === 'متوسطة') return 'sc-severity-medium';
  if (level === 'low' || level === 'stable' || level === 'منخفضة' || level === 'مستقرة') return 'sc-severity-low';
  return '';
}

function severityLevel(value) {
  var level = String(value || '').toLowerCase();
  if (level === 'critical' || level === 'high') return 'critical';
  if (level === 'medium' || level === 'warning') return 'warning';
  return 'info';
}

function timelineTypeLabel(type) {
  if (type === 'clinical') return 'سريري';
  if (type === 'operations') return 'تشغيلي';
  if (type === 'communication') return 'تواصل';
  return 'عام';
}

function timelineSourceLabel(source) {
  if (source === 'case') return 'الحالات';
  if (source === 'vitals') return 'العلامات الحيوية';
  if (source === 'visit_request') return 'طلبات الزيارة';
  if (source === 'report') return 'التقارير';
  if (source === 'medication') return 'الالتزام الدوائي';
  if (source === 'alert') return 'التنبيهات';
  if (source === 'message') return 'الرسائل';
  return 'النظام';
}

function levelTagClass(level) {
  if (level === 'critical') return 'tag-critical';
  if (level === 'warning') return 'tag-warning';
  return 'tag-info';
}

function normalizeEventTime(value) {
  var parsed = new Date(value || 0).getTime();
  return Number.isFinite(parsed) ? parsed : 0;
}

function hasMedicationSignal(summary) {
  if (!summary) return false;
  return Number(summary.expectedDoses || 0) > 0 || Number(summary.takenDoses || 0) > 0 || Number(summary.skippedDoses || 0) > 0;
}

function effectiveAdherencePercent(analytics, medSummary) {
  var a = analytics && analytics.adherence ? analytics.adherence : {};
  if (a.percent !== null && a.percent !== undefined && Number.isFinite(Number(a.percent))) {
    return Number(a.percent);
  }
  if (medSummary && hasMedicationSignal(medSummary)) {
    return Number(medSummary.adherencePercent || 0);
  }
  return null;
}

function nextClinicalAction(data, medSummary) {
  var analytics = (data && data.parentAnalytics) || {};
  var condition = analytics.condition || {};
  var adherence = analytics.adherence || {};
  var risk = analytics.riskIndicators || {};
  var adherencePercent = effectiveAdherencePercent(analytics, medSummary);
  var highDays = Number(risk.highDays || 0);
  if (condition.direction === 'deteriorating' || highDays >= 2) {
    return 'يوصى بتصعيد المتابعة: تحديد مراجعة عاجلة مع تحديث العلامات الحيوية خلال نفس اليوم.';
  }
  if (adherence.status === 'warning' || (adherencePercent !== null && adherencePercent < 80)) {
    return 'يوصى بتثبيت جرعات الدواء بمنبهات منتظمة وإعادة تقييم الالتزام خلال 48 ساعة.';
  }
  if (Number((analytics.visits || {}).pending || 0) > 0) {
    return 'يوصى بمتابعة طلبات الزيارة المفتوحة حتى الإغلاق مع توثيق أي أعراض جديدة.';
  }
  return 'المسار مستقر حاليًا: الاستمرار على الخطة العلاجية والمراجعة الدورية الأسبوعية.';
}

function renderDocumentationSummary(data, medSummary) {
  var payload = data || {};
  var analytics = payload.parentAnalytics || {};
  var condition = analytics.condition || {};
  var risk = analytics.riskIndicators || {};
  var visits = analytics.visits || {};
  var adherence = analytics.adherence || {};
  var latestCase = payload.latestCase || {};
  var alerts = Array.isArray(payload.alerts) ? payload.alerts : [];
  var riskTimeline = Array.isArray(analytics.riskTimeline) ? analytics.riskTimeline.slice(-7) : [];
  var adherencePercent = effectiveAdherencePercent(analytics, medSummary);

  document.getElementById('doc-mode').textContent = SmartClinicSecurity.isDemoMode() ? 'Demo' : 'Live';
  document.getElementById('doc-sync').textContent = new Date().toLocaleTimeString('ar-SA');
  document.getElementById('doc-scope').textContent = payload.student && payload.student.id ? payload.student.id : (profileStudentId || 'u_student_1');
  document.getElementById('doc-trend').textContent = condition.label || riskLabel((payload.snapshot || {}).latestVitalsRisk || 'unknown');

  var summaryText = condition.summary || 'لا توجد خلاصة علاجية كافية بعد.';
  if (latestCase && latestCase.title) {
    summaryText += ' | آخر حالة موثقة: ' + latestCase.title + '.';
  }
  document.getElementById('doc-summary-text').textContent = summaryText;
  document.getElementById('doc-next-action').textContent = nextClinicalAction(payload, medSummary);

  var riskBarsWrap = document.getElementById('doc-risk-bars');
  if (!riskTimeline.length) {
    riskBarsWrap.innerHTML = '<div class="item">لا تتوفر نقاط زمنية كافية حتى الآن.</div>';
  } else {
    riskBarsWrap.innerHTML = riskTimeline.map(function (point) {
      var score = Math.max(0, Math.min(100, Number(point.score || 0)));
      var date = new Date(String(point.date || '') + 'T12:00:00Z');
      var day = Number.isFinite(date.getTime()) ? date.toLocaleDateString('ar-SA', { weekday: 'short' }) : '-';
      return '<div class="doc-risk-row">' +
        '<div class="doc-risk-label">' + day + '</div>' +
        '<div class="doc-risk-track"><div class="doc-risk-fill" style="width:' + score + '%"></div></div>' +
        '<div class="doc-risk-value">' + score + '</div>' +
      '</div>';
    }).join('');
  }

  var adherenceText = adherencePercent === null ? 'غير مفعل' : (Math.round(adherencePercent) + '%');
  var adherenceTone = adherencePercent === null ? 'doc-value-warn' : (adherencePercent < 80 ? 'doc-value-critical' : 'doc-value-good');
  var highRiskDays = Number(risk.highDays || 0);
  var riskTone = highRiskDays > 1 ? 'doc-value-critical' : (highRiskDays > 0 ? 'doc-value-warn' : 'doc-value-good');
  var visitsDone = Number(visits.completed || 0);
  var visitsTone = visitsDone > 0 ? 'doc-value-good' : 'doc-value-warn';
  var criticalAlerts = alerts.filter(function (item) { return String(item.type || 'info') === 'critical'; }).length;
  var alertTone = criticalAlerts > 0 ? 'doc-value-critical' : 'doc-value-good';

  var adherenceEl = document.getElementById('doc-kpi-adherence');
  var riskEl = document.getElementById('doc-kpi-riskdays');
  var visitsEl = document.getElementById('doc-kpi-visits');
  var alertsEl = document.getElementById('doc-kpi-alerts');
  adherenceEl.className = 'doc-compliance-value ' + adherenceTone;
  riskEl.className = 'doc-compliance-value ' + riskTone;
  visitsEl.className = 'doc-compliance-value ' + visitsTone;
  alertsEl.className = 'doc-compliance-value ' + alertTone;
  adherenceEl.textContent = adherenceText;
  riskEl.textContent = String(highRiskDays);
  visitsEl.textContent = String(visitsDone);
  alertsEl.textContent = String(criticalAlerts);
}

function buildClinicalTimeline(data, medSummary, messages) {
  var payload = data || {};
  var events = [];

  (payload.cases || []).forEach(function (item) {
    events.push({
      id: 'case_' + String(item.id || Math.random()),
      at: item.updatedAt || '',
      type: 'clinical',
      source: 'case',
      level: severityLevel(item.severity),
      title: 'تحديث حالة: ' + (item.title || 'حالة صحية'),
      meta: 'الشدة: ' + (item.severity || '-') + ' • الحالة: ' + (item.status || '-'),
      details: item.notes ? ('ملاحظة: ' + item.notes) : ''
    });
  });

  (payload.vitalsHistory || []).slice(0, 30).forEach(function (reading) {
    events.push({
      id: 'vit_' + String(reading.id || Math.random()),
      at: reading.measuredAt || '',
      type: 'clinical',
      source: 'vitals',
      level: severityLevel(reading.risk || 'stable'),
      title: 'قراءة حيوية ' + riskLabel(reading.risk || 'unknown'),
      meta: 'Temp ' + fmtNum(reading.temp, 1, '°C') + ' • SpO2 ' + fmtNum(reading.spo2, 0, '%') + ' • HR ' + fmtNum(reading.hr, 0, ' bpm'),
      details: 'ضغط الدم: ' + fmtNum(reading.bpSys, 0) + '/' + fmtNum(reading.bpDia, 0) + ' • المصدر: ' + (reading.source || 'manual')
    });
  });

  (payload.visitRequests || []).forEach(function (visit) {
    var status = String(visit.status || 'pending');
    var level = status === 'pending' ? 'warning' : 'info';
    events.push({
      id: 'visit_' + String(visit.id || Math.random()),
      at: visit.createdAt || '',
      type: 'operations',
      source: 'visit_request',
      level: level,
      title: 'طلب زيارة (' + status + ')',
      meta: visit.reason || '-',
      details: ''
    });
  });

  (payload.reports || []).forEach(function (report) {
    events.push({
      id: 'report_' + String(report.id || Math.random()),
      at: report.createdAt || '',
      type: 'operations',
      source: 'report',
      level: 'info',
      title: 'إصدار تقرير: ' + (report.title || 'تقرير صحي'),
      meta: 'مؤرشف في ملف الطالب',
      details: ''
    });
  });

  (payload.alerts || []).forEach(function (alert) {
    var alertType = String(alert.type || 'info');
    var level = alertType === 'critical' ? 'critical' : (alertType === 'operational' ? 'warning' : 'info');
    events.push({
      id: 'alert_' + String(alert.id || Math.random()),
      at: alert.createdAt || '',
      type: 'communication',
      source: 'alert',
      level: level,
      title: 'تنبيه: ' + (alert.text || 'تنبيه'),
      meta: 'النوع: ' + alertType,
      details: ''
    });
  });

  if (medSummary) {
    (medSummary.recentLogs || []).forEach(function (entry) {
      var skipped = String(entry.status || '') === 'skipped';
      events.push({
        id: 'med_' + String(entry.id || Math.random()),
        at: entry.takenAt || entry.createdAt || '',
        type: 'clinical',
        source: 'medication',
        level: skipped ? 'warning' : 'info',
        title: skipped ? 'تجاوز جرعة دوائية' : 'تسجيل جرعة دوائية',
        meta: (entry.planName || 'خطة دوائية') + ' • ' + (skipped ? 'Skipped' : 'Taken'),
        details: entry.note || ''
      });
    });
    if (hasMedicationSignal(medSummary) && Number(medSummary.adherencePercent || 100) < 80) {
      events.push({
        id: 'med_adherence_' + String(medSummary.weekEnd || new Date().toISOString()),
        at: medSummary.weekEnd || new Date().toISOString(),
        type: 'clinical',
        source: 'medication',
        level: 'warning',
        title: 'انخفاض الالتزام الدوائي',
        meta: 'نسبة الالتزام الأسبوعية: ' + Number(medSummary.adherencePercent || 0) + '%',
        details: medSummary.alert || 'الالتزام أقل من الحد الآمن 80%'
      });
    }
  }

  (messages || []).forEach(function (message) {
    events.push({
      id: 'msg_' + String(message.id || Math.random()),
      at: message.createdAt || '',
      type: 'communication',
      source: 'message',
      level: 'info',
      title: 'رسالة: ' + (message.text ? message.text.slice(0, 60) : 'تواصل جديد'),
      meta: 'المرسل: ' + (message.fromRole || '-'),
      details: message.text && message.text.length > 60 ? message.text : ''
    });
  });

  return events
    .filter(function (event) { return normalizeEventTime(event.at) > 0; })
    .sort(function (a, b) { return normalizeEventTime(b.at) - normalizeEventTime(a.at); });
}

function renderTimelineItems(items) {
  var wrap = document.getElementById('clinical-timeline');
  if (!items.length) {
    wrap.innerHTML = '<div class="timeline-item">لا توجد أحداث مطابقة للفلاتر الحالية.</div>';
    return;
  }
  wrap.innerHTML = items.map(function (event) {
    return '<article class="timeline-item">' +
      '<div class="timeline-head">' +
        '<div class="timeline-title">' + escapeHtml(event.title || 'حدث') + '</div>' +
        '<span class="timeline-tag ' + levelTagClass(event.level) + '">' + escapeHtml(fmtDate(event.at)) + '</span>' +
      '</div>' +
      '<div class="timeline-meta">' + escapeHtml(event.meta || '-') + '</div>' +
      (event.details ? ('<div class="timeline-meta">' + escapeHtml(event.details) + '</div>') : '') +
      '<div class="timeline-tags">' +
        '<span class="timeline-tag tag-info">' + timelineTypeLabel(event.type) + '</span>' +
        '<span class="timeline-tag tag-info">' + timelineSourceLabel(event.source) + '</span>' +
      '</div>' +
    '</article>';
  }).join('');
}

function applyTimelineFilters() {
  var typeFilter = document.getElementById('timeline-type-filter').value || 'all';
  var windowFilter = document.getElementById('timeline-window-filter').value || '7';
  var filtered = timelineCache.slice();
  if (typeFilter !== 'all') {
    filtered = filtered.filter(function (event) { return event.type === typeFilter; });
  }
  if (windowFilter !== 'all') {
    var days = Number(windowFilter || 7);
    var from = Date.now() - (days * 24 * 60 * 60 * 1000);
    filtered = filtered.filter(function (event) { return normalizeEventTime(event.at) >= from; });
  }
  renderTimelineItems(filtered);
  document.getElementById('timeline-summary').textContent =
    'الأحداث المعروضة: ' + filtered.length + ' من أصل ' + timelineCache.length + ' حدث.';
}

function renderDocumentationPanels() {
  renderDocumentationSummary(latestData || {}, medicationSummaryCache);
  timelineCache = buildClinicalTimeline(latestData || {}, medicationSummaryCache, messagesCache || []);
  applyTimelineFilters();
}

function renderCasesTable(items) {
  var tbody = document.getElementById('cases-table-body');
  if (!items || !items.length) {
    tbody.innerHTML = '<tr><td colspan="4" class="sc-table-empty">لا توجد حالات مسجلة.</td></tr>';
    return;
  }
  tbody.innerHTML = items.map(function (c) {
    var tone = severityTone(c.severity);
    return '<tr>' +
      '<td>' + escapeHtml(c.title || 'حالة') + '</td>' +
      '<td><span class="sc-badge ' + tone + '">' + escapeHtml(c.severity || '-') + '</span></td>' +
      '<td>' + escapeHtml(c.status || '-') + '</td>' +
      '<td>' + escapeHtml(fmtDate(c.updatedAt)) + '</td>' +
    '</tr>';
  }).join('');
}

function renderReportsTable(items) {
  var tbody = document.getElementById('reports-table-body');
  if (!items || !items.length) {
    tbody.innerHTML = '<tr><td colspan="3" class="sc-table-empty">لا توجد تقارير متاحة.</td></tr>';
    return;
  }
  tbody.innerHTML = items.map(function (r) {
    var id = String((r && r.id) || '');
    var action = id
      ? ('<button class="btn-muted" type="button" onclick="exportProfileReport(\'' + escapeHtml(id) + '\')">تصدير</button>')
      : '-';
    return '<tr>' +
      '<td>' + escapeHtml(r.title || 'تقرير') + '</td>' +
      '<td>' + escapeHtml(fmtDate(r.createdAt)) + '</td>' +
      '<td>' + action + '</td>' +
    '</tr>';
  }).join('');
}

function renderList(id, items, emptyText, mapper) {
  var wrap = document.getElementById(id);
  if (!items || !items.length) {
    wrap.innerHTML = '<div class="item">' + emptyText + '</div>';
    return;
  }
  wrap.innerHTML = items.map(mapper).join('');
}

function scrollProfileSection(id) {
  var target = document.getElementById(id);
  if (target) {
    target.scrollIntoView({ behavior: 'smooth', block: 'start' });
  }
}

function asPoints(history, key) {
  if (!Array.isArray(history)) return [];
  return history.map(function (item) {
    return {
      at: item && item.measuredAt ? String(item.measuredAt) : '',
      value: Number(item && item[key])
    };
  }).filter(function (item) {
    return Number.isFinite(item.value);
  }).sort(function (a, b) {
    return new Date(a.at).getTime() - new Date(b.at).getTime();
  });
}

function trendCardHtml(label, color, points, suffix, decimals) {
  if (!points.length) {
    return '<div class="spark-card"><div class="spark-head"><div class="spark-title">' + label + '</div><div class="spark-value">-</div></div><div class="spark-meta">لا توجد بيانات كافية للرسم.</div></div>';
  }

  var recent = points.slice(-12);
  var values = recent.map(function (p) { return p.value; });
  var minVal = Math.min.apply(Math, values);
  var maxVal = Math.max.apply(Math, values);
  var range = (maxVal - minVal) || 1;
  var width = 280;
  var height = 78;
  var padX = 8;
  var padY = 8;
  var xSpan = width - (padX * 2);
  var ySpan = height - (padY * 2);

  var polyline = recent.map(function (point, index) {
    var x = recent.length === 1 ? (width / 2) : (padX + ((index / (recent.length - 1)) * xSpan));
    var y = padY + (1 - ((point.value - minVal) / range)) * ySpan;
    return x.toFixed(2) + ',' + y.toFixed(2);
  }).join(' ');

  var latestPoint = recent[recent.length - 1];
  var latestValue = typeof decimals === 'number' ? latestPoint.value.toFixed(decimals) : String(Math.round(latestPoint.value));
  var from = fmtDate(recent[0].at);
  var to = fmtDate(latestPoint.at);
  var viewBox = '0 0 ' + width + ' ' + height;

  return '<div class="spark-card">' +
    '<div class="spark-head"><div class="spark-title">' + label + '</div><div class="spark-value">' + latestValue + suffix + '</div></div>' +
    '<svg class="spark-svg" viewBox="' + viewBox + '" preserveAspectRatio="none">' +
      '<polyline points="' + polyline + '" fill="none" stroke="' + color + '" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"></polyline>' +
    '</svg>' +
    '<div class="spark-meta">من ' + from + ' إلى ' + to + '</div>' +
  '</div>';
}

function renderVitalsTrend(history, latest) {
  var wrap = document.getElementById('vitals-trend-grid');
  var source = Array.isArray(history) ? history.slice() : [];
  if (latest && latest.measuredAt) {
    source.push({
      measuredAt: latest.measuredAt,
      temp: latest.temp,
      spo2: latest.spo2,
      hr: latest.hr
    });
  }

  var tempPoints = asPoints(source, 'temp');
  var spo2Points = asPoints(source, 'spo2');
  var hrPoints = asPoints(source, 'hr');

  wrap.innerHTML = [
    trendCardHtml('درجة الحرارة', '#ff7875', tempPoints, '°C', 1),
    trendCardHtml('الأكسجين SpO2', '#69c0ff', spo2Points, '%', 0),
    trendCardHtml('نبض القلب', '#95de64', hrPoints, ' bpm', 0)
  ].join('');
}

function renderVitals(data) {
  var latest = data && data.latestVitals ? data.latestVitals : null;
  var risk = latest ? (latest.risk || 'unknown') : 'unknown';
  var riskEl = document.getElementById('vt-risk');
  riskEl.className = 'risk-badge ' + risk;
  riskEl.textContent = 'الحالة: ' + riskLabel(risk);
  document.getElementById('vt-updated').textContent = latest ? fmtDate(latest.measuredAt) : '-';
  document.getElementById('vt-temp').textContent = latest ? fmtNum(latest.temp, 1, '°C') : '-';
  document.getElementById('vt-spo2').textContent = latest ? fmtNum(latest.spo2, 0, '%') : '-';
  document.getElementById('vt-hr').textContent = latest ? fmtNum(latest.hr, 0, ' bpm') : '-';
  document.getElementById('vt-bp').textContent = latest ? (fmtNum(latest.bpSys, 0) + '/' + fmtNum(latest.bpDia, 0) + ' mmHg') : '-';

  renderList('sensors-list', data && data.sensors, 'لا توجد حساسات مربوطة.', function (s) {
    var battery = fmtNum(s.battery, 0, '%');
    return '<div class="item"><div class="item-title">' + (s.label || s.type || 'حساس') + '</div><div class="item-meta">الحالة: ' + (s.status || 'unknown') + ' • البطارية: ' + battery + ' • آخر تواصل: ' + fmtDate(s.lastSeenAt) + '</div></div>';
  });

  renderList('vitals-history-list', data && data.vitalsHistory, 'لا توجد قراءات مسجلة بعد.', function (v) {
    var line = fmtNum(v.temp, 1, '°C') + ' • ' + fmtNum(v.spo2, 0, '%') + ' • ' + fmtNum(v.hr, 0, ' bpm') + ' • ' + fmtNum(v.bpSys, 0) + '/' + fmtNum(v.bpDia, 0);
    return '<div class="item"><div class="item-title">' + line + '</div><div class="item-meta">' + fmtDate(v.measuredAt) + ' • المصدر: ' + (v.source || 'manual') + ' • الحالة: ' + riskLabel(v.risk || 'unknown') + '</div></div>';
  });

  renderVitalsTrend((data && data.vitalsHistory) || [], latest);
}

function renderProfile(data) {
  latestData = data || {};
  var student = latestData.student || {};
  var snapshot = latestData.snapshot || {};
  var latestCase = latestData.latestCase || null;
  linkedCaseId = String(qs('caseId') || (latestCase && latestCase.id) || '').trim();
  profileStudentId = student.id || getScopedStudentId() || 'u_student_1';

  var name = student.name || 'طالب';
  document.getElementById('student-name').textContent = name;
  document.getElementById('avatar-letter').textContent = name.charAt(0);
  document.getElementById('info-name').textContent = name;
  document.getElementById('info-id').textContent = student.id || '-';
  document.getElementById('info-age').textContent = student.age ? (student.age + ' سنة') : '-';
  document.getElementById('info-grade').textContent = student.grade || '-';
  document.getElementById('info-guardian').textContent = student.guardianPhone || '-';
  document.getElementById('info-latest-case').textContent = latestCase ? (latestCase.title + ' (' + latestCase.severity + ')') : 'لا توجد حالة';
  document.getElementById('info-updated').textContent = latestCase ? fmtDate(latestCase.updatedAt) : '-';

  document.getElementById('st-open').textContent = Number(snapshot.openCases || 0);
  document.getElementById('st-pending').textContent = Number(snapshot.pendingVisits || 0);
  document.getElementById('st-reports').textContent = Number(snapshot.reports || 0);

  renderCasesTable(latestData.cases || []);
  renderReportsTable(latestData.reports || []);

  renderList('alerts-list', latestData.alerts, 'لا توجد تنبيهات جديدة.', function (a) {
    return '<div class="item"><div class="item-title">' + (a.text || 'تنبيه') + '</div><div class="item-meta">' + fmtDate(a.createdAt) + '</div></div>';
  });

  renderVitals(latestData);
  renderDocumentationPanels();
}

function openLinkedCase() {
  var session = SmartClinicSecurity.getSession() || {};
  if (session.role !== 'doctor' && session.role !== 'admin') {
    var target = document.getElementById('cases');
    if (target) target.scrollIntoView({ behavior: 'smooth', block: 'start' });
    return;
  }
  if (!linkedCaseId && latestData && Array.isArray(latestData.cases) && latestData.cases.length) {
    linkedCaseId = latestData.cases[0].id || '';
  }
  if (!linkedCaseId) {
    notify('لا توجد حالة مرتبطة لفتحها الآن.');
    return;
  }
  window.location.href = 'case-details.html?id=' + encodeURIComponent(linkedCaseId);
}

async function refreshProfileTelemed() {
  var session = SmartClinicSecurity.getSession() || {};
  var role = session.role || 'student';
  var query = {
    role: role,
    caseId: linkedCaseId || undefined,
    includeEnded: false
  };
  var current = await SmartClinicSecurity.getLatestTelemedSession(query);
  latestTelemedSessionId = current && current.id ? current.id : '';

  var btn = document.getElementById('profile-telemed-btn');
  if (!btn) return;
  if (role === 'doctor' || role === 'admin') {
    btn.disabled = false;
    btn.textContent = latestTelemedSessionId ? 'فتح الجلسة المرئية' : 'بدء جلسة مرئية';
    return;
  }
  btn.disabled = !latestTelemedSessionId;
  btn.textContent = latestTelemedSessionId ? 'الانضمام للجلسة المرئية' : 'لا توجد جلسة مرئية';
}

async function handleProfileTelemed() {
  var session = SmartClinicSecurity.getSession() || {};
  var role = session.role || 'student';
  if (role === 'doctor' || role === 'admin') {
    if (latestTelemedSessionId) {
      window.location.href = SmartClinicSecurity.getTelemedRoomPath(latestTelemedSessionId);
      return;
    }
    var caseId = linkedCaseId || ((latestData && latestData.latestCase && latestData.latestCase.id) || '');
    if (!caseId) {
      notify('لا توجد حالة نشطة لبدء الجلسة.');
      return;
    }
    var allowGuardian = window.confirm('هل تريد السماح لولي الأمر بالانضمام لهذه الجلسة؟');
    var create = await SmartClinicSecurity.createTelemedSession({
      caseId: caseId,
      studentId: profileStudentId || 'u_student_1',
      allowGuardian: allowGuardian,
      title: 'جلسة مرئية من الملف الصحي للحالة ' + caseId
    });
    if (!create.ok || !create.item) {
      notify(create.error || 'تعذر بدء الجلسة المرئية.');
      return;
    }
    latestTelemedSessionId = create.item.id;
    window.location.href = SmartClinicSecurity.getTelemedRoomPath(create.item.id);
    return;
  }

  if (!latestTelemedSessionId) {
    await refreshProfileTelemed();
    notify('لا توجد جلسة مرئية متاحة حاليًا.');
    return;
  }
  var inviteRole = role === 'parent' ? 'parent' : 'student';
  var invite = await SmartClinicSecurity.createTelemedInvite(latestTelemedSessionId, inviteRole);
  if (!invite.ok || !invite.item || !invite.item.token) {
    notify(invite.error || 'تعذر تجهيز رابط انضمام آمن.');
    return;
  }
  window.location.href = SmartClinicSecurity.getTelemedRoomPath(latestTelemedSessionId, invite.item.token);
}

async function exportProfileReport(reportId) {
  var reqBody = reportId ? { reportId: reportId } : {};
  var exportResult = await SmartClinicSecurity.apiJson('/reports/export', {
    method: 'POST',
    body: JSON.stringify(reqBody)
  });
  if (!exportResult.ok || !exportResult.data) {
    notify(exportResult.error || 'تعذر تصدير التقرير.');
    return;
  }
  var student = (latestData && latestData.student) || {};
  var snapshot = (latestData && latestData.snapshot) || {};
  var latestCase = (latestData && latestData.latestCase) || {};
  var latestVitals = (latestData && latestData.latestVitals) || {};
  var analytics = (latestData && latestData.parentAnalytics) || {};
  var condition = analytics.condition || {};
  var risk = analytics.riskIndicators || {};
  var adherencePercent = effectiveAdherencePercent(analytics, medicationSummaryCache);
  var timelineLines = (timelineCache || []).slice(0, 8).map(function (event) {
    return fmtDate(event.at) + ' | ' + event.title + ' | ' + timelineTypeLabel(event.type);
  });
  var fileBase = String((exportResult.data.filename || 'student-report').replace(/\.pdf$/i, ''));
  var body = [
    'Smart Clinic Student Profile Export',
    'Generated At: ' + new Date().toISOString(),
    'Student: ' + (student.name || '-'),
    'Student ID: ' + (student.id || profileStudentId || '-'),
    'Grade: ' + (student.grade || '-'),
    '--- Snapshot ---',
    'Open Cases: ' + Number(snapshot.openCases || 0),
    'Pending Visits: ' + Number(snapshot.pendingVisits || 0),
    'Reports: ' + Number(snapshot.reports || 0),
    'Alerts: ' + Number(snapshot.alerts || 0),
    'Condition Trend: ' + (condition.label || '-'),
    'Condition Summary: ' + (condition.summary || '-'),
    'Medication Adherence: ' + (adherencePercent === null ? 'inactive' : (Math.round(adherencePercent) + '%')),
    'High Risk Days (7d): ' + Number(risk.highDays || 0),
    '--- Latest Case ---',
    (latestCase.title || '-') + ' | ' + (latestCase.severity || '-') + ' | ' + fmtDate(latestCase.updatedAt),
    '--- Latest Vitals ---',
    'Temp: ' + fmtNum(latestVitals.temp, 1, '°C'),
    'SpO2: ' + fmtNum(latestVitals.spo2, 0, '%'),
    'HR: ' + fmtNum(latestVitals.hr, 0, ' bpm'),
    'BP: ' + fmtNum(latestVitals.bpSys, 0) + '/' + fmtNum(latestVitals.bpDia, 0),
    'Risk: ' + riskLabel(latestVitals.risk || 'unknown'),
    '--- Clinical Timeline (Top 8) ---'
  ].concat(timelineLines.length ? timelineLines : ['-']).join('\n');
  downloadTextFile(fileBase + '-snapshot.txt', body);
  notify(exportResult.data.message || 'تم تجهيز التقرير للتنزيل.');
}

function renderMedicationAdherence(data) {
  var summary = data || {};
  medPlansCache = Array.isArray(summary.plans) ? summary.plans.slice() : [];
  var adherence = Number(summary.adherencePercent || 0);
  var warnClass = adherence < 80 ? ' warn' : '';
  document.getElementById('med-adherence-stats').innerHTML = [
    ['نسبة الالتزام', adherence + '%', warnClass],
    ['الجرعات المتوقعة', Number(summary.expectedDoses || 0), ''],
    ['الجرعات المنفذة', Number(summary.takenDoses || 0), ''],
    ['الجرعات المتجاوزة', Number(summary.skippedDoses || 0), '']
  ].map(function (item) {
    return '<div class="stat"><div class="stat-label">' + item[0] + '</div><div class="stat-value' + item[2] + '">' + item[1] + '</div></div>';
  }).join('');

  var select = document.getElementById('med-plan-select');
  if (!medPlansCache.length) {
    select.innerHTML = '<option value="">لا توجد خطط دوائية نشطة</option>';
  } else {
    select.innerHTML = medPlansCache.map(function (plan) {
      return '<option value="' + escapeHtml(plan.id) + '">' + escapeHtml(plan.name || plan.id) + ' • ' + Number(plan.dosesPerDay || 1) + ' جرعات/يوم</option>';
    }).join('');
  }

  renderList('med-recent-logs', summary.recentLogs, 'لا توجد سجلات جرعات حتى الآن.', function (entry) {
    var state = entry.status === 'taken' ? 'تم أخذ الجرعة' : 'تم تجاوز الجرعة';
    return '<div class="item"><div class="item-title">' + escapeHtml(entry.planName || 'خطة دوائية') + ' • ' + state + '</div><div class="item-meta">' + fmtDate(entry.takenAt || entry.createdAt) + '</div></div>';
  });
}

async function loadMedicationAdherence() {
  var result = await SmartClinicSecurity.apiJson('/medications/adherence' + buildStudentScopeQuery());
  if (!result.ok || !result.data) {
    medicationSummaryCache = null;
    renderList('med-recent-logs', [], 'تعذر تحميل بيانات الالتزام الدوائي.', function () { return ''; });
    document.getElementById('med-adherence-stats').innerHTML = '<div class="stat"><div class="stat-label">الالتزام</div><div class="stat-value">-</div></div>';
    document.getElementById('med-plan-select').innerHTML = '<option value="">غير متوفر</option>';
    renderDocumentationPanels();
    return null;
  }
  medicationSummaryCache = result.data;
  renderMedicationAdherence(result.data);
  renderDocumentationPanels();
  return medicationSummaryCache;
}

async function logMedicationFromProfile(status) {
  var desired = status === 'skipped' ? 'skipped' : 'taken';
  var select = document.getElementById('med-plan-select');
  var planId = select ? String(select.value || '') : '';
  if (!planId && !profileStudentId) {
    notify('لا توجد خطة دوائية قابلة للتحديث.');
    return;
  }
  var payload = {
    status: desired,
    note: 'تحديث من صفحة الملف الصحي'
  };
  if (planId) {
    payload.planId = planId;
  } else {
    payload.studentId = profileStudentId;
  }
  var result = await SmartClinicSecurity.apiJson('/medications/logs', {
    method: 'POST',
    body: JSON.stringify(payload)
  });
  if (!result.ok) {
    notify(result.error || 'تعذر تحديث سجل الجرعات.');
    return;
  }
  notify(desired === 'taken' ? 'تم تسجيل الجرعة كمأخوذة.' : 'تم تسجيل الجرعة كتجاوز.');
  loadMedicationAdherence();
}

async function createMedicationPlanFromProfile() {
  var name = window.prompt('اسم الدواء:', 'Paracetamol 500mg');
  if (name === null) return;
  name = String(name || '').trim();
  if (!name) {
    notify('اسم الدواء مطلوب.');
    return;
  }
  var dosesRaw = window.prompt('عدد الجرعات اليومية (1-8):', '2');
  if (dosesRaw === null) return;
  var doses = Number(dosesRaw);
  if (!Number.isFinite(doses) || doses < 1 || doses > 8) {
    notify('عدد الجرعات يجب أن يكون بين 1 و 8.');
    return;
  }
  var instructions = window.prompt('تعليمات الاستخدام:', 'بعد الأكل لمدة 5 أيام') || '';
  var result = await SmartClinicSecurity.apiJson('/medications/plans', {
    method: 'POST',
    body: JSON.stringify({
      studentId: profileStudentId || getScopedStudentId() || 'u_student_1',
      name: name,
      dosesPerDay: Math.round(doses),
      instructions: String(instructions).trim()
    })
  });
  if (!result.ok) {
    notify(result.error || 'تعذر إنشاء الخطة الدوائية.');
    return;
  }
  notify('تم إنشاء خطة دوائية جديدة.');
  loadMedicationAdherence();
}

async function loadProfile() {
  try {
    var query = getScopedStudentId();
    var endpoint = '/student/overview' + (query ? ('?studentId=' + encodeURIComponent(query)) : '');
    var messagesPromise = SmartClinicSecurity.apiJson('/messages');
    var response = await SmartClinicSecurity.apiRequest(endpoint);
    var payload = await response.json();
    if (!response.ok) {
      notify(payload.error || 'تعذر تحميل الملف الصحي.');
      return;
    }
    renderProfile(payload);
    var msgResult = await messagesPromise;
    if (msgResult.ok && msgResult.data && Array.isArray(msgResult.data.items)) {
      messagesCache = msgResult.data.items
        .slice()
        .sort(function (a, b) { return normalizeEventTime(b.createdAt) - normalizeEventTime(a.createdAt); })
        .slice(0, 40);
    } else {
      messagesCache = [];
    }
    renderDocumentationPanels();
    await loadMedicationAdherence();
    await refreshProfileTelemed();
  } catch (err) {
    notify('تعذر الاتصال بالخادم.');
  }
}

async function sendMessage() {
  var text = document.getElementById('msg-box').value.trim();
  if (!text) {
    notify('اكتب رسالة أولًا.');
    return;
  }
  try {
    var response = await SmartClinicSecurity.apiRequest('/messages', {
      method: 'POST',
      body: JSON.stringify({ text: text })
    });
    var payload = await response.json();
    if (!response.ok) {
      notify(payload.error || 'تعذر إرسال الرسالة.');
      return;
    }
    document.getElementById('msg-box').value = '';
    if (payload && payload.item) {
      messagesCache.unshift(payload.item);
      messagesCache = messagesCache.slice(0, 40);
      renderDocumentationPanels();
    }
    notify('تم إرسال الرسالة للفريق الصحي.');
  } catch (err) {
    notify('تعذر الاتصال بالخادم.');
  }
}

async function generateVitalsReading() {
  try {
    var studentId = profileStudentId || getScopedStudentId() || 'u_student_1';
    var response = await SmartClinicSecurity.apiRequest('/vitals/generate', {
      method: 'POST',
      body: JSON.stringify({ studentId: studentId, profile: 'normal' })
    });
    var payload = await response.json();
    if (!response.ok) {
      notify(payload.error || 'تعذر توليد القراءة.');
      return;
    }
    notify('تم توليد قراءة حساسات جديدة.');
    loadProfile();
  } catch (err) {
    notify('تعذر الاتصال بالخادم.');
  }
}

function goRoleHome() {
  var session = SmartClinicSecurity.getSession();
  if (!session) {
    window.location.href = '../../index.html';
    return;
  }
  var map = {
    student: 'student-portal.html',
    doctor: 'doctor.html',
    parent: 'parent-portal.html',
    admin: 'admin-dashboard.html'
  };
  window.location.href = map[session.role] || '../../index.html';
}

window.addEventListener('DOMContentLoaded', function () {
  var auth = SmartClinicSecurity.requireAccess(['student', 'doctor', 'parent', 'admin'], 'ملف الطالب');
  if (window.SmartClinicUI) {
    var links = [
      { label: 'الملف الصحي', href: 'student-profile.html' },
      { label: 'بوابة الطالب', href: 'student-portal.html', roles: ['student', 'admin'] },
      { label: 'لوحة الطبيب', href: 'doctor.html', roles: ['doctor', 'admin'] },
      { label: 'بوابة ولي الأمر', href: 'parent-portal.html', roles: ['parent', 'admin'] },
      { label: 'مركز التنسيق', href: 'care-center.html', roles: ['doctor', 'parent', 'admin'] },
      { label: 'الإشعارات', href: 'notifications-center.html' }
    ];
    if (auth && (auth.role === 'doctor' || auth.role === 'admin')) {
      links.push({ label: 'تفاصيل الحالة', href: linkedCaseId ? ('case-details.html?id=' + encodeURIComponent(linkedCaseId)) : 'case-details.html?id=case_1' });
    }
    SmartClinicUI.mountQuickNav({
      afterSelector: '.sc-page-header',
      onRefresh: loadProfile,
      links: links,
      hideShellActions: true
    });
  }
  if (window.location.hash) {
    var targetId = String(window.location.hash || '').replace('#', '').trim();
    if (targetId) {
      window.setTimeout(function () { scrollProfileSection(targetId); }, 120);
    }
  }
  SmartClinicSecurity.createAutoRefresh(loadProfile, 20000, { immediate: true });
});
</script>
</body>
</html>
