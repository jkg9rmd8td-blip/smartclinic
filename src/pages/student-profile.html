<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>الملف الصحي للطالب – Smart Clinic</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="../../assets/css/variables.css">
<link rel="stylesheet" href="../../assets/css/layout.css">
<link rel="stylesheet" href="../../assets/css/cards.css">
<link rel="stylesheet" href="../../assets/css/tables.css">
<style>
.profile-overview-grid {
  display: grid;
  grid-template-columns: repeat(2, minmax(0, 1fr));
  gap: 12px;
}

.profile-overview-item {
  border: 1px solid rgba(255, 255, 255, 0.12);
  border-radius: var(--sc-radius-md);
  background: rgba(255, 255, 255, 0.02);
  padding: 10px 12px;
}

.profile-overview-label {
  color: var(--sc-text-soft);
  font-size: 12px;
}

.profile-overview-value {
  margin-top: 4px;
  font-size: 14px;
  font-weight: 600;
}

.vitals-grid {
  display: grid;
  grid-template-columns: repeat(2, minmax(0, 1fr));
  gap: 12px;
  margin-bottom: 14px;
}

.vital {
  border: 1px solid var(--sc-border);
  border-radius: var(--sc-radius-md);
  background: rgba(255, 255, 255, 0.03);
  padding: 12px;
}

.vital-label {
  color: var(--sc-text-soft);
  font-size: 12px;
}

.vital-value {
  margin-top: 4px;
  font-size: 26px;
  font-weight: 800;
}

.risk-badge {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 4px 10px;
  border: 1px solid var(--sc-border);
  border-radius: 999px;
  font-size: 12px;
}

.vitals-trend-grid {
  display: grid;
  grid-template-columns: repeat(3, minmax(0, 1fr));
  gap: 12px;
  margin-bottom: 14px;
}

.spark-card {
  border: 1px solid var(--sc-border);
  border-radius: var(--sc-radius-md);
  background: rgba(255, 255, 255, 0.03);
  padding: 10px;
}

.spark-head {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 6px;
}

.spark-title {
  font-size: 12px;
  color: var(--sc-text-soft);
}

.spark-value {
  font-size: 13px;
  font-weight: 700;
}

.spark-svg {
  width: 100%;
  height: 78px;
  display: block;
}

.spark-meta {
  margin-top: 6px;
  color: var(--sc-text-soft);
  font-size: 11px;
}

#med-adherence-stats {
  display: grid;
  grid-template-columns: repeat(2, minmax(0, 1fr));
  gap: 12px;
  margin-bottom: 14px;
}

#alerts-list {
  margin-bottom: 12px;
}

.toast {
  position: fixed;
  left: 16px;
  bottom: 16px;
  background: var(--sc-surface-strong);
  border: 1px solid var(--sc-border);
  color: var(--sc-text);
  border-radius: var(--sc-radius-md);
  padding: 10px 12px;
  font-size: 12px;
  display: none;
  z-index: 40;
}

@media (max-width: 780px) {
  .profile-overview-grid,
  .vitals-grid,
  .vitals-trend-grid,
  #med-adherence-stats {
    grid-template-columns: 1fr;
  }
}
</style>
</head>
<body class="sc-page">
<div class="sc-shell">
  <header class="sc-page-header">
    <div class="sc-page-header-main">
      <div class="sc-page-icon" id="avatar-letter">ط</div>
      <div>
        <h1 class="sc-page-title" id="student-name">الملف الصحي للطالب</h1>
        <p class="sc-page-subtitle">الوصول حسب الصلاحية: <span data-session-role>الطالب</span></p>
      </div>
    </div>
    <div class="sc-header-actions">
      <span class="sc-role-chip">Health Passport</span>
      <button class="sc-action-btn" onclick="goRoleHome()">العودة</button>
    </div>
  </header>

  <section class="section-nav sc-section-nav">
    <button class="section-btn sc-action-btn" onclick="scrollProfileSection('cases')">سجل الحالات</button>
    <button class="section-btn sc-action-btn" onclick="scrollProfileSection('reports')">التقارير</button>
    <button class="section-btn sc-action-btn" onclick="scrollProfileSection('medication')">الالتزام الدوائي</button>
    <button class="section-btn sc-action-btn" onclick="scrollProfileSection('alerts')">التنبيهات والتواصل</button>
  </section>

  <section class="sc-grid-3 sc-kpi-grid sc-mb-24">
    <article class="sc-kpi-card">
      <div class="sc-kpi-label">الحالات المفتوحة</div>
      <div id="st-open" class="sc-kpi-value">0</div>
    </article>
    <article class="sc-kpi-card">
      <div class="sc-kpi-label">طلبات زيارة معلقة</div>
      <div id="st-pending" class="sc-kpi-value">0</div>
    </article>
    <article class="sc-kpi-card">
      <div class="sc-kpi-label">عدد التقارير</div>
      <div id="st-reports" class="sc-kpi-value">0</div>
    </article>
  </section>

  <section class="sc-grid-3">
    <section class="sc-panel">
      <h2 class="sc-panel-title">الملف الصحي الأساسي</h2>
      <p class="sc-panel-subtitle">مرجع الملف الصحي للبيانات والتاريخ الطبي، بينما التنفيذ اليومي يتم عبر البوابة الحية لكل دور.</p>

      <div class="profile-overview-grid sc-mb-16">
        <div class="profile-overview-item"><div class="profile-overview-label">الاسم</div><div class="profile-overview-value" id="info-name">-</div></div>
        <div class="profile-overview-item"><div class="profile-overview-label">المعرف</div><div class="profile-overview-value" id="info-id">-</div></div>
        <div class="profile-overview-item"><div class="profile-overview-label">العمر</div><div class="profile-overview-value" id="info-age">-</div></div>
        <div class="profile-overview-item"><div class="profile-overview-label">الصف</div><div class="profile-overview-value" id="info-grade">-</div></div>
        <div class="profile-overview-item"><div class="profile-overview-label">تواصل ولي الأمر</div><div class="profile-overview-value" id="info-guardian">-</div></div>
        <div class="profile-overview-item"><div class="profile-overview-label">آخر حالة</div><div class="profile-overview-value" id="info-latest-case">-</div></div>
        <div class="profile-overview-item"><div class="profile-overview-label">آخر تحديث</div><div class="profile-overview-value" id="info-updated">-</div></div>
      </div>

      <div class="inline-row">
        <button class="btn-primary" onclick="goRoleHome()">العودة إلى البوابة الحية</button>
        <button class="btn-muted" data-permission="view.case" onclick="openLinkedCase()">تفاصيل الحالة</button>
        <button class="btn-muted" id="profile-telemed-btn" onclick="handleProfileTelemed()">الجلسة المرئية</button>
        <button class="btn-muted" data-permission="export.report" onclick="exportProfileReport()">تصدير تقرير</button>
      </div>
    </section>

    <section class="sc-panel sc-col-span-2">
      <h2 class="sc-panel-title">العلامات الحيوية والحساسات</h2>
      <p class="sc-panel-subtitle">لوحة موحدة لقراءات الحيوية، حالة الخطورة، والحساسات المرتبطة.</p>

      <div class="inline-row" style="justify-content:space-between;align-items:center;margin-bottom:12px;">
        <span id="vt-risk" class="risk-badge unknown">غير متوفر</span>
        <span class="sc-muted">آخر تحديث: <span id="vt-updated">-</span></span>
      </div>

      <div class="vitals-grid">
        <div class="vital"><div class="vital-label">الحرارة</div><div class="vital-value" id="vt-temp">-</div></div>
        <div class="vital"><div class="vital-label">الأكسجين SpO2</div><div class="vital-value" id="vt-spo2">-</div></div>
        <div class="vital"><div class="vital-label">نبض القلب</div><div class="vital-value" id="vt-hr">-</div></div>
        <div class="vital"><div class="vital-label">الضغط</div><div class="vital-value" id="vt-bp">-</div></div>
      </div>

      <div class="inline-row sc-mb-16">
        <button class="btn-primary" data-permission="update.vitals" onclick="generateVitalsReading()">توليد قراءة حساسات</button>
        <button class="btn-muted" onclick="loadProfile()">تحديث القراءات</button>
      </div>

      <h3 class="sc-panel-title">الحساسات المرتبطة</h3>
      <div id="sensors-list" class="list sc-mb-16"></div>

      <h3 class="sc-panel-title">المقارنة الزمنية للعلامات الحيوية</h3>
      <div id="vitals-trend-grid" class="vitals-trend-grid sc-mb-16"></div>

      <h3 class="sc-panel-title">آخر القراءات</h3>
      <div id="vitals-history-list" class="list"></div>
    </section>

    <section class="sc-panel sc-col-span-3" id="cases">
      <h2 class="sc-panel-title">سجل الحالات</h2>
      <p class="sc-panel-subtitle">جميع الحالات المرتبطة بالطالب حسب الصلاحية.</p>
      <div class="sc-table-wrap">
        <table class="sc-table">
          <thead>
            <tr>
              <th>عنوان الحالة</th>
              <th>الخطورة</th>
              <th>الحالة</th>
              <th>آخر تحديث</th>
            </tr>
          </thead>
          <tbody id="cases-table-body">
            <tr><td colspan="4" class="sc-table-empty">لا توجد حالات مسجلة.</td></tr>
          </tbody>
        </table>
      </div>
    </section>

    <section class="sc-panel" id="reports">
      <h2 class="sc-panel-title">التقارير الصحية</h2>
      <p class="sc-panel-subtitle">تقارير قابلة للعرض والتصدير.</p>
      <div class="sc-table-wrap">
        <table class="sc-table">
          <thead>
            <tr>
              <th>اسم التقرير</th>
              <th>التاريخ</th>
              <th>إجراء</th>
            </tr>
          </thead>
          <tbody id="reports-table-body">
            <tr><td colspan="3" class="sc-table-empty">لا توجد تقارير متاحة.</td></tr>
          </tbody>
        </table>
      </div>
    </section>

    <section class="sc-panel sc-col-span-2" id="medication">
      <h2 class="sc-panel-title">الالتزام الدوائي الأسبوعي</h2>
      <p class="sc-panel-subtitle">قياس الجرعات المنفذة والتنبيه قبل انخفاض الالتزام.</p>
      <div id="med-adherence-stats" class="stats"></div>
      <div class="inline-row sc-mb-16">
        <select id="med-plan-select"></select>
        <button class="btn-primary" onclick="logMedicationFromProfile('taken')">تم أخذ الجرعة</button>
        <button class="btn-muted" onclick="logMedicationFromProfile('skipped')">تم تجاوز الجرعة</button>
      </div>
      <div class="inline-row sc-mb-16" data-permission="prescribe.medication">
        <button class="btn-primary" onclick="createMedicationPlanFromProfile()">إضافة خطة دوائية</button>
      </div>
      <div id="med-recent-logs" class="list"></div>
    </section>

    <section class="sc-panel sc-col-span-3" id="alerts">
      <h2 class="sc-panel-title">التنبيهات والتواصل</h2>
      <p class="sc-panel-subtitle">تنبيهاتك الصحية مع قناة تواصل مباشرة.</p>
      <div id="alerts-list" class="list"></div>
      <textarea id="msg-box" rows="3" data-permission="send.message" placeholder="اكتب رسالتك للعيادة..."></textarea>
      <div class="inline-row" style="margin-top:12px;">
        <button class="btn-primary" data-permission="send.message" onclick="sendMessage()">إرسال الرسالة</button>
        <button class="btn-muted" onclick="loadProfile()">تحديث</button>
      </div>
    </section>
  </section>
</div>

<div id="toast" class="toast"></div>

<script src="../../assets/js/security.js?v=20260214c"></script>
<script src="../../assets/js/ui-shell.js?v=20260214c"></script>
<script>
var latestData = null;
var latestTelemedSessionId = '';
var profileStudentId = '';
var linkedCaseId = '';
var medPlansCache = [];

function qs(name) {
  var params = new URLSearchParams(window.location.search || '');
  return params.get(name);
}

function notify(text) {
  var el = document.getElementById('toast');
  el.textContent = text;
  el.style.display = 'block';
  window.setTimeout(function () { el.style.display = 'none'; }, 2200);
}

function fmtDate(value) {
  if (!value) return '-';
  return new Date(value).toLocaleString('ar-SA');
}

function fmtNum(value, digits, suffix) {
  var n = Number(value);
  if (!isFinite(n)) return '-';
  var fixed = typeof digits === 'number' ? n.toFixed(digits) : String(Math.round(n));
  return suffix ? (fixed + suffix) : fixed;
}

function escapeHtml(value) {
  return String(value || '')
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&#039;');
}

function roleAllowsStudentScope(role) {
  return role === 'doctor' || role === 'admin';
}

function getScopedStudentId() {
  var session = SmartClinicSecurity.getSession() || {};
  var requested = String(qs('studentId') || '').trim();
  if (requested && roleAllowsStudentScope(session.role)) {
    return requested;
  }
  return '';
}

function buildStudentScopeQuery() {
  var session = SmartClinicSecurity.getSession() || {};
  var scoped = profileStudentId || getScopedStudentId();
  if (!scoped || !roleAllowsStudentScope(session.role)) {
    return '';
  }
  return '?studentId=' + encodeURIComponent(scoped);
}

function downloadTextFile(filename, text) {
  var blob = new Blob([String(text || '')], { type: 'text/plain;charset=utf-8' });
  var url = URL.createObjectURL(blob);
  var link = document.createElement('a');
  link.href = url;
  link.download = filename;
  document.body.appendChild(link);
  link.click();
  link.remove();
  URL.revokeObjectURL(url);
}

function riskLabel(risk) {
  var map = {
    stable: 'مستقرة',
    warning: 'تحتاج متابعة',
    critical: 'حرجة',
    unknown: 'غير متوفر'
  };
  return map[risk] || map.unknown;
}

function severityTone(value) {
  var level = String(value || '').toLowerCase();
  if (level === 'critical' || level === 'حرجة') return 'sc-severity-critical';
  if (level === 'medium' || level === 'moderate' || level === 'warning' || level === 'متوسطة') return 'sc-severity-medium';
  if (level === 'low' || level === 'stable' || level === 'منخفضة' || level === 'مستقرة') return 'sc-severity-low';
  return '';
}

function renderCasesTable(items) {
  var tbody = document.getElementById('cases-table-body');
  if (!items || !items.length) {
    tbody.innerHTML = '<tr><td colspan="4" class="sc-table-empty">لا توجد حالات مسجلة.</td></tr>';
    return;
  }
  tbody.innerHTML = items.map(function (c) {
    var tone = severityTone(c.severity);
    return '<tr>' +
      '<td>' + escapeHtml(c.title || 'حالة') + '</td>' +
      '<td><span class="sc-badge ' + tone + '">' + escapeHtml(c.severity || '-') + '</span></td>' +
      '<td>' + escapeHtml(c.status || '-') + '</td>' +
      '<td>' + escapeHtml(fmtDate(c.updatedAt)) + '</td>' +
    '</tr>';
  }).join('');
}

function renderReportsTable(items) {
  var tbody = document.getElementById('reports-table-body');
  if (!items || !items.length) {
    tbody.innerHTML = '<tr><td colspan="3" class="sc-table-empty">لا توجد تقارير متاحة.</td></tr>';
    return;
  }
  tbody.innerHTML = items.map(function (r) {
    var id = String((r && r.id) || '');
    var action = id
      ? ('<button class="btn-muted" type="button" onclick="exportProfileReport(\'' + escapeHtml(id) + '\')">تصدير</button>')
      : '-';
    return '<tr>' +
      '<td>' + escapeHtml(r.title || 'تقرير') + '</td>' +
      '<td>' + escapeHtml(fmtDate(r.createdAt)) + '</td>' +
      '<td>' + action + '</td>' +
    '</tr>';
  }).join('');
}

function renderList(id, items, emptyText, mapper) {
  var wrap = document.getElementById(id);
  if (!items || !items.length) {
    wrap.innerHTML = '<div class="item">' + emptyText + '</div>';
    return;
  }
  wrap.innerHTML = items.map(mapper).join('');
}

function scrollProfileSection(id) {
  var target = document.getElementById(id);
  if (target) {
    target.scrollIntoView({ behavior: 'smooth', block: 'start' });
  }
}

function asPoints(history, key) {
  if (!Array.isArray(history)) return [];
  return history.map(function (item) {
    return {
      at: item && item.measuredAt ? String(item.measuredAt) : '',
      value: Number(item && item[key])
    };
  }).filter(function (item) {
    return Number.isFinite(item.value);
  }).sort(function (a, b) {
    return new Date(a.at).getTime() - new Date(b.at).getTime();
  });
}

function trendCardHtml(label, color, points, suffix, decimals) {
  if (!points.length) {
    return '<div class="spark-card"><div class="spark-head"><div class="spark-title">' + label + '</div><div class="spark-value">-</div></div><div class="spark-meta">لا توجد بيانات كافية للرسم.</div></div>';
  }

  var recent = points.slice(-12);
  var values = recent.map(function (p) { return p.value; });
  var minVal = Math.min.apply(Math, values);
  var maxVal = Math.max.apply(Math, values);
  var range = (maxVal - minVal) || 1;
  var width = 280;
  var height = 78;
  var padX = 8;
  var padY = 8;
  var xSpan = width - (padX * 2);
  var ySpan = height - (padY * 2);

  var polyline = recent.map(function (point, index) {
    var x = recent.length === 1 ? (width / 2) : (padX + ((index / (recent.length - 1)) * xSpan));
    var y = padY + (1 - ((point.value - minVal) / range)) * ySpan;
    return x.toFixed(2) + ',' + y.toFixed(2);
  }).join(' ');

  var latestPoint = recent[recent.length - 1];
  var latestValue = typeof decimals === 'number' ? latestPoint.value.toFixed(decimals) : String(Math.round(latestPoint.value));
  var from = fmtDate(recent[0].at);
  var to = fmtDate(latestPoint.at);
  var viewBox = '0 0 ' + width + ' ' + height;

  return '<div class="spark-card">' +
    '<div class="spark-head"><div class="spark-title">' + label + '</div><div class="spark-value">' + latestValue + suffix + '</div></div>' +
    '<svg class="spark-svg" viewBox="' + viewBox + '" preserveAspectRatio="none">' +
      '<polyline points="' + polyline + '" fill="none" stroke="' + color + '" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"></polyline>' +
    '</svg>' +
    '<div class="spark-meta">من ' + from + ' إلى ' + to + '</div>' +
  '</div>';
}

function renderVitalsTrend(history, latest) {
  var wrap = document.getElementById('vitals-trend-grid');
  var source = Array.isArray(history) ? history.slice() : [];
  if (latest && latest.measuredAt) {
    source.push({
      measuredAt: latest.measuredAt,
      temp: latest.temp,
      spo2: latest.spo2,
      hr: latest.hr
    });
  }

  var tempPoints = asPoints(source, 'temp');
  var spo2Points = asPoints(source, 'spo2');
  var hrPoints = asPoints(source, 'hr');

  wrap.innerHTML = [
    trendCardHtml('درجة الحرارة', '#ff7875', tempPoints, '°C', 1),
    trendCardHtml('الأكسجين SpO2', '#69c0ff', spo2Points, '%', 0),
    trendCardHtml('نبض القلب', '#95de64', hrPoints, ' bpm', 0)
  ].join('');
}

function renderVitals(data) {
  var latest = data && data.latestVitals ? data.latestVitals : null;
  var risk = latest ? (latest.risk || 'unknown') : 'unknown';
  var riskEl = document.getElementById('vt-risk');
  riskEl.className = 'risk-badge ' + risk;
  riskEl.textContent = 'الحالة: ' + riskLabel(risk);
  document.getElementById('vt-updated').textContent = latest ? fmtDate(latest.measuredAt) : '-';
  document.getElementById('vt-temp').textContent = latest ? fmtNum(latest.temp, 1, '°C') : '-';
  document.getElementById('vt-spo2').textContent = latest ? fmtNum(latest.spo2, 0, '%') : '-';
  document.getElementById('vt-hr').textContent = latest ? fmtNum(latest.hr, 0, ' bpm') : '-';
  document.getElementById('vt-bp').textContent = latest ? (fmtNum(latest.bpSys, 0) + '/' + fmtNum(latest.bpDia, 0) + ' mmHg') : '-';

  renderList('sensors-list', data && data.sensors, 'لا توجد حساسات مربوطة.', function (s) {
    var battery = fmtNum(s.battery, 0, '%');
    return '<div class="item"><div class="item-title">' + (s.label || s.type || 'حساس') + '</div><div class="item-meta">الحالة: ' + (s.status || 'unknown') + ' • البطارية: ' + battery + ' • آخر تواصل: ' + fmtDate(s.lastSeenAt) + '</div></div>';
  });

  renderList('vitals-history-list', data && data.vitalsHistory, 'لا توجد قراءات مسجلة بعد.', function (v) {
    var line = fmtNum(v.temp, 1, '°C') + ' • ' + fmtNum(v.spo2, 0, '%') + ' • ' + fmtNum(v.hr, 0, ' bpm') + ' • ' + fmtNum(v.bpSys, 0) + '/' + fmtNum(v.bpDia, 0);
    return '<div class="item"><div class="item-title">' + line + '</div><div class="item-meta">' + fmtDate(v.measuredAt) + ' • المصدر: ' + (v.source || 'manual') + ' • الحالة: ' + riskLabel(v.risk || 'unknown') + '</div></div>';
  });

  renderVitalsTrend((data && data.vitalsHistory) || [], latest);
}

function renderProfile(data) {
  latestData = data || {};
  var student = latestData.student || {};
  var snapshot = latestData.snapshot || {};
  var latestCase = latestData.latestCase || null;
  linkedCaseId = String(qs('caseId') || (latestCase && latestCase.id) || '').trim();
  profileStudentId = student.id || getScopedStudentId() || 'u_student_1';

  var name = student.name || 'طالب';
  document.getElementById('student-name').textContent = name;
  document.getElementById('avatar-letter').textContent = name.charAt(0);
  document.getElementById('info-name').textContent = name;
  document.getElementById('info-id').textContent = student.id || '-';
  document.getElementById('info-age').textContent = student.age ? (student.age + ' سنة') : '-';
  document.getElementById('info-grade').textContent = student.grade || '-';
  document.getElementById('info-guardian').textContent = student.guardianPhone || '-';
  document.getElementById('info-latest-case').textContent = latestCase ? (latestCase.title + ' (' + latestCase.severity + ')') : 'لا توجد حالة';
  document.getElementById('info-updated').textContent = latestCase ? fmtDate(latestCase.updatedAt) : '-';

  document.getElementById('st-open').textContent = Number(snapshot.openCases || 0);
  document.getElementById('st-pending').textContent = Number(snapshot.pendingVisits || 0);
  document.getElementById('st-reports').textContent = Number(snapshot.reports || 0);

  renderCasesTable(latestData.cases || []);
  renderReportsTable(latestData.reports || []);

  renderList('alerts-list', latestData.alerts, 'لا توجد تنبيهات جديدة.', function (a) {
    return '<div class="item"><div class="item-title">' + (a.text || 'تنبيه') + '</div><div class="item-meta">' + fmtDate(a.createdAt) + '</div></div>';
  });

  renderVitals(latestData);
}

function openLinkedCase() {
  var session = SmartClinicSecurity.getSession() || {};
  if (session.role !== 'doctor' && session.role !== 'admin') {
    var target = document.getElementById('cases');
    if (target) target.scrollIntoView({ behavior: 'smooth', block: 'start' });
    return;
  }
  if (!linkedCaseId && latestData && Array.isArray(latestData.cases) && latestData.cases.length) {
    linkedCaseId = latestData.cases[0].id || '';
  }
  if (!linkedCaseId) {
    notify('لا توجد حالة مرتبطة لفتحها الآن.');
    return;
  }
  window.location.href = 'case-details.html?id=' + encodeURIComponent(linkedCaseId);
}

async function refreshProfileTelemed() {
  var session = SmartClinicSecurity.getSession() || {};
  var role = session.role || 'student';
  var query = {
    role: role,
    caseId: linkedCaseId || undefined,
    includeEnded: false
  };
  var current = await SmartClinicSecurity.getLatestTelemedSession(query);
  latestTelemedSessionId = current && current.id ? current.id : '';

  var btn = document.getElementById('profile-telemed-btn');
  if (!btn) return;
  if (role === 'doctor' || role === 'admin') {
    btn.disabled = false;
    btn.textContent = latestTelemedSessionId ? 'فتح الجلسة المرئية' : 'بدء جلسة مرئية';
    return;
  }
  btn.disabled = !latestTelemedSessionId;
  btn.textContent = latestTelemedSessionId ? 'الانضمام للجلسة المرئية' : 'لا توجد جلسة مرئية';
}

async function handleProfileTelemed() {
  var session = SmartClinicSecurity.getSession() || {};
  var role = session.role || 'student';
  if (role === 'doctor' || role === 'admin') {
    if (latestTelemedSessionId) {
      window.location.href = SmartClinicSecurity.getTelemedRoomPath(latestTelemedSessionId);
      return;
    }
    var caseId = linkedCaseId || ((latestData && latestData.latestCase && latestData.latestCase.id) || '');
    if (!caseId) {
      notify('لا توجد حالة نشطة لبدء الجلسة.');
      return;
    }
    var allowGuardian = window.confirm('هل تريد السماح لولي الأمر بالانضمام لهذه الجلسة؟');
    var create = await SmartClinicSecurity.createTelemedSession({
      caseId: caseId,
      studentId: profileStudentId || 'u_student_1',
      allowGuardian: allowGuardian,
      title: 'جلسة مرئية من الملف الصحي للحالة ' + caseId
    });
    if (!create.ok || !create.item) {
      notify(create.error || 'تعذر بدء الجلسة المرئية.');
      return;
    }
    latestTelemedSessionId = create.item.id;
    window.location.href = SmartClinicSecurity.getTelemedRoomPath(create.item.id);
    return;
  }

  if (!latestTelemedSessionId) {
    await refreshProfileTelemed();
    notify('لا توجد جلسة مرئية متاحة حاليًا.');
    return;
  }
  var inviteRole = role === 'parent' ? 'parent' : 'student';
  var invite = await SmartClinicSecurity.createTelemedInvite(latestTelemedSessionId, inviteRole);
  if (!invite.ok || !invite.item || !invite.item.token) {
    notify(invite.error || 'تعذر تجهيز رابط انضمام آمن.');
    return;
  }
  window.location.href = SmartClinicSecurity.getTelemedRoomPath(latestTelemedSessionId, invite.item.token);
}

async function exportProfileReport(reportId) {
  var reqBody = reportId ? { reportId: reportId } : {};
  var exportResult = await SmartClinicSecurity.apiJson('/reports/export', {
    method: 'POST',
    body: JSON.stringify(reqBody)
  });
  if (!exportResult.ok || !exportResult.data) {
    notify(exportResult.error || 'تعذر تصدير التقرير.');
    return;
  }
  var student = (latestData && latestData.student) || {};
  var snapshot = (latestData && latestData.snapshot) || {};
  var latestCase = (latestData && latestData.latestCase) || {};
  var latestVitals = (latestData && latestData.latestVitals) || {};
  var fileBase = String((exportResult.data.filename || 'student-report').replace(/\.pdf$/i, ''));
  var body = [
    'Smart Clinic Student Profile Export',
    'Generated At: ' + new Date().toISOString(),
    'Student: ' + (student.name || '-'),
    'Student ID: ' + (student.id || profileStudentId || '-'),
    'Grade: ' + (student.grade || '-'),
    '--- Snapshot ---',
    'Open Cases: ' + Number(snapshot.openCases || 0),
    'Pending Visits: ' + Number(snapshot.pendingVisits || 0),
    'Reports: ' + Number(snapshot.reports || 0),
    'Alerts: ' + Number(snapshot.alerts || 0),
    '--- Latest Case ---',
    (latestCase.title || '-') + ' | ' + (latestCase.severity || '-') + ' | ' + fmtDate(latestCase.updatedAt),
    '--- Latest Vitals ---',
    'Temp: ' + fmtNum(latestVitals.temp, 1, '°C'),
    'SpO2: ' + fmtNum(latestVitals.spo2, 0, '%'),
    'HR: ' + fmtNum(latestVitals.hr, 0, ' bpm'),
    'BP: ' + fmtNum(latestVitals.bpSys, 0) + '/' + fmtNum(latestVitals.bpDia, 0),
    'Risk: ' + riskLabel(latestVitals.risk || 'unknown')
  ].join('\n');
  downloadTextFile(fileBase + '-snapshot.txt', body);
  notify(exportResult.data.message || 'تم تجهيز التقرير للتنزيل.');
}

function renderMedicationAdherence(data) {
  var summary = data || {};
  medPlansCache = Array.isArray(summary.plans) ? summary.plans.slice() : [];
  var adherence = Number(summary.adherencePercent || 0);
  var warnClass = adherence < 80 ? ' warn' : '';
  document.getElementById('med-adherence-stats').innerHTML = [
    ['نسبة الالتزام', adherence + '%', warnClass],
    ['الجرعات المتوقعة', Number(summary.expectedDoses || 0), ''],
    ['الجرعات المنفذة', Number(summary.takenDoses || 0), ''],
    ['الجرعات المتجاوزة', Number(summary.skippedDoses || 0), '']
  ].map(function (item) {
    return '<div class="stat"><div class="stat-label">' + item[0] + '</div><div class="stat-value' + item[2] + '">' + item[1] + '</div></div>';
  }).join('');

  var select = document.getElementById('med-plan-select');
  if (!medPlansCache.length) {
    select.innerHTML = '<option value="">لا توجد خطط دوائية نشطة</option>';
  } else {
    select.innerHTML = medPlansCache.map(function (plan) {
      return '<option value="' + escapeHtml(plan.id) + '">' + escapeHtml(plan.name || plan.id) + ' • ' + Number(plan.dosesPerDay || 1) + ' جرعات/يوم</option>';
    }).join('');
  }

  renderList('med-recent-logs', summary.recentLogs, 'لا توجد سجلات جرعات حتى الآن.', function (entry) {
    var state = entry.status === 'taken' ? 'تم أخذ الجرعة' : 'تم تجاوز الجرعة';
    return '<div class="item"><div class="item-title">' + escapeHtml(entry.planName || 'خطة دوائية') + ' • ' + state + '</div><div class="item-meta">' + fmtDate(entry.takenAt || entry.createdAt) + '</div></div>';
  });
}

async function loadMedicationAdherence() {
  var result = await SmartClinicSecurity.apiJson('/medications/adherence' + buildStudentScopeQuery());
  if (!result.ok || !result.data) {
    renderList('med-recent-logs', [], 'تعذر تحميل بيانات الالتزام الدوائي.', function () { return ''; });
    document.getElementById('med-adherence-stats').innerHTML = '<div class="stat"><div class="stat-label">الالتزام</div><div class="stat-value">-</div></div>';
    document.getElementById('med-plan-select').innerHTML = '<option value="">غير متوفر</option>';
    return;
  }
  renderMedicationAdherence(result.data);
}

async function logMedicationFromProfile(status) {
  var desired = status === 'skipped' ? 'skipped' : 'taken';
  var select = document.getElementById('med-plan-select');
  var planId = select ? String(select.value || '') : '';
  if (!planId && !profileStudentId) {
    notify('لا توجد خطة دوائية قابلة للتحديث.');
    return;
  }
  var payload = {
    status: desired,
    note: 'تحديث من صفحة الملف الصحي'
  };
  if (planId) {
    payload.planId = planId;
  } else {
    payload.studentId = profileStudentId;
  }
  var result = await SmartClinicSecurity.apiJson('/medications/logs', {
    method: 'POST',
    body: JSON.stringify(payload)
  });
  if (!result.ok) {
    notify(result.error || 'تعذر تحديث سجل الجرعات.');
    return;
  }
  notify(desired === 'taken' ? 'تم تسجيل الجرعة كمأخوذة.' : 'تم تسجيل الجرعة كتجاوز.');
  loadMedicationAdherence();
}

async function createMedicationPlanFromProfile() {
  var name = window.prompt('اسم الدواء:', 'Paracetamol 500mg');
  if (name === null) return;
  name = String(name || '').trim();
  if (!name) {
    notify('اسم الدواء مطلوب.');
    return;
  }
  var dosesRaw = window.prompt('عدد الجرعات اليومية (1-8):', '2');
  if (dosesRaw === null) return;
  var doses = Number(dosesRaw);
  if (!Number.isFinite(doses) || doses < 1 || doses > 8) {
    notify('عدد الجرعات يجب أن يكون بين 1 و 8.');
    return;
  }
  var instructions = window.prompt('تعليمات الاستخدام:', 'بعد الأكل لمدة 5 أيام') || '';
  var result = await SmartClinicSecurity.apiJson('/medications/plans', {
    method: 'POST',
    body: JSON.stringify({
      studentId: profileStudentId || getScopedStudentId() || 'u_student_1',
      name: name,
      dosesPerDay: Math.round(doses),
      instructions: String(instructions).trim()
    })
  });
  if (!result.ok) {
    notify(result.error || 'تعذر إنشاء الخطة الدوائية.');
    return;
  }
  notify('تم إنشاء خطة دوائية جديدة.');
  loadMedicationAdherence();
}

async function loadProfile() {
  try {
    var query = getScopedStudentId();
    var endpoint = '/student/overview' + (query ? ('?studentId=' + encodeURIComponent(query)) : '');
    var response = await SmartClinicSecurity.apiRequest(endpoint);
    var payload = await response.json();
    if (!response.ok) {
      notify(payload.error || 'تعذر تحميل الملف الصحي.');
      return;
    }
    renderProfile(payload);
    await loadMedicationAdherence();
    await refreshProfileTelemed();
  } catch (err) {
    notify('تعذر الاتصال بالخادم.');
  }
}

async function sendMessage() {
  var text = document.getElementById('msg-box').value.trim();
  if (!text) {
    notify('اكتب رسالة أولًا.');
    return;
  }
  try {
    var response = await SmartClinicSecurity.apiRequest('/messages', {
      method: 'POST',
      body: JSON.stringify({ text: text })
    });
    var payload = await response.json();
    if (!response.ok) {
      notify(payload.error || 'تعذر إرسال الرسالة.');
      return;
    }
    document.getElementById('msg-box').value = '';
    notify('تم إرسال الرسالة للفريق الصحي.');
  } catch (err) {
    notify('تعذر الاتصال بالخادم.');
  }
}

async function generateVitalsReading() {
  try {
    var studentId = profileStudentId || getScopedStudentId() || 'u_student_1';
    var response = await SmartClinicSecurity.apiRequest('/vitals/generate', {
      method: 'POST',
      body: JSON.stringify({ studentId: studentId, profile: 'normal' })
    });
    var payload = await response.json();
    if (!response.ok) {
      notify(payload.error || 'تعذر توليد القراءة.');
      return;
    }
    notify('تم توليد قراءة حساسات جديدة.');
    loadProfile();
  } catch (err) {
    notify('تعذر الاتصال بالخادم.');
  }
}

function goRoleHome() {
  var session = SmartClinicSecurity.getSession();
  if (!session) {
    window.location.href = '../../index.html';
    return;
  }
  var map = {
    student: 'student-portal.html',
    doctor: 'doctor.html',
    parent: 'parent-portal.html',
    admin: 'admin-dashboard.html'
  };
  window.location.href = map[session.role] || '../../index.html';
}

window.addEventListener('DOMContentLoaded', function () {
  var auth = SmartClinicSecurity.requireAccess(['student', 'doctor', 'parent', 'admin'], 'ملف الطالب');
  if (window.SmartClinicUI) {
    var links = [
      { label: 'الملف الصحي', href: 'student-profile.html' },
      { label: 'بوابة الطالب', href: 'student-portal.html', roles: ['student', 'admin'] },
      { label: 'لوحة الطبيب', href: 'doctor.html', roles: ['doctor', 'admin'] },
      { label: 'بوابة ولي الأمر', href: 'parent-portal.html', roles: ['parent', 'admin'] },
      { label: 'مركز التنسيق', href: 'care-center.html', roles: ['doctor', 'parent', 'admin'] },
      { label: 'الإشعارات', href: 'notifications-center.html' }
    ];
    if (auth && (auth.role === 'doctor' || auth.role === 'admin')) {
      links.push({ label: 'تفاصيل الحالة', href: linkedCaseId ? ('case-details.html?id=' + encodeURIComponent(linkedCaseId)) : 'case-details.html?id=case_1' });
    }
    SmartClinicUI.mountQuickNav({
      afterSelector: '.sc-page-header',
      onRefresh: loadProfile,
      links: links,
      hideShellActions: true
    });
  }
  if (window.location.hash) {
    var targetId = String(window.location.hash || '').replace('#', '').trim();
    if (targetId) {
      window.setTimeout(function () { scrollProfileSection(targetId); }, 120);
    }
  }
  SmartClinicSecurity.createAutoRefresh(loadProfile, 20000, { immediate: true });
});
</script>
</body>
</html>
