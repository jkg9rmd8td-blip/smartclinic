<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Dashboard ØªØ­Ù„ÙŠÙ„ÙŠ â€“ Smart Clinic</title>
<link rel="stylesheet" href="../../assets/css/variables.css">
<link rel="stylesheet" href="../../assets/css/layout.css">
<link rel="stylesheet" href="../../assets/css/cards.css">
<link rel="stylesheet" href="../../assets/css/tables.css">
<style>
.analytics-hero {
  margin-bottom: var(--sc-space-5);
}

.analytics-panel .sc-table-wrap + .sc-panel-title {
  margin-top: 18px;
}

.school-health-overview .sc-kpi-value {
  font-size: 30px;
}
</style>
</head>
<body class="sc-page">
<div class="sc-shell">
  <header class="sc-page-header">
    <div class="sc-page-header-main">
      <div class="sc-page-icon">ğŸ“Š</div>
      <div>
        <h1 class="sc-page-title">Ø§Ù„ØªØ­Ù„ÙŠÙ„Ø§Øª Ø§Ù„Ø­ÙŠØ© Ù„Ù„Ù…Ù†ØµØ©</h1>
        <p class="sc-page-subtitle">Ù‚Ø±Ø§Ø¡Ø© Ù…Ø¨Ø§Ø´Ø±Ø© Ù…Ù† API Ù„Ù„Ø­Ø§Ù„Ø§ØªØŒ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†ØŒ Ø§Ù„Ø·Ù„Ø¨Ø§ØªØŒ ÙˆØ§Ù„Ø£Ù†Ø´Ø·Ø© Ø§Ù„ØªØ´ØºÙŠÙ„ÙŠØ©.</p>
      </div>
    </div>
    <div class="sc-header-actions">
      <span class="sc-role-chip">ØªØ­Ø¯ÙŠØ« ØªÙ„Ù‚Ø§Ø¦ÙŠ ÙƒÙ„ 15 Ø«Ø§Ù†ÙŠØ©</span>
      <button class="sc-action-btn" onclick="window.location.href='admin-dashboard.html'">Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</button>
      <button class="sc-action-btn" data-action="logout">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
    </div>
  </header>

  <section class="sc-panel analytics-hero">
    <h2 class="sc-panel-title">Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø­ØµØ§Ø¡ Ø§Ù„ØªØ´ØºÙŠÙ„ÙŠ</h2>
    <p class="sc-panel-subtitle">Ù…Ø¤Ø´Ø±Ø§Øª KPI Ù…ÙˆØ­Ø¯Ø© + Ø¬Ø¯Ø§ÙˆÙ„ ØªØ´ØºÙŠÙ„ÙŠØ© Ø¨Ù†ÙØ³ Ø§Ù„ØªÙ†Ø³ÙŠÙ‚ Ø¹Ø¨Ø± Ø§Ù„ØµÙØ­Ø§Øª Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠØ© ÙˆØ§Ù„Ø·Ø¨ÙŠØ©.</p>
  </section>

  <section id="snapshot" class="sc-grid-3 sc-kpi-grid sc-mb-24"></section>

  <section class="sc-panel sc-mb-24">
    <h2 class="sc-panel-title">Ù…Ø¤Ø´Ø± ØµØ­Ø© Ø§Ù„Ù…Ø¯Ø±Ø³Ø© (School Health Index)</h2>
    <p class="sc-panel-subtitle">Ù…Ø¤Ø´Ø± Ù…ÙˆØ­Ù‘Ø¯ Ù„ÙƒÙ„ Ù…Ø¯Ø±Ø³Ø© ÙŠØ´Ù…Ù„: Ø§Ù„Ø­Ø§Ù„Ø§ØªØŒ Ø§Ù„ØºÙŠØ§Ø¨ØŒ Ø§Ù„Ø§Ù„ØªØ²Ø§Ù… Ø§Ù„Ø¯ÙˆØ§Ø¦ÙŠØŒ Ø§Ù„Ø­ÙˆØ§Ø¯Ø«ØŒ ÙˆØ§Ù„Ø£Ù…Ø±Ø§Ø¶ Ø§Ù„Ù…ÙˆØ³Ù…ÙŠØ©.</p>
    <section id="schoolHealthSummary" class="sc-grid-3 sc-kpi-grid school-health-overview sc-mb-24"></section>
    <div class="sc-table-wrap">
      <table class="sc-table">
        <thead>
          <tr>
            <th>Ø§Ù„ØªØ±ØªÙŠØ¨</th>
            <th>Ø§Ù„Ù…Ø¯Ø±Ø³Ø©</th>
            <th>Ø§Ù„Ù…Ø¤Ø´Ø±</th>
            <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
            <th>Ø§Ù„Ø­Ø§Ù„Ø§Øª</th>
            <th>Ø§Ù„ØºÙŠØ§Ø¨</th>
            <th>Ø§Ù„Ø§Ù„ØªØ²Ø§Ù… Ø§Ù„Ø¯ÙˆØ§Ø¦ÙŠ</th>
            <th>Ø§Ù„Ø­ÙˆØ§Ø¯Ø«</th>
            <th>Ø§Ù„Ù…ÙˆØ³Ù…ÙŠØ©</th>
            <th>ØªÙˆØµÙŠØ© Ø£ÙˆÙ„ÙŠØ©</th>
          </tr>
        </thead>
        <tbody id="schoolHealthRows"></tbody>
      </table>
    </div>
  </section>

  <section class="sc-grid-3">
    <section class="sc-panel analytics-panel">
      <h2 class="sc-panel-title">ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø­Ø§Ù„Ø§Øª</h2>
      <div class="sc-table-wrap">
        <table class="sc-table">
          <thead>
            <tr>
              <th>Ø§Ù„ØªØµÙ†ÙŠÙ</th>
              <th>Ø§Ù„Ù‚ÙŠÙ…Ø©</th>
            </tr>
          </thead>
          <tbody id="statusDist"></tbody>
        </table>
      </div>
    </section>

    <section class="sc-panel analytics-panel">
      <h2 class="sc-panel-title">ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø®Ø·ÙˆØ±Ø©</h2>
      <div class="sc-table-wrap">
        <table class="sc-table">
          <thead>
            <tr>
              <th>Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø®Ø·ÙˆØ±Ø©</th>
              <th>Ø§Ù„Ù‚ÙŠÙ…Ø©</th>
            </tr>
          </thead>
          <tbody id="severityDist"></tbody>
        </table>
      </div>
    </section>

    <section class="sc-panel analytics-panel">
      <h2 class="sc-panel-title">ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø£Ø¯ÙˆØ§Ø±</h2>
      <div class="sc-table-wrap">
        <table class="sc-table">
          <thead>
            <tr>
              <th>Ø§Ù„Ø¯ÙˆØ±</th>
              <th>Ø§Ù„Ù‚ÙŠÙ…Ø©</th>
            </tr>
          </thead>
          <tbody id="rolesDist"></tbody>
        </table>
      </div>

      <h3 class="sc-panel-title">Ù†Ø´Ø§Ø· Ø§Ù„ÙŠÙˆÙ…</h3>
      <div class="sc-table-wrap">
        <table class="sc-table">
          <thead>
            <tr>
              <th>Ø§Ù„Ù…Ø¤Ø´Ø±</th>
              <th>Ø§Ù„Ù‚ÙŠÙ…Ø©</th>
            </tr>
          </thead>
          <tbody id="todayDist"></tbody>
        </table>
      </div>
    </section>

    <section class="sc-panel sc-col-span-3 analytics-panel">
      <h2 class="sc-panel-title">Ø¢Ø®Ø± Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</h2>
      <div class="sc-table-wrap">
        <table class="sc-table">
          <thead>
            <tr>
              <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡</th>
              <th>Ø§Ù„Ù…Ø³ØªÙ‡Ø¯Ù</th>
              <th>Ø§Ù„Ø¯ÙˆØ±</th>
              <th>Ø§Ù„ÙˆÙ‚Øª</th>
            </tr>
          </thead>
          <tbody id="recentLogs"></tbody>
        </table>
      </div>
    </section>
  </section>
</div>

<script src="../../assets/js/security.js?v=20260214c"></script>
<script>
function safeNum(v) { return typeof v === 'number' ? v : 0; }
function escapeHtml(v) {
  return String(v || '')
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&#039;');
}

function severityBadgeClass(key) {
  var normalized = String(key || '').toLowerCase();
  if (normalized.indexOf('critical') !== -1 || normalized.indexOf('Ø­Ø±Ø¬') !== -1) return 'sc-severity-critical';
  if (normalized.indexOf('medium') !== -1 || normalized.indexOf('warning') !== -1 || normalized.indexOf('Ù…ØªÙˆØ³Ø·') !== -1) return 'sc-severity-medium';
  if (normalized.indexOf('low') !== -1 || normalized.indexOf('stable') !== -1 || normalized.indexOf('Ù…Ù†Ø®ÙØ¶') !== -1) return 'sc-severity-low';
  return '';
}

function valueBadgeClass(value) {
  if (value >= 3) return 'b-danger';
  if (value >= 1) return 'b-warn';
  return 'b-ok';
}

function schoolIndexClass(score) {
  var n = Number(score || 0);
  if (n < 55) return 'sc-severity-critical';
  if (n < 70) return 'sc-severity-medium';
  return 'sc-severity-low';
}

function renderSnapshot(s) {
  var items = [
    ['Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†', safeNum(s.totalUsers)],
    ['Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙˆÙ† Ø§Ù„Ù†Ø´Ø·ÙˆÙ†', safeNum(s.activeUsers)],
    ['Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø­Ø§Ù„Ø§Øª', safeNum(s.totalCases)],
    ['Ø­Ø§Ù„Ø§Øª Ø­Ø±Ø¬Ø©', safeNum(s.criticalCases)],
    ['Ø·Ù„Ø¨Ø§Øª Ø²ÙŠØ§Ø±Ø© Ù…Ø¹Ù„Ù‚Ø©', safeNum(s.pendingVisitRequests)],
    ['ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ù…ÙØªÙˆØ­Ø©', safeNum(s.openAlerts)]
  ];
  document.getElementById('snapshot').innerHTML = items.map(function (it) {
    return '<article class="sc-kpi-card"><div class="sc-kpi-label">' + it[0] + '</div><div class="sc-kpi-value">' + it[1] + '</div></article>';
  }).join('');
}

function renderDist(id, obj) {
  var body = document.getElementById(id);
  var keys = Object.keys(obj || {});
  if (!keys.length) {
    body.innerHTML = '<tr><td colspan="2" class="sc-table-empty">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</td></tr>';
    return;
  }
  body.innerHTML = keys.map(function (k) {
    var val = safeNum(obj[k]);
    var cls = id === 'severityDist' ? severityBadgeClass(k) : valueBadgeClass(val);
    return '<tr><td>' + k + '</td><td><span class="sc-badge ' + cls + '">' + val + '</span></td></tr>';
  }).join('');
}

function renderRecent(logs) {
  var body = document.getElementById('recentLogs');
  if (!logs || !logs.length) {
    body.innerHTML = '<tr><td colspan="4" class="sc-table-empty">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù…Ù„ÙŠØ§Øª Ù…Ø³Ø¬Ù„Ø©.</td></tr>';
    return;
  }
  body.innerHTML = logs.map(function (l) {
    var when = l.createdAt ? new Date(l.createdAt).toLocaleString('ar-SA') : '-';
    return '<tr>' +
      '<td><strong>' + (l.action || '-') + '</strong></td>' +
      '<td>' + (l.target || '-') + '</td>' +
      '<td>' + (l.actorRole || '-') + '</td>' +
      '<td>' + when + '</td>' +
    '</tr>';
  }).join('');
}

function renderSchoolHealth(payload) {
  var summaryWrap = document.getElementById('schoolHealthSummary');
  var rowsWrap = document.getElementById('schoolHealthRows');
  if (!payload || !payload.summary) {
    summaryWrap.innerHTML = '<article class="sc-kpi-card"><div class="sc-kpi-label">Ø§Ù„Ù…Ø¤Ø´Ø±</div><div class="sc-kpi-value">ØºÙŠØ± Ù…ØªØ§Ø­</div></article>';
    rowsWrap.innerHTML = '<tr><td colspan="10" class="sc-table-empty">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø¤Ø´Ø± Ø§Ù„Ù…Ø¯Ø§Ø±Ø³.</td></tr>';
    return;
  }

  var summary = payload.summary || {};
  var cards = [
    ['Ù…ØªÙˆØ³Ø· Ø§Ù„Ù…Ø¤Ø´Ø± Ø§Ù„Ø¹Ø§Ù…', safeNum(summary.averageIndex)],
    ['Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¯Ø§Ø±Ø³', safeNum(summary.schools)],
    ['Ù…Ø¯Ø§Ø±Ø³ ØªØ­ØªØ§Ø¬ Ø¯Ø¹Ù…', safeNum(summary.supportNeeded)],
    ['Ù…Ø¯Ø§Ø±Ø³ Ø¯Ø¹Ù… Ø¹Ø§Ø¬Ù„', safeNum(summary.criticalSupport)],
    ['Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø·Ù„Ø§Ø¨', safeNum(summary.students)],
    ['Ù†Ø§ÙØ°Ø© Ø§Ù„Ù‚ÙŠØ§Ø³ (ÙŠÙˆÙ…)', safeNum(payload.windowDays)]
  ];
  summaryWrap.innerHTML = cards.map(function (item) {
    return '<article class="sc-kpi-card"><div class="sc-kpi-label">' + item[0] + '</div><div class="sc-kpi-value">' + item[1] + '</div></article>';
  }).join('');

  var schools = Array.isArray(payload.schools) ? payload.schools : [];
  if (!schools.length) {
    rowsWrap.innerHTML = '<tr><td colspan="10" class="sc-table-empty">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¯Ø§Ø±Ø³ Ù…Ø³Ø¬Ù„Ø©.</td></tr>';
    return;
  }

  rowsWrap.innerHTML = schools.map(function (school) {
    var metrics = school.metrics || {};
    var rec = Array.isArray(school.recommendations) && school.recommendations.length ? school.recommendations[0] : '-';
    return '<tr>' +
      '<td>' + safeNum(school.rank) + '</td>' +
      '<td><strong>' + escapeHtml(school.name || school.id || '-') + '</strong></td>' +
      '<td><span class="sc-badge ' + schoolIndexClass(school.index) + '">' + safeNum(school.index) + '</span></td>' +
      '<td>' + escapeHtml(school.status || '-') + '</td>' +
      '<td>' + safeNum(metrics.openCases) + ' / ' + safeNum(metrics.criticalCases) + '</td>' +
      '<td>' + safeNum(metrics.absenceRate) + '%</td>' +
      '<td>' + safeNum(metrics.medicationAdherence) + '%</td>' +
      '<td>' + safeNum(metrics.incidents) + '</td>' +
      '<td>' + safeNum(metrics.seasonalCases) + '</td>' +
      '<td>' + escapeHtml(rec) + '</td>' +
    '</tr>';
  }).join('');
}

async function loadAnalytics() {
  var responses = await Promise.all([
    SmartClinicSecurity.apiJson('/analytics/overview'),
    SmartClinicSecurity.apiJson('/school-health-index')
  ]);
  var result = responses[0];
  var schoolResult = responses[1];

  if (!result.ok || !result.data) {
    document.getElementById('snapshot').innerHTML = '<article class="sc-kpi-card"><div class="sc-kpi-label">Ø®Ø·Ø£</div><div class="sc-kpi-value">Ø§Ù„Ø®Ø§Ø¯Ù… ØºÙŠØ± Ù…ØªØ§Ø­</div></article>';
    renderDist('statusDist', {});
    renderDist('severityDist', {});
    renderDist('rolesDist', {});
    renderDist('todayDist', {});
    renderRecent([]);
    renderSchoolHealth(null);
    return;
  }
  var payload = result.data;
  renderSnapshot(payload.snapshot || {});
  renderDist('statusDist', payload.distributions && payload.distributions.statusCounts);
  renderDist('severityDist', payload.distributions && payload.distributions.severityCounts);
  renderDist('rolesDist', payload.distributions && payload.distributions.roleCounts);
  renderDist('todayDist', payload.today || {});
  renderRecent(payload.recentLogs || []);
  renderSchoolHealth(schoolResult && schoolResult.ok ? schoolResult.data : null);
}

window.addEventListener('DOMContentLoaded', function () {
  SmartClinicSecurity.requireAccess(['doctor', 'admin'], 'Dashboard Ø§Ù„ØªØ­Ù„ÙŠÙ„Ø§Øª');
  SmartClinicSecurity.createAutoRefresh(loadAnalytics, 15000, { immediate: true });
});
</script>
</body>
</html>
