<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø­Ø§Ù„Ø© â€“ Smart Clinic</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="../../assets/css/variables.css">
<link rel="stylesheet" href="../../assets/css/layout.css">
<link rel="stylesheet" href="../../assets/css/cards.css">
<link rel="stylesheet" href="../../assets/css/tables.css">
<style>
.case-pill-dot {
  width: 8px;
  height: 8px;
  border-radius: 999px;
  background: var(--sc-low);
  box-shadow: 0 0 0 4px rgba(82, 196, 26, 0.25);
}

.case-kpi-grid .sc-kpi-value {
  font-size: 28px;
}

.case-actions-panel textarea {
  min-height: 140px;
}

.case-actions-panel .actions-row {
  margin-top: 12px;
}

.toast {
  position: fixed;
  left: 16px;
  bottom: 16px;
  background: var(--sc-surface-strong);
  border: 1px solid var(--sc-border);
  color: var(--sc-text);
  border-radius: var(--sc-radius-md);
  font-size: 12px;
  padding: 10px 12px;
  display: none;
  z-index: 50;
}
</style>
</head>
<body class="sc-page">
<div class="sc-shell">
  <header class="sc-page-header">
    <div class="sc-page-header-main">
      <div class="sc-page-icon">ğŸ©º</div>
      <div>
        <h1 class="sc-page-title" id="case-title">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø­Ø§Ù„Ø©</h1>
        <p class="sc-page-subtitle" id="case-sub">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„Ø©...</p>
      </div>
    </div>
    <div class="sc-header-actions">
      <span class="sc-badge"><span class="case-pill-dot"></span><span id="case-status">Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©</span></span>
      <button class="btn-ghost" onclick="copyCaseId()">Ù†Ø³Ø® Ø±Ù‚Ù… Ø§Ù„Ø­Ø§Ù„Ø©</button>
      <button class="btn-ghost" onclick="goRoleHome()">Ø§Ù„Ø¹ÙˆØ¯Ø©</button>
    </div>
  </header>

  <section class="sc-grid-3 sc-kpi-grid case-kpi-grid sc-mb-24">
    <article class="sc-kpi-card">
      <div class="sc-kpi-label">Ù…Ø¹Ø±Ù Ø§Ù„Ø­Ø§Ù„Ø©</div>
      <div class="sc-kpi-value" id="case-id-pill">-</div>
    </article>
    <article class="sc-kpi-card">
      <div class="sc-kpi-label">Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨</div>
      <div class="sc-kpi-value" id="student-name">-</div>
    </article>
    <article class="sc-kpi-card">
      <div class="sc-kpi-label">Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø®Ø·ÙˆØ±Ø©</div>
      <div class="sc-kpi-value" id="case-severity">-</div>
    </article>
    <article class="sc-kpi-card">
      <div class="sc-kpi-label">Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø­Ø§Ù„Ø©</div>
      <div class="sc-kpi-value" id="case-topic">-</div>
    </article>
    <article class="sc-kpi-card">
      <div class="sc-kpi-label">Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«</div>
      <div class="sc-kpi-value" id="case-updated">-</div>
    </article>
  </section>

  <section class="sc-grid-3">
    <section class="sc-panel case-actions-panel">
      <h2 class="sc-panel-title">Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ø¹Ù„Ø§Ø¬ÙŠØ©</h2>
      <p class="sc-panel-subtitle">ØªÙ†ÙÙŠØ° Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ù…ØµØ±Ø­ Ø¨Ù‡Ø§ ÙˆØªÙˆØ«ÙŠÙ‚Ù‡Ø§ Ù…Ø¨Ø§Ø´Ø±Ø© ÙÙŠ Ø³Ø¬Ù„ Ø§Ù„ØªØ¯Ù‚ÙŠÙ‚.</p>

      <div class="sc-panel-subtitle">Ø§Ù„Ø®Ø·Ø© Ø§Ù„Ø¹Ù„Ø§Ø¬ÙŠØ© Ø§Ù„Ø­Ø§Ù„ÙŠØ©</div>
      <textarea id="plan-box" data-permission="edit.careplan" placeholder="Ø§ÙƒØªØ¨ Ø§Ù„Ø®Ø·Ø© Ø§Ù„Ø¹Ù„Ø§Ø¬ÙŠØ© Ø§Ù„Ù…Ø­Ø¯Ø«Ø©..."></textarea>

      <div class="actions-row">
        <button class="action-btn primary" data-permission="edit.careplan" onclick="savePlan()">Ø­ÙØ¸ Ø§Ù„Ø®Ø·Ø©</button>
        <button class="action-btn" data-permission="update.vitals" onclick="recordCaseAction('vitals_update', 'ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ù„Ø§Ù…Ø§Øª Ø§Ù„Ø­ÙŠÙˆÙŠØ©')">ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ù„Ø§Ù…Ø§Øª Ø§Ù„Ø­ÙŠÙˆÙŠØ©</button>
        <button class="action-btn" data-permission="contact.guardian" onclick="recordCaseAction('contact_guardian', 'ØªÙ… Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹ ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±')">Ø§ØªØµØ§Ù„ Ø¨ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±</button>
        <button class="action-btn danger" data-permission="approve.referral" onclick="recordCaseAction('external_referral', 'ØªÙ… Ø§Ø¹ØªÙ…Ø§Ø¯ ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø­Ø§Ù„Ø© Ù„Ù„Ø·ÙˆØ§Ø±Ø¦ Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠØ©')">ØªØ­ÙˆÙŠÙ„ Ø®Ø§Ø±Ø¬ÙŠ</button>
        <button class="action-btn" data-permission="close.case" onclick="recordCaseAction('close_case', 'ØªÙ… Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø­Ø§Ù„Ø© ÙˆØªÙˆØ«ÙŠÙ‚ Ø§Ù„Ù‚Ø±Ø§Ø±')">Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø­Ø§Ù„Ø©</button>
      </div>
      <div class="small-muted">ÙŠØªÙ… Ø­ÙØ¸ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª ÙÙŠ Ø³Ø¬Ù„ Ø§Ù„ØªØ¯Ù‚ÙŠÙ‚ ÙˆØ±Ø¨Ø·Ù‡Ø§ Ø¨Ù…Ø¹Ø±Ù Ø§Ù„Ø­Ø§Ù„Ø©.</div>
    </section>

    <section class="sc-panel sc-col-span-2">
      <h2 class="sc-panel-title">Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ø²Ù…Ù†ÙŠ Ù„Ù„Ø­Ø§Ù„Ø©</h2>
      <p class="sc-panel-subtitle">ÙØµÙ„ ÙˆØ§Ø¶Ø­ Ø¨ÙŠÙ† Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„ØªÙ†ÙÙŠØ° ÙˆØ§Ù„Ø³Ø¬Ù„ Ø§Ù„Ø²Ù…Ù†ÙŠ Ø§Ù„Ù…ÙˆØ«Ù‚.</p>
      <div class="sc-table-wrap">
        <table class="sc-table">
          <thead>
            <tr>
              <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡</th>
              <th>Ø§Ù„ØªÙØ§ØµÙŠÙ„</th>
              <th>Ø§Ù„ÙˆÙ‚Øª</th>
            </tr>
          </thead>
          <tbody id="timeline"></tbody>
        </table>
      </div>
      <div class="actions-row" style="margin-top:12px;">
        <button class="action-btn" onclick="window.location.href='emergency-flow.html?id=' + encodeURIComponent(currentCaseId)">ÙØªØ­ Ù…Ø³Ø§Ø± Ø§Ù„Ø·ÙˆØ§Ø±Ø¦</button>
        <button class="action-btn" onclick="openStudentProfile()">ÙØªØ­ Ù…Ù„Ù Ø§Ù„Ø·Ø§Ù„Ø¨</button>
      </div>
    </section>
  </section>
</div>

<div id="toast" class="toast"></div>

<script src="../../assets/js/security.js"></script>
<script>
var currentCaseId = 'case_1';
var currentStudentId = '';

function qs(name) {
  var params = new URLSearchParams(window.location.search);
  return params.get(name);
}

function normalizeCaseId(raw) {
  if (!raw) return 'case_1';
  if (/^case_/.test(raw)) return raw;
  if (/^\d+$/.test(raw)) return 'case_' + raw;
  return raw;
}

function severityTone(value) {
  var level = String(value || '').toLowerCase();
  if (level.indexOf('critical') !== -1 || level.indexOf('Ø­Ø±Ø¬') !== -1) return 'sc-severity-critical';
  if (level.indexOf('medium') !== -1 || level.indexOf('warning') !== -1 || level.indexOf('Ù…ØªÙˆØ³Ø·') !== -1) return 'sc-severity-medium';
  if (level.indexOf('low') !== -1 || level.indexOf('stable') !== -1 || level.indexOf('Ù…Ù†Ø®ÙØ¶') !== -1) return 'sc-severity-low';
  return '';
}

function notify(text) {
  var el = document.getElementById('toast');
  el.textContent = text;
  el.style.display = 'block';
  window.setTimeout(function () {
    el.style.display = 'none';
  }, 2200);
}

function renderTimeline(items) {
  var wrap = document.getElementById('timeline');
  if (!items || !items.length) {
    wrap.innerHTML = '<tr><td colspan="3" class="sc-table-empty">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø­Ø¯Ø§Ø« Ù…Ø³Ø¬Ù„Ø© Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†.</td></tr>';
    return;
  }
  wrap.innerHTML = items.map(function (entry) {
    var when = entry.createdAt ? new Date(entry.createdAt).toLocaleString('ar-SA') : '-';
    var details = entry.details && entry.details.note ? entry.details.note : 'Ø¨Ø¯ÙˆÙ† ØªÙØ§ØµÙŠÙ„';
    return '<tr><td><strong>' + entry.action + '</strong></td><td>' + details + '</td><td>' + when + '</td></tr>';
  }).join('');
}

function renderCase(item, timeline) {
  currentStudentId = item.studentId || '';
  document.getElementById('case-title').textContent = 'ÙØªØ­ Ø§Ù„Ø­Ø§Ù„Ø© - ' + (item.studentName || '-');
  document.getElementById('case-sub').textContent = (item.title || '-') + ' â€¢ ØµÙ„Ø§Ø­ÙŠØ©: ' + (SmartClinicSecurity.getSession() || {}).role;
  document.getElementById('case-status').textContent = item.status || '-';
  document.getElementById('case-id-pill').textContent = item.id || '-';
  document.getElementById('student-name').textContent = item.studentName || '-';
  document.getElementById('case-topic').textContent = item.title || '-';
  var severityEl = document.getElementById('case-severity');
  severityEl.textContent = item.severity || '-';
  severityEl.className = 'sc-kpi-value ' + severityTone(item.severity);
  document.getElementById('case-updated').textContent = item.updatedAt ? new Date(item.updatedAt).toLocaleString('ar-SA') : '-';
  document.getElementById('plan-box').value = item.notes || '';
  renderTimeline(timeline || []);
}

function openStudentProfile() {
  var path = 'student-profile.html';
  if (currentStudentId) {
    path += '?studentId=' + encodeURIComponent(currentStudentId) + '&caseId=' + encodeURIComponent(currentCaseId);
  }
  window.location.href = path;
}

function copyCaseId() {
  if (!currentCaseId) {
    notify('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø±Ù‚Ù… Ø­Ø§Ù„Ø© Ù…ØªØ§Ø­.');
    return;
  }
  if (!navigator.clipboard || typeof navigator.clipboard.writeText !== 'function') {
    notify('Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ù…Ø¨Ø§Ø´Ø±.');
    return;
  }
  navigator.clipboard.writeText(currentCaseId).then(function () {
    notify('ØªÙ… Ù†Ø³Ø® Ø±Ù‚Ù… Ø§Ù„Ø­Ø§Ù„Ø©: ' + currentCaseId);
  }).catch(function () {
    notify('ØªØ¹Ø°Ø± Ù†Ø³Ø® Ø±Ù‚Ù… Ø§Ù„Ø­Ø§Ù„Ø©.');
  });
}

async function loadCase() {
  try {
    var response = await SmartClinicSecurity.apiRequest('/cases/' + encodeURIComponent(currentCaseId));
    var payload = await response.json();
    if (!response.ok) {
      notify(payload.error || 'ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø­Ø§Ù„Ø©');
      return;
    }
    renderCase(payload.item || {}, payload.timeline || []);
  } catch (err) {
    notify('ØªØ¹Ø°Ø± Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù….');
  }
}

async function savePlan() {
  var plan = document.getElementById('plan-box').value.trim();
  try {
    var response = await SmartClinicSecurity.apiRequest('/cases/' + encodeURIComponent(currentCaseId), {
      method: 'PATCH',
      body: JSON.stringify({ notes: plan })
    });
    var payload = await response.json();
    if (!response.ok) {
      notify(payload.error || 'ØªØ¹Ø°Ø± Ø­ÙØ¸ Ø§Ù„Ø®Ø·Ø©');
      return;
    }
    await recordCaseAction('careplan_save', 'ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø®Ø·Ø© Ø§Ù„Ø¹Ù„Ø§Ø¬ÙŠØ©', { plan: plan }, true);
    notify('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø®Ø·Ø© Ø¨Ù†Ø¬Ø§Ø­');
  } catch (err) {
    notify('ØªØ¹Ø°Ø± Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù….');
  }
}

async function recordCaseAction(type, note, extra, silent) {
  try {
    var body = Object.assign({ type: type, note: note }, extra || {});
    var response = await SmartClinicSecurity.apiRequest('/cases/' + encodeURIComponent(currentCaseId) + '/actions', {
      method: 'POST',
      body: JSON.stringify(body)
    });
    var payload = await response.json();
    if (!response.ok) {
      notify(payload.error || 'ØªØ¹Ø°Ø± ØªÙ†ÙÙŠØ° Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡.');
      return;
    }
    if (!silent) {
      notify(note);
    }
    loadCase();
  } catch (err) {
    notify('ØªØ¹Ø°Ø± Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù….');
  }
}

function goRoleHome() {
  var session = SmartClinicSecurity.getSession();
  if (session && session.role === 'admin') {
    window.location.href = 'admin-dashboard.html';
    return;
  }
  window.location.href = 'doctor.html';
}

window.addEventListener('DOMContentLoaded', function () {
  SmartClinicSecurity.requireAccess(['doctor', 'admin'], 'ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø­Ø§Ù„Ø©');
  currentCaseId = normalizeCaseId(qs('id'));
  loadCase();
});
</script>
</body>
</html>
