<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Ù…Ø±ÙƒØ² Ø§Ù„Ø·ÙˆØ§Ø±Ø¦ â€“ Smart Clinic</title>
<link rel="stylesheet" href="../../assets/css/variables.css">
<link rel="stylesheet" href="../../assets/css/layout.css">
<link rel="stylesheet" href="../../assets/css/cards.css">
<link rel="stylesheet" href="../../assets/css/tables.css">
<style>
.em-header {
  border: 1px solid rgba(255, 120, 117, 0.45);
  background: linear-gradient(145deg, rgba(127, 29, 29, 0.5), rgba(22, 24, 29, 0.78));
}

.em-role-chip {
  border-color: rgba(255, 120, 117, 0.45);
  color: #ffd6d1;
}

.em-state {
  border: 1px solid rgba(255, 120, 117, 0.35);
  border-radius: var(--sc-radius-md);
  background: rgba(127, 29, 29, 0.2);
  padding: 10px 12px;
  margin-bottom: 12px;
}

.em-state strong {
  color: #ffd6d1;
}

.em-state-line {
  margin-top: 6px;
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
  align-items: center;
}

.em-pulse {
  width: 9px;
  height: 9px;
  border-radius: 50%;
  background: #ff4d4f;
  box-shadow: 0 0 0 0 rgba(255, 77, 79, 0.45);
  animation: emPulse 1.6s infinite;
}

@keyframes emPulse {
  0% {
    box-shadow: 0 0 0 0 rgba(255, 77, 79, 0.5);
  }
  70% {
    box-shadow: 0 0 0 10px rgba(255, 77, 79, 0);
  }
  100% {
    box-shadow: 0 0 0 0 rgba(255, 77, 79, 0);
  }
}

.case-row-active td {
  background: rgba(255, 77, 79, 0.1);
}

.case-actions {
  display: flex;
  gap: 6px;
  flex-wrap: wrap;
}

.mini-btn {
  border: 1px solid var(--sc-border);
  border-radius: 999px;
  background: rgba(255, 255, 255, 0.04);
  color: var(--sc-text);
  font-size: 12px;
  padding: 5px 10px;
  cursor: pointer;
}

.mini-btn:hover {
  background: rgba(255, 255, 255, 0.1);
}

.action-grid {
  display: grid;
  grid-template-columns: repeat(2, minmax(0, 1fr));
  gap: 8px;
}

.action-grid .btn-primary,
.action-grid .btn-muted {
  width: 100%;
}

.queue-list,
.alert-list {
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.queue-item,
.alert-item {
  border: 1px solid rgba(255, 255, 255, 0.14);
  border-radius: var(--sc-radius-md);
  background: rgba(255, 255, 255, 0.03);
  padding: 10px;
}

.queue-item strong,
.alert-item strong {
  display: block;
  margin-bottom: 4px;
}

.toast {
  position: fixed;
  left: 16px;
  bottom: 16px;
  background: var(--sc-surface-strong);
  border: 1px solid var(--sc-border);
  color: var(--sc-text);
  border-radius: var(--sc-radius-md);
  padding: 10px 12px;
  font-size: 12px;
  display: none;
  z-index: 40;
}

@media (max-width: 780px) {
  .action-grid {
    grid-template-columns: 1fr;
  }
}
</style>
</head>
<body class="sc-page">
<div class="sc-shell">
  <header class="sc-page-header em-header">
    <div class="sc-page-header-main">
      <div class="sc-page-icon">ğŸš¨</div>
      <div>
        <h1 class="sc-page-title">Ù…Ø±ÙƒØ² Ø§Ù„Ø·ÙˆØ§Ø±Ø¦</h1>
        <p class="sc-page-subtitle">Ù„ÙˆØ­Ø© Ù…ÙŠØ¯Ø§Ù†ÙŠØ© Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø­Ø§Ù„Ø§Øª Ø§Ù„Ø­Ø±Ø¬Ø© ÙˆØªÙ†ÙÙŠØ° Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ø§Ù„Ø³Ø±ÙŠØ¹Ø©.</p>
      </div>
    </div>
    <div class="sc-header-actions">
      <span class="sc-role-chip em-role-chip">Ø§Ù„Ø¯ÙˆØ± Ø§Ù„Ø­Ø§Ù„ÙŠ: <strong data-session-role>Ø§Ù„Ø·ÙˆØ§Ø±Ø¦</strong></span>
      <button class="sc-action-btn" data-action="logout">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
    </div>
  </header>

  <section class="em-state">
    <strong id="em-state-title">Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„ØªØ´ØºÙŠÙ„ÙŠØ©: Ø¬Ø§Ù‡Ø²ÙŠØ© Ø¹Ø§Ù„ÙŠØ©</strong>
    <div class="em-state-line">
      <span class="em-pulse"></span>
      <span class="sc-muted">Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«: <span id="em-last-sync">-</span></span>
      <span class="sc-muted">Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©: <span id="em-selected-case">Ù„Ø§ ÙŠÙˆØ¬Ø¯</span></span>
    </div>
  </section>

  <section class="sc-grid-3 sc-kpi-grid sc-mb-24">
    <article class="sc-kpi-card">
      <div class="sc-kpi-label">Ø­Ø§Ù„Ø§Øª Ø­Ø±Ø¬Ø©</div>
      <div id="kpi-critical" class="sc-kpi-value">0</div>
    </article>
    <article class="sc-kpi-card">
      <div class="sc-kpi-label">Ø­Ø§Ù„Ø§Øª Ù…ÙØªÙˆØ­Ø©</div>
      <div id="kpi-open" class="sc-kpi-value">0</div>
    </article>
    <article class="sc-kpi-card">
      <div class="sc-kpi-label">Ø·Ù„Ø¨Ø§Øª Ø²ÙŠØ§Ø±Ø© Ù…Ø¹Ù„Ù‘Ù‚Ø©</div>
      <div id="kpi-pending" class="sc-kpi-value">0</div>
    </article>
  </section>

  <section class="sc-grid-3">
    <section class="sc-panel sc-col-span-2">
      <h2 class="sc-panel-title">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø­Ø§Ù„Ø§Øª Ø§Ù„Ø¹Ø§Ø¬Ù„Ø©</h2>
      <p class="sc-panel-subtitle">Ø§Ø®ØªØ± Ø­Ø§Ù„Ø© Ù„ØªÙØ¹ÙŠÙ„ Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ø·ÙˆØ§Ø±Ø¦ Ø£Ùˆ ÙØªØ­ Ù…Ø³Ø§Ø±Ù‡Ø§ Ø§Ù„ØªÙØµÙŠÙ„ÙŠ.</p>
      <div class="sc-table-wrap">
        <table class="sc-table">
          <thead>
            <tr>
              <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
              <th>Ø§Ù„Ø®Ø·ÙˆØ±Ø©</th>
              <th>Ø§Ù„ÙˆØ¶Ø¹</th>
              <th>Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«</th>
              <th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
            </tr>
          </thead>
          <tbody id="em-cases-body">
            <tr><td colspan="5" class="sc-table-empty">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø­Ø§Ù„Ø§Øª...</td></tr>
          </tbody>
        </table>
      </div>
    </section>

    <section class="sc-panel">
      <h2 class="sc-panel-title">ØªÙˆØ¬ÙŠÙ‡ Ø³Ø±ÙŠØ¹</h2>
      <p class="sc-panel-subtitle">Ù‚Ø±Ø§Ø±Ø§Øª Ø£ÙˆÙ„ÙŠØ© ÙÙ‚Ø·. Ø§Ù„ØªÙ†ÙÙŠØ° Ø§Ù„ØªÙØµÙŠÙ„ÙŠ Ø¯Ø§Ø®Ù„ Ù…Ø³Ø§Ø± Ø§Ù„Ø·ÙˆØ§Ø±Ø¦.</p>
      <div class="action-grid">
        <button class="btn-primary" data-permission="edit.careplan" onclick="runEmergencyAction('emergency_protocol', 'ØªÙ… ØªÙØ¹ÙŠÙ„ Ø¨Ø±ÙˆØªÙˆÙƒÙˆÙ„ Ø§Ù„Ø·ÙˆØ§Ø±Ø¦ Ø§Ù„ÙƒØ§Ù…Ù„')">ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¨Ø±ÙˆØªÙˆÙƒÙˆÙ„</button>
        <button class="btn-primary" data-permission="approve.referral" onclick="runEmergencyAction('ambulance_dispatch', 'ØªÙ… Ø·Ù„Ø¨ Ø¥Ø³Ø¹Ø§Ù ÙˆØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø­Ø§Ù„Ø© Ù„Ù„Ø·ÙˆØ§Ø±Ø¦ Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠØ©')">Ø·Ù„Ø¨ Ø¥Ø³Ø¹Ø§Ù</button>
      </div>
      <div class="inline-row sc-mb-16" style="margin-top:12px;">
        <button class="btn-primary" onclick="openEmergencyFlow()">ÙØªØ­ Ù…Ø³Ø§Ø± Ø§Ù„Ø·ÙˆØ§Ø±Ø¦</button>
        <button class="btn-muted" onclick="loadEmergencyDashboard()">ØªØ­Ø¯ÙŠØ«</button>
      </div>
      <div class="inline-help">Ø¨Ø¹Ø¯ Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ Ø§Ù„Ø£ÙˆÙ„ÙŠØŒ Ø£ÙƒÙ…Ù„ Ø§Ù„ØªÙ†ÙÙŠØ° Ø§Ù„ØªÙØµÙŠÙ„ÙŠ Ù…Ù† ØµÙØ­Ø© Ø§Ù„Ù…Ø³Ø§Ø±.</div>
    </section>

    <section class="sc-panel">
      <h2 class="sc-panel-title">Ø§Ù„Ø¨Ù„Ø§ØºØ§Øª Ø§Ù„Ù…Ø¹Ù„Ù‚Ø©</h2>
      <p class="sc-panel-subtitle">Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø²ÙŠØ§Ø±Ø© Ø§Ù„Ø­Ø¯ÙŠØ«Ø© Ù„ÙØ±Ø² Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ©.</p>
      <div id="em-visit-queue" class="queue-list"></div>
    </section>

    <section class="sc-panel sc-col-span-2">
      <h2 class="sc-panel-title">Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø§Ù„Ø¹Ø§Ø¬Ù„Ø©</h2>
      <p class="sc-panel-subtitle">Ø¢Ø®Ø± Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø§Ù„ØªØ´ØºÙŠÙ„ÙŠØ© ÙˆØ§Ù„Ø­Ø±Ø¬Ø© Ø§Ù„Ù…ÙˆØ¬Ù‡Ø© Ù„ÙØ±ÙŠÙ‚ Ø§Ù„Ø·ÙˆØ§Ø±Ø¦.</p>
      <div id="em-alerts-list" class="alert-list"></div>
    </section>
  </section>
</div>

<div id="toast" class="toast"></div>
<script src="../../assets/js/security.js?v=20260214c"></script>
<script src="../../assets/js/ui-shell.js?v=20260214c"></script>
<script>
var casesCache = [];
var selectedCaseId = '';

function notify(text) {
  var el = document.getElementById('toast');
  el.textContent = text;
  el.style.display = 'block';
  window.setTimeout(function () { el.style.display = 'none'; }, 2200);
}

function fmtDate(value) {
  if (!value) return '-';
  var dt = new Date(value);
  if (Number.isNaN(dt.getTime())) return '-';
  return dt.toLocaleString('ar-SA');
}

function escapeHtml(value) {
  return String(value || '')
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&#039;');
}

function severityTone(value) {
  var level = String(value || '').toLowerCase();
  if (level === 'critical' || level === 'Ø­Ø±Ø¬') return 'sc-severity-critical';
  if (level === 'high' || level === 'medium' || level === 'warning') return 'sc-severity-medium';
  return 'sc-severity-low';
}

function severityWeight(value) {
  var v = String(value || '').toLowerCase();
  if (v === 'critical') return 4;
  if (v === 'high') return 3;
  if (v === 'medium') return 2;
  return 1;
}

function ensureSelectedCase() {
  if (selectedCaseId && casesCache.some(function (item) { return item.id === selectedCaseId; })) return;
  selectedCaseId = casesCache.length ? String(casesCache[0].id) : '';
}

function updateSelectedMeta() {
  var selected = casesCache.find(function (item) { return item.id === selectedCaseId; }) || null;
  document.getElementById('em-selected-case').textContent = selected ? ((selected.title || 'Ø­Ø§Ù„Ø©') + ' (' + (selected.id || '-') + ')') : 'Ù„Ø§ ÙŠÙˆØ¬Ø¯';
}

function selectCase(caseId) {
  selectedCaseId = String(caseId || '');
  updateSelectedMeta();
  renderCasesTable(casesCache);
}

function renderKpis(cases, visits, alerts) {
  var critical = cases.filter(function (item) { return String(item.severity || '').toLowerCase() === 'critical'; }).length;
  var open = cases.filter(function (item) { return String(item.status || '').toLowerCase() !== 'closed'; }).length;
  var pending = visits.filter(function (item) { return String(item.status || '').toLowerCase() === 'pending'; }).length;
  var criticalAlerts = alerts.filter(function (item) { return String(item.type || '').toLowerCase() === 'critical'; }).length;
  document.getElementById('kpi-critical').textContent = String(critical);
  document.getElementById('kpi-open').textContent = String(open);
  document.getElementById('kpi-pending').textContent = String(pending);
  document.getElementById('em-state-title').textContent = critical > 0
    ? ('Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„ØªØ´ØºÙŠÙ„ÙŠØ©: Ø¥Ù†Ø°Ø§Ø± Ù…Ø±ØªÙØ¹ (' + critical + ' Ø­Ø§Ù„Ø§Øª Ø­Ø±Ø¬Ø©)')
    : ('Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„ØªØ´ØºÙŠÙ„ÙŠØ©: Ù…ØªØ§Ø¨Ø¹Ø© Ù…Ø³ØªÙ‚Ø±Ø© (' + criticalAlerts + ' ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø­Ø±Ø¬Ø©)');
}

function renderCasesTable(items) {
  var tbody = document.getElementById('em-cases-body');
  if (!items.length) {
    tbody.innerHTML = '<tr><td colspan="5" class="sc-table-empty">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø§Ù„Ø§Øª Ù…ØªØ§Ø­Ø© Ù„Ù„Ø·ÙˆØ§Ø±Ø¦.</td></tr>';
    return;
  }
  tbody.innerHTML = items.map(function (item) {
    var tone = severityTone(item.severity);
    var active = item.id === selectedCaseId ? ' class="case-row-active"' : '';
    return '<tr' + active + '>' +
      '<td>' + escapeHtml(item.title || 'Ø­Ø§Ù„Ø©') + '</td>' +
      '<td><span class="sc-badge ' + tone + '">' + escapeHtml(item.severity || '-') + '</span></td>' +
      '<td>' + escapeHtml(item.status || '-') + '</td>' +
      '<td>' + escapeHtml(fmtDate(item.updatedAt)) + '</td>' +
      '<td><div class="case-actions">' +
        '<button class="mini-btn" type="button" onclick="selectCase(\'' + escapeHtml(item.id) + '\')">ØªØ­Ø¯ÙŠØ¯</button>' +
        '<button class="mini-btn" type="button" onclick="openEmergencyFlow(\'' + escapeHtml(item.id) + '\')">ÙØªØ­ Ø§Ù„Ù…Ø³Ø§Ø±</button>' +
      '</div></td>' +
    '</tr>';
  }).join('');
}

function renderVisitQueue(items) {
  var wrap = document.getElementById('em-visit-queue');
  if (!items.length) {
    wrap.innerHTML = '<div class="queue-item">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ù…Ø¹Ù„Ù‚Ø© Ø§Ù„Ø¢Ù†.</div>';
    return;
  }
  wrap.innerHTML = items.slice(0, 6).map(function (item) {
    return '<div class="queue-item"><strong>' + escapeHtml(item.reason || 'Ø·Ù„Ø¨ Ø²ÙŠØ§Ø±Ø©') + '</strong><div class="sc-muted">' + escapeHtml(fmtDate(item.createdAt)) + '</div></div>';
  }).join('');
}

function renderAlerts(items) {
  var wrap = document.getElementById('em-alerts-list');
  if (!items.length) {
    wrap.innerHTML = '<div class="alert-item">Ù„Ø§ ØªÙˆØ¬Ø¯ ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø­Ø§Ù„ÙŠØ©.</div>';
    return;
  }
  wrap.innerHTML = items.slice(0, 8).map(function (item) {
    var tone = severityTone(item.type || 'low');
    return '<div class="alert-item"><strong>' + escapeHtml(item.text || 'ØªÙ†Ø¨ÙŠÙ‡') + '</strong>' +
      '<div class="sc-muted">' + escapeHtml(fmtDate(item.createdAt)) + '</div>' +
      '<div style="margin-top:4px;"><span class="sc-badge ' + tone + '">' + escapeHtml(item.type || 'info') + '</span></div></div>';
  }).join('');
}

async function loadEmergencyDashboard() {
  var now = new Date();
  document.getElementById('em-last-sync').textContent = now.toLocaleTimeString('ar-SA');

  var results = await Promise.all([
    SmartClinicSecurity.apiJson('/cases'),
    SmartClinicSecurity.apiJson('/visit-requests'),
    SmartClinicSecurity.apiJson('/alerts')
  ]);
  var casesResult = results[0];
  var visitsResult = results[1];
  var alertsResult = results[2];

  if (!casesResult.ok || !casesResult.data) {
    notify(casesResult.error || 'ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø­Ø§Ù„Ø§Øª Ø§Ù„Ø·ÙˆØ§Ø±Ø¦.');
    return;
  }

  var allCases = Array.isArray(casesResult.data.items) ? casesResult.data.items.slice() : [];
  var emergencyCases = allCases.filter(function (item) {
    var severity = String(item.severity || '').toLowerCase();
    var status = String(item.status || '').toLowerCase();
    return status !== 'closed' || severity === 'critical' || severity === 'high';
  }).sort(function (a, b) {
    var sev = severityWeight(b.severity) - severityWeight(a.severity);
    if (sev !== 0) return sev;
    return new Date(b.updatedAt || 0).getTime() - new Date(a.updatedAt || 0).getTime();
  });

  var visitItems = (visitsResult.ok && visitsResult.data && Array.isArray(visitsResult.data.items))
    ? visitsResult.data.items
    : [];
  var alertItems = (alertsResult.ok && alertsResult.data && Array.isArray(alertsResult.data.items))
    ? alertsResult.data.items
    : [];

  casesCache = emergencyCases;
  ensureSelectedCase();
  updateSelectedMeta();
  renderKpis(emergencyCases, visitItems, alertItems);
  renderCasesTable(emergencyCases);
  renderVisitQueue(visitItems);
  renderAlerts(alertItems);
}

function openEmergencyFlow(caseId) {
  var target = String(caseId || selectedCaseId || '');
  if (!target) {
    notify('Ø­Ø¯Ø¯ Ø­Ø§Ù„Ø© Ø£ÙˆÙ„Ù‹Ø§.');
    return;
  }
  window.location.href = 'emergency-flow.html?id=' + encodeURIComponent(target);
}

async function runEmergencyAction(type, note) {
  if (!selectedCaseId) {
    notify('Ø­Ø¯Ø¯ Ø­Ø§Ù„Ø© Ù‚Ø¨Ù„ ØªÙ†ÙÙŠØ° Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡.');
    return;
  }
  var result = await SmartClinicSecurity.apiJson('/cases/' + encodeURIComponent(selectedCaseId) + '/actions', {
    method: 'POST',
    body: JSON.stringify({ type: type, note: note })
  });
  if (!result.ok) {
    notify(result.error || 'ØªØ¹Ø°Ø± ØªÙ†ÙÙŠØ° Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡.');
    return;
  }
  notify(note);
  loadEmergencyDashboard();
}

window.addEventListener('DOMContentLoaded', function () {
  SmartClinicSecurity.requireAccess(['emergency', 'admin'], 'Ù…Ø±ÙƒØ² Ø§Ù„Ø·ÙˆØ§Ø±Ø¦');
  if (window.SmartClinicUI) {
    SmartClinicUI.mountQuickNav({
      afterSelector: '.sc-page-header',
      onRefresh: loadEmergencyDashboard,
      links: [
        { label: 'Ù…Ø±ÙƒØ² Ø§Ù„Ø·ÙˆØ§Ø±Ø¦', href: 'emergency-dashboard.html' },
        { label: 'Ù…Ø³Ø§Ø± Ø§Ù„Ø·ÙˆØ§Ø±Ø¦', href: 'emergency-flow.html?id=case_1' },
        { label: 'Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª', href: 'notifications-center.html' }
      ],
      hideShellActions: true
    });
  }
  SmartClinicSecurity.createAutoRefresh(loadEmergencyDashboard, 15000, { immediate: true });
});
</script>
</body>
</html>
